<!--
     v1.0  Qualityze Inc(GP)        28-APR-2016    Initial Version.
                                                   This page includes NC init,products and resolution steps. 
 -->
<apex:page sidebar="false" standardcontroller="Non_Conformance__c"
    extensions="NonConformance,QC_custom_settings"
    showHeader="false" standardStylesheets="false" docType="html-5.0">
    <script type="text/javascript">
      $( document ).ready(function() {
          setTimeout(show(), 1000);
      });
      
      function show(){
         $("#loading").hide();
         $("#overlay").hide();
      }
    </script>
    <div id="overlay" style="background-color: rgba(0, 0, 0, 0.15);z-index: 999;position: absolute;left: 0;top: 0;width: 100%;height: 200%;"></div>
    <div id="loading" style="height: 64px;width: 64px;align:center; position: absolute;margin: -100px 0 0 -200px;top: 80%;left: 50%;z-index:1000">
       <i class="fa fa-spinner fa-pulse fa-3x fa-fw"></i> <span class="sr-only">Loading...</span>
       
    </div>
   <div id="container">
     <apex:composition template="qualityze_app_layout">
        <apex:define name="header_bar_component">
            <!-- Begin : Header Bar With Search Option -->
            <c:header_bar ObjectType="{!$ObjectType.Non_Conformance__c}" ObjectTypeLinkTitle="Non Conformance"/>
            <!-- End : Header Bar With Search Option -->
        </apex:define>
        
        <apex:define name="theheader">
            <!-- Begin : NC Header -->
            <c:NC_Header recordid="{!Non_Conformance__c.Id}"
                rendered="{!NOT(ISBLANK(Non_Conformance__c.Id))}" />
            <!-- End : NC Header -->
        </apex:define>
        
        <apex:define name="wizsteps">
          <!-- Begin : Navigation Steps -->
           <c:wizard_steps step="{!IF($CurrentPage.parameters.pg=='nc_init',1,IF($CurrentPage.parameters.pg=='nc_products',2,IF($CurrentPage.parameters.pg=='nc_resolution',3,10)))}"
                rendered="{!NOT(ISBLANK(Non_Conformance__c.Id))}"
                requestedFieldHolder="{!Non_Conformance__c.NC_Status__c},{!Non_Conformance__c.NC_Resolution_Code__c}"
                tasks="{!tasksWithSequences}" adhocTaskDetails="{!adhocTaskDetails}"
                object="{!Non_Conformance__c}" />
         <!-- End : Navigation Steps -->
       </apex:define>
        
        <apex:define name="from-holder-title">
          <!-- Begin : Step Title -->
           <apex:outputText value="{!IF($CurrentPage.parameters.pg=='nc_init','NC Initiation',IF($CurrentPage.parameters.pg=='nc_products','NC Product Information',IF($CurrentPage.parameters.pg=='nc_resolution','NC Resolution',IF($CurrentPage.parameters.pg=='nc_reference','NC Reference',IF($CurrentPage.parameters.pg=='nc_details','NC Details','NC Initiation')))))}"/>
          <!-- End :  Step Title -->
         </apex:define>
        
        <apex:define name="theform">
         <!-- Begin : Initiation -->
         <apex:outputPanel rendered="{!OR($CurrentPage.parameters.pg=='nc_init',ISBLANK($CurrentPage.parameters.pg))}">
               <c:wiz_form submitpage="stringify_sobject" formid="ncForm" formclass="appform validate" recordid="{!Non_Conformance__c.Id}" postsavejs="window.location.href = '/apex/NonConformance?id=' + RecordId+'&pg=nc_products'">
                    <input type="hidden" name="sobj" value="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}non_conformance__c"/>
                    <input type="hidden" name="Id" value="{!Non_Conformance__c.Id}" />
                    <input type="hidden" name="page" id="page" value="nc_init" />
                    <input type="hidden" id="stepName" name="stepName" value="Initiation" />
                     
                    <apex:outputPanel layout="none" rendered="{!OR($ObjectType.Non_Conformance__c.Fields.NC_Type__c.Accessible,$ObjectType.Non_Conformance__c.Fields.Product__c.Accessible,$ObjectType.Non_Conformance__c.Fields.Process__c.Accessible,$ObjectType.Non_Conformance__c.Fields.Defect__c.Accessible,$ObjectType.Non_Conformance__c.Fields.Full_Description__c.accessible,$ObjectType.Non_Conformance__c.Fields.Occurance_Date__c.accessible,$ObjectType.Non_Conformance__c.Fields.Reported_Date__c.accessible,$ObjectType.Non_Conformance__c.Fields.Reporter__c.accessible,$ObjectType.Non_Conformance__c.FIelds.Department__c.Accessible,$ObjectType.Non_Conformance__c.FIelds.OwnerId.Accessible)}">
	                    <c:wiz_field Wide="true"
	                        FieldLabel="{!JSENCODE(IF(contains(customLabelKeys,'NC_Type'),customLabels['NC_Type'].Field_Label__c, $ObjectType.Non_Conformance__c.Fields.NC_Type__c.Label))}"
	                        required="true" jsid="NC_Type"
	                        rendered="{!$OBjectType.Non_Conformance__c.Fields.NC_Type__c.Accessible}">
	                        <c:wiz_RadioSet onchangefunction="showNcField"
	                            FieldName="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}NC_Type__c"
	                            ObjectName="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Non_Conformance__c"
	                            initvalue="{!JSENCODE(Non_Conformance__c.NC_Type__c)}"
	                            disabled="{!OR(Non_Conformance__c.Closed__c,NonConformance.Workflow__c,NOT($ObjectType.Non_Conformance__c.Fields.NC_Type__c.updateable))}" />
	                    </c:wiz_field>
                        <!-- Product -->
	                    <c:wiz_field FieldLabel="{!JSENCODE(IF(contains(customLabelKeys,'NC_Product'),customLabels['NC_Product'].Field_Label__c, $ObjectType.Non_Conformance__c.Fields.Product__c.Label))}"
	                        required="false" jsid="select_Product"
	                        rendered="{!$ObjectType.Non_Conformance__c.Fields.Product__c.accessible}">
	                        <c:wiz_multi disabled="{!OR(NonConformance.Workflow__c,Non_Conformance__c.Closed__c,NOT($ObjectType.Non_Conformance__c.Fields.Product__c.updateable))}"
	                            required="false" width="100%"
	                            FieldId="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Product__c"
	                            multiple="false"
	                            queryFields="Name,{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Product_Code__c"
	                            querytable="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Product__c"
	                            initvalues="{value:'{!JSENCODE(Non_Conformance__c.Product__c)}', label:'{!JSENCODE(Non_Conformance__c.Product__r.Name)}'}"
	                            onchange="
	                                              $('#{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Defect__c').val(null).trigger('change');
	                                             
	                                              if($('#{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Product__c').val() == ''){
	                                                 $('#{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Defect__c').data('id', '');
	                                                
	                                                $('#{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Defect__c').prop('disabled', true);
	                                              }
	                                              else{
	                                                console.log($('#{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Product__c').val());
	                                                $('#{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Defect__c').prop('disabled', false);
	                                                $('#{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Defect__c').data('id', $('#{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Product__c').val());
	                                              }    
	                                    " />
	
	                    </c:wiz_field>
                        <!-- End -->

	                    <!-- Process -->
	                    <c:wiz_field FieldLabel="{!JSENCODE(IF(contains(customLabelKeys,'NC_Process'),customLabels['NC_Process'].Field_Label__c, $ObjectType.Non_Conformance__c.Fields.Process__c.Label))}"
	                        required="false" jsid="select_Process"
	                        rendered="{!$ObjectType.Non_Conformance__c.Fields.NC_Type__c.Accessible}">
	                        <c:wiz_multi disabled="{!OR(NonConformance.Workflow__c,Non_Conformance__c.Closed__c,NOT($ObjectType.Non_Conformance__c.Fields.NC_Type__c.updateable))}"
	                            required="false" width="100%"
	                            FieldId="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Process__c"
	                            multiple="false" queryFields="Name,{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Process_Code__c"
	                            querytable="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Process__c"
	                            initValues="{label: '{!JSENCODE(NonConformance.Process__r.Name)}',
	                                             value: '{!JSENCODE(NonConformance.Process__c)}'}"
	                            onchange="
	                                              $('#{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Defect__c').val(null).trigger('change');
	                                             
	                                              if($('#{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Process__c').val() == ''){
	                                                 $('#{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Defect__c').data('id', '');
	                                                
	                                                $('#{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Defect__c').prop('disabled', true);
	                                              }
	                                              else{
	                                                console.log($('#QPMS__Product__c').val());
	                                                $('#{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Defect__c').prop('disabled', false);
	                                                $('#{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Defect__c').data('id', $('#{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Process__c').val());
	                                              }  
	                                 " />
	
	                    </c:wiz_field>
	                    <!-- End -->


	                    <c:wiz_field FieldLabel="{!JSENCODE(IF(contains(customLabelKeys,'NC_Defect'),customLabels['NC_Defect'].Field_Label__c, $ObjectType.Non_Conformance__c.Fields.Defect__c.Label))}"
	                        required="true" jsid="defect"
	                        rendered="{!$ObjectType.Non_Conformance__c.Fields.Defect__c.Accessible}">
	                        <c:wiz_multi disabled="{!OR(NOT($ObjectType.Non_Conformance__c.Fields.Defect__c.Updateable),Non_Conformance__c.Closed__c,NonConformance.Workflow__c)}"
	                            FieldId="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Defect__c"
	                            width="100%"
	                            FieldName="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Defect__c"
	                            multiple="false" queryFields="Name" type="proc"
	                            querytable="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Defect__c"
	                            onchange=""
	                            initValues="{label: '{!JSENCODE(NonConformance.Defect__r.Name)}',
	                                             value: '{!JSENCODE(NonConformance.Defect__c)}'}" />
	                    </c:wiz_field>


	                    <c:wiz_field rendered="{!$ObjectType.Non_Conformance__c.Fields.Full_Description__c.accessible}"
	                        FieldLabel="{!JSENCODE(IF(contains(customLabelKeys,'NC_Full_Description'),customLabels['NC_Full_Description'].Field_Label__c, $ObjectType.Non_Conformance__c.Fields.Full_Description__c.Label))}"
	                        required="true" jsid="defectstatement" wide="true">
	
	                        <c:wiz_richtext rendered="{!NOT(OR(NonConformance.Workflow__c,Non_Conformance__c.Closed__c,NOT($ObjectType.Non_Conformance__c.Fields.Full_Description__c.updateable)))}"
	                            Required="true" maxlength="4000"
	                            FieldId="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Full_Description__c"
	                            initvalue="{!Non_Conformance__c.Full_Description__c}" />
	                        <apex:outputpanel rendered="{!OR(NonConformance.Workflow__c,Non_Conformance__c.Closed__c,NOT($ObjectType.Non_Conformance__c.Fields.Full_Description__c.updateable))}">
	                            <div class="alert alert-info">
	                                <apex:outputField value="{!Non_Conformance__c.Full_Description__c}" />
	                            </div>
	                        </apex:outputpanel>
	                    </c:wiz_field>

	                   <c:wiz_field FieldLabel="{!JSENCODE(IF(contains(customLabelKeys,'NC_Occurance_Date'),customLabels['NC_Occurance_Date'].Field_Label__c, $ObjectType.Non_Conformance__c.Fields.Occurance_Date__c.Label))}"
	                       required="true" jsid="occurancedate"
	                       rendered="{!$ObjectType.Non_Conformance__c.FIelds.Occurance_Date__c.Accessible}">
	                       <c:wiz_date maxdateallowed="{!month(today())}/{!day(today())}/{!year(today())}"
	                           FieldId="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Occurance_Date__c"
	                           initdate="{!IF(ISBLANK(Non_Conformance__c.Occurance_Date__c),today(),Non_Conformance__c.Occurance_Date__c)}"
	                           updateable="{!AND(NOT(OR(NonConformance.Workflow__c,Non_Conformance__c.Closed__c)),$ObjectType.Non_Conformance__c.Fields.Occurance_Date__c.updateable)}" />
	                   </c:wiz_field>
	
	                   <c:wiz_field FieldLabel="{!JSENCODE(IF(contains(customLabelKeys,'NC_Reported_Date'),customLabels['NC_Reported_Date'].Field_Label__c, $ObjectType.Non_Conformance__c.Fields.Reported_Date__c.Label))}"
	                       required="true" jsid="reporteddate"
	                       rendered="{!$ObjectType.Non_Conformance__c.FIelds.Reported_Date__c.Accessible}">
	                       <c:wiz_date maxdateallowed="{!month(today())}/{!day(today())}/{!year(today())}"
	                           FieldId="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Reported_Date__c"
	                           initdate="{!IF(ISBLANK(Non_Conformance__c.Reported_Date__c),today(),Non_Conformance__c.Reported_Date__c)}"
	                           updateable="{!AND(NOT(OR(NonConformance.Workflow__c,Non_Conformance__c.Closed__c)),$ObjectType.Non_Conformance__c.Fields.Reported_Date__c.updateable)}" />
	                   </c:wiz_field>
	
	                   <c:wiz_field FieldLabel="{!JSENCODE(IF(contains(customLabelKeys,'NC_Reporter'),customLabels['NC_Reporter'].Field_Label__c, $ObjectType.Non_Conformance__c.Fields.Reporter__c.Label))}"
	                       required="true" jsid="reportedby"
	                       rendered="{!$ObjectType.Non_Conformance__c.Fields.Reporter__c.Accessible}">
	                       <c:wiz_multi disabled="{!OR(NonConformance.Workflow__c,Non_Conformance__c.Closed__c,NOT($ObjectType.Non_Conformance__c.Fields.Reporter__c.Updateable))}"
	                           width="100%"
	                           FieldId="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Reporter__c"
	                           multiple="false" queryFields="Name" querytable="User" onchange=""
	                           initValues="{label: '{!JSENCODE(IF(NOT(ISBLANK(NonConformance.Reporter__c)) , NonConformance.Reporter__r.FirstName + ' ' + NonConformance.Reporter__r.LastName, $User.FirstName + ' ' + $User.LastName))}',
	                                            value: '{!JSENCODE(IF(NOT(ISBLANK(NonConformance.Reporter__c)), NonConformance.Reporter__c, $User.Id))}'}" />
	                   </c:wiz_field>
	
	                   <c:wiz_field FieldLabel="{!JSENCODE(IF(contains(customLabelKeys,'NC_Owner'),customLabels['NC_Owner'].Field_Label__c,'Owner'))}" required="true" jsid="owner"
	                       rendered="{!$ObjectType.Non_Conformance__c.Fields.OwnerId.Accessible}">
	                       <c:wiz_multi disabled="{!OR(NonConformance.Workflow__c,Non_Conformance__c.Closed__c,NOT($ObjectType.Non_Conformance__c.Fields.OwnerId.updateable))}"
	                           width="100%" FieldId="OwnerId" multiple="false"
	                           queryFields="Name" querytable="User" onchange=""
	                           initValues="{label: '{!JSENCODE(IF(NOT(ISBLANK(NonConformance.OwnerId)) , NonConformance.Owner.Name, $User.FirstName + ' ' + $User.LastName))}',
	                                            value: '{!JSENCODE(IF(NOT(ISBLANK(NonConformance.OwnerId)), NonConformance.OwnerId, $User.Id))}'}" typeofuser="NC_Owner" />
	                   </c:wiz_field>

                  </apex:outputPanel>

                    <div class="clearfix"></div>

                    <br />
                    <!-- Additional Fields -->

                  <apex:outputPanel layout="none" rendered="{!OR($ObjectType.Non_Conformance__c.Fields.Department__c.Accessible,$ObjectType.Non_Conformance__c.Fields.Customer__c.Accessible,$ObjectType.Non_Conformance__c.Fields.BusinessUnit__c.Accessible,$ObjectType.Non_Conformance__c.Fields.Manufacturer_Supplier__c.Accessible,$ObjectType.Non_Conformance__c.Fields.NC_Source__c.accessible,$ObjectType.Non_Conformance__c.Fields.Supplier_Manufacturer_Part__c.accessible,$ObjectType.Non_Conformance__c.Fields.Audit__c.accessible,$ObjectType.Non_Conformance__c.Fields.PO_Number__c.accessible,$ObjectType.Non_Conformance__c.FIelds.Priority__c.Accessible,$ObjectType.Non_Conformance__c.FIelds.Other_Source__c.Accessible,$ObjectType.Non_Conformance__c.Fields.Initiating_Site__c.Accessible)}">
                    <div class="panel-group col-md-12" id="accordion" role="tablist"
                        aria-multiselectable="true">
                        <div class="panel panel-default">
                            <div class="panel-heading" role="tab" id="headingOne">
                                <h4 class="panel-title">
                                    <a data-toggle="collapse" data-parent="#accordion"
                                        href="#collapseOne" aria-expanded="true"
                                        aria-controls="collapseOne" class="collapsed"> <span
                                        class="col-exp"></span> {!JSENCODE(IF(contains(customLabelKeys,'NC_Cust_Field_Sec'),customLabels['NC_Add_Info_Section'].Section_Label__c, 'Additional Information'))}
                                    </a>
                                </h4>
                            </div>
                            <div id="collapseOne" class="panel-collapse collapse out"
                                role="tabpanel" aria-labelledby="headingOne">
                                <div class="panel-body">
                                                       
                                    <c:wiz_field FieldLabel="{!JSENCODE(IF(contains(customLabelKeys,'NC_Initiating_Site'),customLabels['NC_Initiating_Site'].Field_Label__c, $ObjectType.Non_Conformance__c.Fields.Initiating_Site__c.Label))}"
                                        required="false" jsid="site"
                                        rendered="{!$ObjectType.Non_Conformance__c.Fields.Initiating_Site__c.Accessible}">
                                        <c:wiz_multi width="100%"
                                            disabled="{!OR(NonConformance.Workflow__c,Non_Conformance__c.Closed__c,NOT($ObjectType.Non_Conformance__c.Fields.Initiating_Site__c.Updateable))}"
                                            required="false"
                                            FieldId="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Initiating_Site__c"
                                            multiple="false" queryFields="Name"
                                            querytable="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Manufacturing_Site__c"
                                            initvalues="{value: '{!JSENCODE(Non_Conformance__c.Initiating_Site__c)}', label:'{!JSENCODE(Non_Conformance__c.Initiating_Site__r.Name)}'}" />
                                    </c:wiz_field>

                                    <c:wiz_field FieldLabel="{!JSENCODE(IF(contains(customLabelKeys,'NC_Business_Unit'),customLabels['NC_Business_Unit'].Field_Label__c, $ObjectType.Non_Conformance__c.Fields.BusinessUnit__c.Label))}"
                                        required="false" jsid="bu"
                                        rendered="{!$ObjectType.Non_Conformance__c.Fields.BusinessUnit__c.Accessible}">
                                        <c:wiz_select disabled="{!OR(NonConformance.Workflow__c,Non_Conformance__c.Closed__c,NOT($ObjectType.Non_Conformance__c.Fields.BusinessUnit__c.Updateable))}"
                                            width="100%" developername="BusinessUnit__c"
                                            ObjectName="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Non_Conformance__c"
                                            FieldName="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}BusinessUnit__c"
                                            required="false"
                                            initvalue="{!Non_Conformance__c.BusinessUnit__c}" 
                                            unSelectedDisplayText="  "
                                            />
                                    </c:wiz_field>
                                    
                                    <div class="clearfix"></div>

                                    <c:wiz_field FieldLabel="{!JSENCODE(IF(contains(customLabelKeys,'NC_Source'),customLabels['NC_Source'].Field_Label__c, $ObjectType.Non_Conformance__c.Fields.NC_Source__c.Label))}"
                                        required="{!IF(NOT(ISBLANK(Non_Conformance__c.Id)),true,false)}"
                                        jsid="ncsource"
                                        rendered="{!$ObjectType.Non_Conformance__c.Fields.NC_Source__c.Accessible}">
                                        <c:wiz_select disabled="{!OR(NonConformance.Workflow__c,Non_Conformance__c.Closed__c,NOT($ObjectType.Non_Conformance__c.Fields.NC_Source__c.updateable))}"
                                            width="100%" developername="NC_Source"
                                            ObjectName="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Non_Conformance__c"
                                            FieldName="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}NC_Source__c"
                                            required="true"
                                            initvalue="{!Non_Conformance__c.NC_Source__c}"
                                            onchangefunction="ncSourceSelection" />
                                    </c:wiz_field>

                                    <c:wiz_field FieldLabel="{!JSENCODE(IF(contains(customLabelKeys,'NC_Other_Source'),customLabels['NC_Other_Source'].Field_Label__c, $ObjectType.Non_Conformance__c.Fields.Other_Source__c.Label))}"
                                        required="false" jsid="other"
                                        rendered="{!$ObjectType.Non_Conformance__c.Fields.Other_Source__c.Accessible}">
                                        <c:wiz_input fieldname="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Other_Source__c"
                                            initvalue="{!JSENCODE(Non_Conformance__c.Other_Source__c)}"
                                            disabled="{!OR(NonConformance.Workflow__c,Non_Conformance__c.Closed__c,NOT($ObjectType.Non_Conformance__c.Fields.Other_Source__c.updateable))}" />
                                    </c:wiz_field>

                                    <c:wiz_field FieldLabel="{!JSENCODE(IF(contains(customLabelKeys,'NC_Department'),customLabels['NC_Department'].Field_Label__c, $ObjectType.Non_Conformance__c.Fields.Department__c.Label))}"
                                        required="false" jsid="dept"
                                        rendered="{!$ObjectType.Non_Conformance__c.Fields.Department__c.Accessible}">
                                        <c:wiz_multi width="100%" required="false"
                                            FieldId="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Department__c"
                                            multiple="false" queryFields="Name"
                                            querytable="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Business_Entity__c"
                                            initvalues="{value: '{!JSENCODE(Non_Conformance__c.Department__c)}', label:'{!JSENCODE(Non_Conformance__c.Department__r.Name)}'}"
                                            disabled="{!OR(NonConformance.Workflow__c,Non_Conformance__c.Closed__c,NOT($ObjectType.Non_Conformance__c.Fields.Department__c.updateable))}" />
                                    </c:wiz_field>

                                    <c:wiz_field FieldLabel="{!JSENCODE(IF(contains(customLabelKeys,'NC_Priority'),customLabels['NC_Priority'].Field_Label__c, $ObjectType.Non_Conformance__c.Fields.Priority__c.Label))}"
                                        jsid="priority"
                                        rendered="{!$ObjectType.Non_Conformance__c.Fields.Priority__c.Accessible}">
                                        <c:wiz_select disabled="{!OR(NonConformance.Workflow__c,Non_Conformance__c.Closed__c,NOT($ObjectType.Non_Conformance__c.Fields.Priority__c.Updateable))}"
                                            width="100%" developername="Priority__c"
                                            ObjectName="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Non_Conformance__c"
                                            FieldName="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Priority__c"
                                            required="false" 
                                            initvalue="{!Non_Conformance__c.Priority__c}"
                                            unSelectedDisplayText=" "
                                             />
                                    </c:wiz_field>
									<div class="clearfix"></div>
                                    <c:wiz_field FieldLabel="{!JSENCODE(IF(contains(customLabelKeys,'NC_Audit'),customLabels['NC_Audit'].Field_Label__c, $ObjectType.Non_Conformance__c.Fields.Audit__c.Label))}"
                                        required="false" jsid="audit"
                                        rendered="{!$ObjectType.Non_Conformance__c.Fields.Audit__c.Accessible}">
                                        <c:wiz_input fieldname="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Audit__c"
                                            initvalue="{!JSENCODE(Non_Conformance__c.Audit__c)}"
                                            disabled="{!OR(NonConformance.Workflow__c,Non_Conformance__c.Closed__c,NOT($ObjectType.Non_Conformance__c.Fields.Audit__c.updateable))}" />
                                    </c:wiz_field>


                                    <c:wiz_field FieldLabel="{!JSENCODE(IF(contains(customLabelKeys,'NC_Manufacturer_Supplier'),customLabels['NC_Manufacturer_Supplier'].Field_Label__c, $ObjectType.Non_Conformance__c.Fields.Manufacturer_Supplier__c.Label))}" jsid="man"
                                        rendered="{!$ObjectType.Non_Conformance__c.Fields.Manufacturer_Supplier__c.Accessible}">
                                        <c:wiz_multi width="100%" required="false"
                                            FieldId="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Manufacturer_Supplier__c"
                                            multiple="false" queryFields="Name" querytable="Account"
                                            filtervalue="Manufacturer_Supplier"
                                            initvalues="{value: '{!JSENCODE(Non_Conformance__c.Manufacturer_Supplier__c)}', label:'{!JSENCODE(Non_Conformance__c.Manufacturer_Supplier__r.Name)}'}"
                                            disabled="{!OR(NonConformance.Workflow__c,Non_Conformance__c.Closed__c,NOT($ObjectType.Non_Conformance__c.Fields.Manufacturer_Supplier__c.updateable))}" />
                                    </c:wiz_field>
                                    <c:wiz_field FieldLabel="{!JSENCODE(IF(contains(customLabelKeys,'NC_Customer'),customLabels['NC_Customer'].Field_Label__c, $ObjectType.Non_Conformance__c.Fields.Customer__c.Label))}" jsid=" "
                                        rendered="{!$ObjectType.Non_Conformance__c.Fields.Customer__c.Accessible}">
                                        <c:wiz_multi width="100%" required="false"
                                            FieldId="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Customer__c"
                                            multiple="false" queryFields="Name" querytable="Account"
                                            filtervalue="Customer"
                                            initvalues="{value: '{!JSENCODE(Non_Conformance__c.Customer__c)}', label:'{!JSENCODE(Non_Conformance__c.Customer__r.Name)}'}"
                                            disabled="{!OR(NonConformance.Workflow__c,Non_Conformance__c.Closed__c,NOT($ObjectType.Non_Conformance__c.Fields.Customer__c.updateable))}" />
                                    </c:wiz_field>

                                    <c:wiz_field FieldLabel="{!JSENCODE(IF(contains(customLabelKeys,'NC_Supplier_Manufacturer_Part'),customLabels['NC_Supplier_Manufacturer_Part'].Field_Label__c, $ObjectType.Non_Conformance__c.Fields.Supplier_Manufacturer_Part__c.Label))}" required="false"
                                        jsid="part"
                                        rendered="{!$ObjectType.Non_Conformance__c.Fields.Supplier_Manufacturer_Part__c.Accessible}">
                                         <c:wiz_input type="text" fieldname="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Supplier_Manufacturer_Part__c"
                                            initvalue="{!JSENCODE(NonConformance.Supplier_Manufacturer_Part__c)}"
                                            disabled="{!OR(NonConformance.Workflow__c,Non_Conformance__c.Closed__c,NOT($ObjectType.Non_Conformance__c.Fields.Audit__c.updateable))}" />
                                    </c:wiz_field>

                                    <c:wiz_field FieldLabel="{!JSENCODE(IF(contains(customLabelKeys,'NC_PO_Number'),customLabels['NC_PO_Number'].Field_Label__c, $ObjectType.Non_Conformance__c.Fields.PO_Number__c.Label))}" required="false"
                                        jsid="ponum"
                                        rendered="{!$ObjectType.Non_Conformance__c.Fields.PO_Number__c.Accessible}">
                                        <c:wiz_input type="text" fieldname="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}PO_Number__c"
                                            initvalue="{!JSENCODE(NonConformance.PO_Number__c)}"
                                            disabled="{!OR(NonConformance.Workflow__c,Non_Conformance__c.Closed__c,NOT($ObjectType.Non_Conformance__c.Fields.Audit__c.updateable))}" />
                                    </c:wiz_field>



                                </div>
                            </div>

                        </div>
                    </div>
                </apex:outputPanel>    
                    <!--custom fields-->

                    
                    <apex:outputPanel layout="none" rendered="{!OR($ObjectType.Non_Conformance__c.FieldSets.NC_CustomFields.size>0,$ObjectType.Non_Conformance__c.Fields.UD_Text1__c.Accessible,$ObjectType.Non_Conformance__c.Fields.UD_Text2__c.Accessible,$ObjectType.Non_Conformance__c.Fields.UD_Picklist3__c.Accessible,$ObjectType.Non_Conformance__c.Fields.UD_Picklist4__c.Accessible,$ObjectType.Non_Conformance__c.Fields.UD_Text_Area5__c.accessible,$ObjectType.Non_Conformance__c.Fields.UD_Text_Area6__c.accessible,$ObjectType.Non_Conformance__c.Fields.UD_Long_Text_Area7__c.accessible,$ObjectType.Non_Conformance__c.Fields.UD_Long_Text_Area8__c.accessible,$ObjectType.Non_Conformance__c.FIelds.UD_Date9__c.Accessible,$ObjectType.Non_Conformance__c.FIelds.UD_Date10__c.Accessible)}">
                    <div class="panel-group col-md-12" id="accordionCF" role="tablist"
                        aria-multiselectable="true">
                        <div class="panel panel-default">
                            <div class="panel-heading" role="tab" id="headingOneCF">
                                <h4 class="panel-title">
                                    <a data-toggle="collapse" data-parent="#accordionCF"
                                        href="#collapseOneCF" aria-expanded="true"
                                        aria-controls="collapseOneCF" class="collapsed"> <span
                                        class="col-exp"></span>{!JSENCODE(IF(contains(customLabelKeys,'NC_Cust_Field_Sec'),customLabels['NC_Cust_Field_Sec'].Section_Label__c, 'Custom Field Details'))}
                                    </a>
                                </h4>
                            </div>
                            <div id="collapseOneCF" class="panel-collapse collapse out"
                                role="tabpanel" aria-labelledby="headingOneCF">
                                <div class="panel-body">

                                    <c:wiz_field FieldLabel="{!JSENCODE(IF(contains(customLabelKeys,'NC_UD_Text1'),customLabels['NC_UD_Text1'].Field_Label__c, $ObjectType.Non_Conformance__c.Fields.UD_Text1__c.Label))}" required="false"
                                        jsid="NC_First_Text"
                                        rendered="{!$ObjectType.Non_Conformance__c.Fields.UD_Text1__c.Accessible}">
                                        <c:wiz_input fieldname="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}UD_Text1__c"
                                            initvalue="{!JSENCODE(Non_Conformance__c.UD_Text1__c)}"
                                            disabled="{!OR(NonConformance.Workflow__c,Non_Conformance__c.Closed__c,NOT($ObjectType.Non_Conformance__c.Fields.Audit__c.updateable))}" />
                                    </c:wiz_field>
                                    
                                    <c:wiz_field FieldLabel="{!JSENCODE(IF(contains(customLabelKeys,'NC_UD_Text2'),customLabels['NC_UD_Text2'].Field_Label__c, $ObjectType.Non_Conformance__c.Fields.UD_Text2__c.Label))}" required="false"
                                        jsid="NC_Second_Text"
                                        rendered="{!$ObjectType.Non_Conformance__c.Fields.UD_Text2__c.Accessible}">
                                        <c:wiz_input fieldname="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}UD_Text2__c"
                                            initvalue="{!JSENCODE(Non_Conformance__c.UD_Text2__c)}"
                                            disabled="{!OR(NonConformance.Workflow__c,Non_Conformance__c.Closed__c,NOT($ObjectType.Non_Conformance__c.Fields.Audit__c.updateable))}" />
                                    </c:wiz_field>
                                    
                                    <c:wiz_field FieldLabel="{!JSENCODE(IF(contains(customLabelKeys,'NC_UD_Picklist3'),customLabels['NC_UD_Picklist3'].Field_Label__c, $ObjectType.Non_Conformance__c.Fields.UD_Picklist3__c.Label))}" required="false"
                                        jsid="NC_First_Picklist__c"
                                        rendered="{!$ObjectType.Non_Conformance__c.Fields.UD_Picklist3__c.Accessible}">
                                        <c:wiz_select disabled="{!OR(NonConformance.Workflow__c,Non_Conformance__c.Closed__c,NOT($ObjectType.Non_Conformance__c.Fields.UD_Picklist3__c.Updateable))}"
                                            width="100%" developername="UD_Picklist3__c"
                                            ObjectName="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Non_Conformance__c"
                                            FieldName="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}UD_Picklist3__c"
                                            required="false" 
                                            initvalue="{!Non_Conformance__c.UD_Picklist3__c}"
                                            unSelectedDisplayText="   "
                                             />
                                        
                                    </c:wiz_field>
                                    
                                    <c:wiz_field FieldLabel="{!JSENCODE(IF(contains(customLabelKeys,'NC_UD_Picklist4'),customLabels['NC_UD_Picklist4'].Field_Label__c, $ObjectType.Non_Conformance__c.Fields.UD_Picklist4__c.Label))}" required="false"
                                        jsid="NC_Second_Picklist__c"
                                        rendered="{!$ObjectType.Non_Conformance__c.Fields.UD_Picklist4__c.Accessible}">
                                        <c:wiz_select disabled="{!OR(NonConformance.Workflow__c,Non_Conformance__c.Closed__c,NOT($ObjectType.Non_Conformance__c.Fields.UD_Picklist4__c.Updateable))}"
                                            width="100%" developername="UD_Picklist4__c"
                                            ObjectName="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Non_Conformance__c"
                                            FieldName="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}UD_Picklist4__c"
                                            required="false" 
                                            initvalue="{!Non_Conformance__c.UD_Picklist4__c}"
                                            unSelectedDisplayText="    "
                                             />
                                        
                                    </c:wiz_field>
                                    
                                    <c:wiz_field rendered="{!$ObjectType.Non_Conformance__c.Fields.UD_Text_Area5__c.accessible}"  FieldLabel="{!JSENCODE(IF(contains(customLabelKeys,'NC_UD_Text_Area5'),customLabels['NC_UD_Text_Area5'].Field_Label__c, $ObjectType.Non_Conformance__c.Fields.UD_Text_Area5__c.Label))}"
                        required="false" jsid="First_Text_Area__c" wide="false">

                        <c:wiz_textarea rendered="{!NOT(OR(NonConformance.Workflow__c,Non_Conformance__c.Closed__c,NOT($ObjectType.Non_Conformance__c.Fields.UD_Text_Area5__c.updateable)))}"
                            Required="false"
                            ObjectName="Non_Conformance__c"
                            FieldName="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}UD_Text_Area5__c"
                            FieldId="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}UD_Text_Area5__c"
                            initvalue="{!JSENCODE(Non_Conformance__c.UD_Text_Area5__c)}" />
                        <apex:outputpanel rendered="{!OR(NonConformance.Workflow__c,Non_Conformance__c.Closed__c,NOT($ObjectType.Non_Conformance__c.Fields.UD_Text_Area5__c.updateable))}">
                            <div class="alert alert-info">
                                <apex:outputField value="{!Non_Conformance__c.UD_Text_Area5__c}" />
                            </div>
                        </apex:outputpanel>
                    </c:wiz_field>

                    <c:wiz_field rendered="{!$ObjectType.Non_Conformance__c.Fields.UD_Text_Area6__c.accessible}"  FieldLabel="{!JSENCODE(IF(contains(customLabelKeys,'NC_UD_Text_Area6'),customLabels['NC_UD_Text_Area6'].Field_Label__c, $ObjectType.Non_Conformance__c.Fields.UD_Text_Area6__c.Label))}"
                        required="false" jsid="Second_Text_Area__c" wide="false">

                        <c:wiz_textarea rendered="{!NOT(OR(NonConformance.Workflow__c,Non_Conformance__c.Closed__c,NOT($ObjectType.Non_Conformance__c.Fields.UD_Text_Area6__c.updateable)))}"
                            Required="false"
                            ObjectName="Non_Conformance__c"
                            FieldName="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}UD_Text_Area6__c"
                            FieldId="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}UD_Text_Area6__c"
                            initvalue="{!JSENCODE(Non_Conformance__c.UD_Text_Area6__c)}" />
                        <apex:outputpanel rendered="{!OR(NonConformance.Workflow__c,Non_Conformance__c.Closed__c,NOT($ObjectType.Non_Conformance__c.Fields.UD_Text_Area6__c.updateable))}">
                            <div class="alert alert-info">
                                <apex:outputField value="{!Non_Conformance__c.UD_Text_Area6__c}" />
                            </div>
                        </apex:outputpanel>
                    </c:wiz_field>

                      <c:wiz_field rendered="{!$ObjectType.Non_Conformance__c.Fields.UD_Long_Text_Area7__c.accessible}"  FieldLabel="{!JSENCODE(IF(contains(customLabelKeys,'NC_UD_Long_Text_Area7'),customLabels['NC_UD_Long_Text_Area7'].Field_Label__c, $ObjectType.Non_Conformance__c.Fields.UD_Long_Text_Area7__c.Label))}"
                        required="false" jsid="First_Text_Area__c" wide="true">

                        <c:wiz_textarea rendered="{!NOT(OR(NonConformance.Workflow__c,Non_Conformance__c.Closed__c,NOT($ObjectType.Non_Conformance__c.Fields.UD_Long_Text_Area7__c.updateable)))}"
                            Required="false"
                            ObjectName="Non_Conformance__c"
                            FieldName="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}UD_Long_Text_Area7__c"
                            FieldId="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}UD_Long_Text_Area7__c"
                            initvalue="{!JSENCODE(Non_Conformance__c.UD_Long_Text_Area7__c)}" />
                        <apex:outputpanel rendered="{!OR(NonConformance.Workflow__c,Non_Conformance__c.Closed__c,NOT($ObjectType.Non_Conformance__c.Fields.UD_Long_Text_Area7__c.updateable))}">
                            <div class="alert alert-info">
                                <apex:outputField value="{!Non_Conformance__c.UD_Long_Text_Area7__c}" />
                            </div>
                        </apex:outputpanel>
                    </c:wiz_field>

                    <c:wiz_field rendered="{!$ObjectType.Non_Conformance__c.Fields.UD_Long_Text_Area8__c.accessible}"  FieldLabel="{!JSENCODE(IF(contains(customLabelKeys,'NC_UD_Long_Text_Area8'),customLabels['NC_UD_Long_Text_Area8'].Field_Label__c, $ObjectType.Non_Conformance__c.Fields.UD_Long_Text_Area8__c.Label))}"
                        required="false" jsid="Second_Text_Area__c" wide="true">

                        <c:wiz_textarea rendered="{!NOT(OR(NonConformance.Workflow__c,Non_Conformance__c.Closed__c,NOT($ObjectType.Non_Conformance__c.Fields.UD_Long_Text_Area8__c.updateable)))}"
                            Required="false"
                            ObjectName="Non_Conformance__c"
                            FieldName="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}UD_Long_Text_Area8__c"
                            FieldId="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}UD_Long_Text_Area8__c"
                            initvalue="{!JSENCODE(Non_Conformance__c.UD_Long_Text_Area8__c)}" />
                        <apex:outputpanel rendered="{!OR(NonConformance.Workflow__c,Non_Conformance__c.Closed__c,NOT($ObjectType.Non_Conformance__c.Fields.UD_Long_Text_Area8__c.updateable))}">
                            <div class="alert alert-info">
                                <apex:outputField value="{!Non_Conformance__c.UD_Long_Text_Area8__c}" />
                            </div>
                        </apex:outputpanel>
                    </c:wiz_field>
                    
                    <c:wiz_field FieldLabel="{!JSENCODE(IF(contains(customLabelKeys,'NC_UD_Date9'),customLabels['NC_UD_Date9'].Field_Label__c, $ObjectType.Non_Conformance__c.Fields.UD_Date9__c.Label))}"
                        required="false" jsid="NC_First_Date"
                        rendered="{!$ObjectType.Non_Conformance__c.FIelds.UD_Date9__c.Accessible}">
                        <c:wiz_date maxdateallowed="{!month(today())}/{!day(today())}/{!year(today())+100}"
                            FieldId="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}UD_Date9__c"
                            initdate="{!Non_Conformance__c.UD_Date9__c}"
                            required="none"
                            updateable="{!AND(NOT(OR(NonConformance.Workflow__c,Non_Conformance__c.Closed__c)),$ObjectType.Non_Conformance__c.Fields.UD_Date9__c.updateable)}" />
                    </c:wiz_field>

                    <c:wiz_field FieldLabel="{!JSENCODE(IF(contains(customLabelKeys,'NC_UD_Date10'),customLabels['NC_UD_Date10'].Field_Label__c, $ObjectType.Non_Conformance__c.Fields.UD_Date10__c.Label))}"
                        required="false" jsid="Second_Date__c"
                        rendered="{!$ObjectType.Non_Conformance__c.FIelds.UD_Date10__c.Accessible}">
                        <c:wiz_date maxdateallowed="{!month(today())}/{!day(today())}/{!year(today())+100}"
                            FieldId="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}UD_Date10__c"
                            initdate="{!Non_Conformance__c.UD_Date10__c}"
                            required="none"
                            updateable="{!AND(NOT(OR(NonConformance.Workflow__c,Non_Conformance__c.Closed__c)),$ObjectType.Non_Conformance__c.Fields.UD_Date10__c.updateable)}" />
                    </c:wiz_field>
                    <script type="text/javascript">
                         $('#{!JSENCODE(IF(NOT(ISBLANK(Prefix)),Prefix+'__',''))}UD_Date9__c,#{!JSENCODE(IF(NOT(ISBLANK(Prefix)),Prefix+'__',''))}UD_Date10__c').datetimepicker({dayViewHeaderFormat: 'DD MMM YYYY', format: "DD MMM YYYY"});
                    </script>
                                                                           
                                    
                              <apex:repeat value="{!$ObjectType.Non_Conformance__c.FieldSets.NC_CustomFields}" var="f">
                        <c:wiz_field Wide="{!($ObjectType.Non_Conformance__c.Fields[f].type=='textarea')}" FieldLabel="{!JSENCODE($ObjectType.Non_Conformance__c.Fields[f].Label)}"
                                     required="{!f.required}" jsid="{!LEFT(f,LEN(f)-3)}"
                                     rendered="{!$ObjectType.Non_Conformance__c.Fields[f].Accessible}">
                            <c:wiz_richtext rendered="{!AND($ObjectType.Non_Conformance__c.Fields[f].type=='textarea',$ObjectType.Non_Conformance__c.Fields[f].htmlFormatted)}" FieldId="{!f}" FieldName="{!f}" initvalue="{!NonConformance[f]}" Required="{!f.required}" ></c:wiz_richtext>                        
                            <c:wiz_textarea rendered="{!AND($ObjectType.Non_Conformance__c.Fields[f].type=='textarea',NOT($ObjectType.Non_Conformance__c.Fields[f].htmlFormatted))}" ObjectName="{!$ObjectType.Non_Conformance__c.name}" FieldId="{!f}" FieldName="{!f}" initvalue="{!NonConformance[f]}" Required="{!f.required}" ></c:wiz_textarea>                        
                            <c:wiz_date rendered="{!$ObjectType.Non_Conformance__c.Fields[f].type=='date'}" FieldId="{!f}" required="{!if(f.required,'','none')}" FieldName="{!f}" initdate="{!NonConformance[f]}">
                            </c:wiz_date>
                            <apex:outputPanel rendered="{!$ObjectType.Non_Conformance__c.Fields[f].type=='date'}">
                                <script>                            
                                $(document).ready(function() {
                                    $("#{!f}").datetimepicker({dayViewHeaderFormat: 'DD MMM YYYY', format: "DD MMM YYYY" });
                                });
                                </script>
                                
                            </apex:outputPanel>
                            <c:wiz_select ObjectName="{!JSENCODE(IF(NOT(ISBLANK(Prefix)),Prefix+'__',''))}Non_Conformance__c" developername="{!f}" onChangeFunction="makeCapaResourceDirty" width="100%" rendered="{!$ObjectType.Non_Conformance__c.Fields[f].type=='picklist'}" FieldId="{!f}" FieldName="{!f}" initvalue="{!NonConformance[f]}" Required="{!f.required}" ></c:wiz_select> 
                            <c:wiz_input rendered="{!$ObjectType.Non_Conformance__c.Fields[f].type=='string'}" fieldId="{!f}" fieldname="{!f}"  initvalue="{!NonConformance[f]}"  required="{!f.required}" disabled="{!OR(NonConformance.Closed__c,NOT($ObjectType.Non_Conformance__c.Fields[f].updateable))}"></c:wiz_input>
                            <c:wiz_multi rendered="{!$ObjectType.Non_Conformance__c.Fields[f].type=='reference'}" disabled="{!OR(NonConformance.Closed__c,NOT($ObjectType.Non_Conformance__c.Fields[f].updateable))}"
                                         width="100%"
                                         FieldId="{!f}"
                                         required="{!f.required}"
                                         multiple="false" queryFields="Name" querytable="{!$ObjectType.CAPA__c.Fields[f].referenceTo[0]}" onchange=""
                                         initValues="{label: '{!IF(NOT(ISBLANK(NonConformance[f])) , NonConformance[$ObjectType.Non_Conformance__c.Fields[f].relationshipName].FirstName + ' ' + NonConformance[$ObjectType.Non_Conformance__c.Fields[f].relationshipName].LastName, $User.FirstName + ' ' + $User.LastName)}',
                                                     value: '{!IF(NOT(ISBLANK(NonConformance[f])), NonConformance[f], $User.Id)}'}" />
                        </c:wiz_field>
                    </apex:repeat>                         
                    
                                    
                                    

                                </div>
                            </div>

                        </div>
                    </div>
                  </apex:outputPanel>
                    
                    <div class="clearfix"></div>
                  

                </c:wiz_form>
               
         </apex:outputPanel>
         <!-- End : Initiation -->
            
        <!-- Begin : Product Inoformation -->
         <apex:outputPanel rendered="{!$CurrentPage.parameters.pg=='nc_products'}">
     <script type="text/javascript">
  var lotBatch =[];
         var lotBatchMap = {};
     var existingProducts=[],isEdit=false;
              </script>
         <input type="hidden" name="page" id="page" value="nc_products"/>
   <input type="hidden" id="stepName" name="stepName" value="Product Information" />
   <apex:outputpanel layout="none" rendered="{!$ObjectType.NC_Product__c.Createable}">                               
            <div class="text-right button-bar">
                <button id="create-product-button" class="btn btn-primary" onclick="createprod();"><span class="fa fa-plus-square-o"></span> Add Product</button>
            </div>
            <script type="text/javascript">
                
                $('#create-product-button').prop('disabled', {!OR(NonConformance.Workflow__c,NonConformance.Closed__c,NOT($ObjectType.Non_Conformance__c.Fields.Product__c.updateable))});
                
            </script>
   </apex:outputpanel>
                                                    
              <div class="clearfix"></div>
              
              <div class="wiz-field col-md-12">  
                <!--  Accordian -->
                      <script>                                 
                    function checkLotBatchNumber(prodid,val){

                        var prefix='<apex:outputText value="{!JSENCODE($Setup.Dev_Only__c.Namespace_Prefix__c)}" />';
                        prefix=prefix?prefix+'__':'';
                        console.log('checkLotBatchNumber  prodid '+prodid+' val    '+val); 
                        var lotBatches=lotBatchMap[prodid];
                        console.log('lotBatches  '+lotBatches);
                        $('#'+prefix+'Lot_Bacth_Number__c_error').html(''); 
                        if($.inArray( val.trim(), lotBatches )>=0){
                            //console.log('checkLotBatchNumber   lotbatchval...'+val);
                            console.log('inside if lotBatches  '+lotBatches);
                            $('#'+prefix+'Lot_Bacth_Number__c_error').append('This Lot/Batch Number is already exist').css('color','red');
                            return false;
                        }
                        return true;    
                    }
                    </script> 
               <input type="hidden" id="addedProdId"/>
               <apex:repeat value="{!Non_Conformance__c.NC_Products__r}" var="p">
                   <c:wiz_added_Product recordid="{!p.id}" editable="true" disabled="{!OR(NonConformance.Workflow__c,NonConformance.Closed__c,NOT($ObjectType.Non_Conformance__c.Fields.Product__c.updateable))}"/>
               </apex:repeat>
                </div>
               
    
                   
         
         </apex:outputPanel>
         <!-- Begin : Resolution -->
         <apex:outputPanel rendered="{!$CurrentPage.parameters.pg=='nc_resolution'}">
             <div class="wiz-field nc-resolution">
               <c:wiz_form submitpage="stringify_sobject" formid="ncForm" formclass="appform validate" recordid="{!NonConformance.Id}" 
               postsavejs="location.reload();" >
               <input type="hidden" name="sobj" value="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}non_conformance__c"/>
               
                  <input type="hidden" id="page" name="page" value="nc_resolution"/>
                  <input type="hidden" id="stepName" name="stepName" value="Resolution" />
                  <input type="hidden" name="Id" value="{!NonConformance.Id}" />
                  <input id="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}NC_Status__c" type="hidden" name="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}NC_Status__c" value="{!NonConformance.NC_Status__c}" />
                  <input id="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}NC_Workflow_Status__c" type="hidden" name="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}NC_Workflow_Status__c" value="" />
                  <input id="ncResCode" type="hidden" name="ncResCode" value="{!Non_Conformance__c.NC_Resolution_Code__c}" />
               
                  <!--  Accordian -->
                  <apex:outputPanel layout="none" rendered="{!OR($ObjectType.Non_Conformance__c.Fields.Risk_Severity__c.Accessible,$ObjectType.Non_Conformance__c.Fields.Risk_Occurrence__c.Accessible,$ObjectType.Non_Conformance__c.Fields.CAPA_Required__c.Accessible,$ObjectType.Non_Conformance__c.Fields.Risk_Description__c.accessible,$ObjectType.Non_Conformance__c.Fields.Justification_for_CAPA_no_CAPA__c.accessible)}">
                      <div class="panel-group col-md-12" id="accordion" role="tablist" aria-multiselectable="true">
                          <div class="panel panel-default">
                            <div class="panel-heading" role="tab" id="headingOne">
                              <h4 class="panel-title">

                                <div class="checkbox pull-right">
                                    <c:wiz_field FieldLabel="" required="false" jsid="AssementReq">
                                      <c:wiz_checkbox FieldId="risk_assessment_required" 
                                                      FieldName="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Risk_Assessment_Required__c" 
                                                      initvalue="{!NonConformance.Risk_Assessment_Required__c}"
                                                      onChangeFunction="showHideRiskAssessment"
                                                      disabled="{!OR(NonConformance.Closed__c,NonConformance.Workflow__c,NOT($ObjectType.Non_Conformance__c.Fields.Risk_Assessment_Required__c.updateable),AND(Non_Conformance__c.NC_Resolution_Code__c=='NC Workflow',Non_Conformance__c.NC_Status__c=='Reopened'))}"
                                                      />
                                    </c:wiz_field>
                                  </div>
                                  <a data-toggle="collapse" data-parent="#accordion" >
                                      {!JSENCODE(IF(contains(customLabelKeys,'NC_Risk_Assesment_Required'),customLabels['NC_Risk_Assesment_Required'].Section_Label__c, 'Risk Assessment Required?'))}
                                  </a>
                              </h4>
                            </div>

                            <div id="assesment_pane" class="panel-collapse collapse out" role="tabpanel" aria-labelledby="headingOne">

                              <div class="panel-body"> 
                                  

                                  
                                <c:wiz_field FieldLabel="{!JSENCODE(IF(contains(customLabelKeys,'NC_Risk_Severity'),customLabels['NC_Risk_Severity'].Field_Label__c, $ObjectType.Non_Conformance__c.Fields.Risk_Severity__c.Label))}" required="true" jsid="sev" rendered="{!$ObjectType.Non_Conformance__c.Fields.Risk_Severity__c.accessible}">
                                    <c:wiz_multi required="true" FieldId="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Risk_Severity__c" multiple="false" queryFields="Name,{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Number__c" querytable="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Risk_Severity__c"
                                                 queryorderby="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Number__c"
                                    initvalues="{value:'{!JSENCODE(NonConformance.Risk_Severity__c)}', label:'{!JSENCODE(NonConformance.Risk_Severity__r.Name)}'}"
                                    onchange="updateRiskPriority();"
                                    disabled="{!OR(NonConformance.Closed__c,NonConformance.Workflow__c,NOT($ObjectType.Non_Conformance__c.Fields.Risk_Severity__c.updateable),AND(Non_Conformance__c.NC_Resolution_Code__c=='NC Workflow',Non_Conformance__c.NC_Status__c=='Reopened'))}"
                                    />
                                </c:wiz_field>

                                
                                <c:wiz_field FieldLabel="{!JSENCODE(IF(contains(customLabelKeys,'NC_Risk_Occurrence'),customLabels['NC_Risk_Occurrence'].Field_Label__c, $ObjectType.Non_Conformance__c.Fields.Risk_Occurrence__c.Label))}" required="true" jsid="prob" rendered="{!$ObjectType.Non_Conformance__c.Fields.Risk_Occurrence__c.accessible}">
                                    <c:wiz_multi required="true" FieldId="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Risk_Occurrence__c" multiple="false" queryFields="Name,{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Number__c" querytable="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Risk_Occurrence__c" 
                                                 queryorderby="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Number__c"
                                    initvalues="{value:'{!JSENCODE(NonConformance.Risk_Occurrence__c)}', label:'{!JSENCODE(NonConformance.Risk_Occurrence__r.Name)}'}"
                                    onchange="updateRiskPriority();"
                                    disabled="{!OR(NonConformance.Closed__c,NonConformance.Workflow__c,NOT($ObjectType.Non_Conformance__c.Fields.Risk_Occurrence__c.updateable),AND(Non_Conformance__c.NC_Resolution_Code__c=='NC Workflow',Non_Conformance__c.NC_Status__c=='Reopened'))}"
                                    />
                                </c:wiz_field>
                                  
                                  <c:wiz_field FieldLabel="{!JSENCODE(IF(contains(customLabelKeys,'NC_Risk_Priority'),customLabels['NC_Risk_Priority'].Field_Label__c, $ObjectType.Non_Conformance__c.Fields.Risk_Priority__c.Label))}" required="false" jsid="riskpriority" rendered="{!$ObjectType.Non_Conformance__c.Fields.Risk_Priority__c.accessible}">
                                    <c:wiz_readonly value="{!Non_Conformance__c.Risk_Priority__r.Name}"/>
                                </c:wiz_field>
                                
                                <c:wiz_field FieldLabel="{!JSENCODE(IF(contains(customLabelKeys,'NC_CAPA_Required'),customLabels['NC_CAPA_Required'].Field_Label__c, $ObjectType.Non_Conformance__c.Fields.CAPA_Required__c.Label))}" required="false" jsid="capa_required" rendered="{!$ObjectType.Non_Conformance__c.Fields.CAPA_Required__c.accessible}">
                                <!-- Technically this is required but Severity and Probability are also required and when they are selected they also update this field. -->
                                    <c:wiz_RadioSet FieldName="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}CAPA_Required__c" 
                                        ObjectName="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Non_Conformance__c" 
                                        OnChangeFunction="showHideCapaDescription" 
                                        InitValue="{!Non_Conformance__c.CAPA_Required__c}" 
                                        disabled="{!OR(Non_Conformance__c.Closed__c,NonConformance.Workflow__c,NOT($ObjectType.Non_Conformance__c.Fields.CAPA_Required__c.updateable),AND(Non_Conformance__c.NC_Resolution_Code__c=='NC Workflow',Non_Conformance__c.NC_Status__c=='Reopened'))}"
                                    />
                                </c:wiz_field>

                              <c:wiz_field FieldLabel="{!JSENCODE(IF(contains(customLabelKeys,'NC_Risk_Description'),customLabels['NC_Risk_Description'].Field_Label__c, $ObjectType.Non_Conformance__c.Fields.Risk_Description__c.Label))}" required="true" jsid="Risk_Description" wide="true">
                                 <!-- <c:wiz_richtext readonly="{!OR(NonConformance.Closed__c, NOT($ObjectType.Non_Conformance__c.Fields.Risk_Description__c.updateable))}" FieldId="QPMS__Risk_Description__c" initvalue="{!Non_Conformance__c.Risk_Description__c}" Required="true" /> -->
                                 <c:wiz_richtext Rendered="{!NOT(OR(NonConformance.Closed__c,NonConformance.Workflow__c,NOT($ObjectType.Non_Conformance__c.Fields.Risk_Description__c.updateable),AND(Non_Conformance__c.NC_Resolution_Code__c=='NC Workflow',Non_Conformance__c.NC_Status__c=='Reopened')))}" FieldId="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Risk_Description__c" initvalue="{!Non_Conformance__c.Risk_Description__c}" Required="true" maxlength="4000"/>
                                 <apex:outputpanel rendered="{!OR(NonConformance.Closed__c,NonConformance.Workflow__c,NOT($ObjectType.Non_Conformance__c.Fields.Risk_Description__c.updateable),AND(Non_Conformance__c.NC_Resolution_Code__c=='NC Workflow',Non_Conformance__c.NC_Status__c=='Reopened'))}">
                                    <div class="alert alert-info" > <apex:outputField value="{!Non_Conformance__c.Risk_Description__c}" /> </div>
                                  </apex:outputpanel>
                                </c:wiz_field>
                                  
                                  
                                
                                <c:wiz_field FieldLabel="{!JSENCODE(IF(contains(customLabelKeys,'NC_Just_No_CAPA'),customLabels['NC_Just_No_CAPA'].Field_Label__c, $ObjectType.Non_Conformance__c.Fields.Justification_for_CAPA_no_CAPA__c.Label))}" required="true" jsid="capa_justification" wide="true">
                                    
                                    
                                    <c:wiz_richtext Rendered="{!NOT(OR(NonConformance.Closed__c,NonConformance.Workflow__c,NOT($ObjectType.Non_Conformance__c.Fields.Justification_for_CAPA_no_CAPA__c.updateable),AND(Non_Conformance__c.NC_Resolution_Code__c=='NC Workflow',Non_Conformance__c.NC_Status__c=='Reopened')))}" FieldId="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Justification_for_CAPA_no_CAPA__c" initvalue="{!Non_Conformance__c.Justification_for_CAPA_no_CAPA__c}" Required="true" maxlength="4000"/>
                                    <apex:outputpanel rendered="{!OR(NonConformance.Closed__c,NonConformance.Workflow__c,NOT($ObjectType.Non_Conformance__c.Fields.Justification_for_CAPA_no_CAPA__c.updateable),AND(Non_Conformance__c.NC_Resolution_Code__c=='NC Workflow',Non_Conformance__c.NC_Status__c=='Reopened'))}">
                                    <div class="alert alert-info" > <apex:outputField value="{!Non_Conformance__c.Justification_for_CAPA_no_CAPA__c}" /> </div>
                                  </apex:outputpanel>
                                </c:wiz_field>
                                  
                                <c:GetRiskPriorityData GlobalVariableName="riskPriorityGridAll" 
                                                         ReturnAll="true"
                                                         >
                                </c:GetRiskPriorityData>

                              </div>
                            </div>
                          </div>

                        </div>
             </apex:outputPanel>
                    <!--  Accordian -->

                    
                    
                    <!------------------------------------------------------------------------------------------------->
                
                    <div class="">
                      
                      <c:wiz_field FieldLabel="{!JSENCODE(IF(contains(customLabelKeys,'NC_Resolution_Code'),customLabels['NC_Resolution_Code'].Field_Label__c, $ObjectType.Non_Conformance__c.Fields.NC_Resolution_Code__c.Label))}" required="true" jsid="ResolutionCodeContainer">
                         <c:wiz_select onChangeFunction="showHideBasedOnResolutionCode" 
                                       FieldId="ResolutionCodeField" 
                                       developername="NC_Resolution_Code__c"
                                       ObjectName="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Non_Conformance__c" 
                                       FieldName="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}NC_Resolution_Code__c" 
                                       required="true"  
                                       initvalue="{!Non_Conformance__c.NC_Resolution_Code__c}" 
                                       width="100%"
                                       unSelectedDisplayText="Select Resolution"
                                       disabled="{!OR(Non_Conformance__c.Closed__c,NonConformance.Workflow__c,NOT($ObjectType.Non_Conformance__c.Fields.NC_Resolution_Code__c.Updateable),AND(Non_Conformance__c.NC_Resolution_Code__c=='NC Workflow',Non_Conformance__c.NC_Status__c=='Reopened'))}"
                          />
                      </c:wiz_field>
                                         
                      <c:wiz_field FieldLabel="{!JSENCODE(IF(contains(customLabelKeys,'NC_Resolution_Closed_Comment'),customLabels['NC_Resolution_Closed_Comment'].Field_Label__c, $ObjectType.Non_Conformance__c.Fields.Resolution_Closed_Comment__c.Label))}" required="false" jsid="resolution_closed_comments" wide="true">
                                  
                                  
                                 <c:wiz_richtext Rendered="{!NOT(OR(Non_Conformance__c.Closed__c,NonConformance.Workflow__c,NOT($ObjectType.Non_Conformance__c.Fields.Resolution_Closed_Comment__c.updateable)))}" FieldId="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Resolution_Closed_Comment__c" initvalue="{!Non_Conformance__c.Resolution_Closed_Comment__c}" Required="false" maxlength="4000"/>

                                  <apex:outputpanel rendered="{!OR(Non_Conformance__c.Closed__c,NonConformance.Workflow__c,NOT($ObjectType.Non_Conformance__c.Fields.Resolution_Closed_Comment__c.updateable))}">
                                    <div class="alert alert-info" > <apex:outputField value="{!Non_Conformance__c.Resolution_Closed_Comment__c}" /> </div>
                                  </apex:outputpanel>

                     </c:wiz_field>
                     
                     
                        <div class="form-group" id="adhoc_button">
                            <div class="tab-content">
                                <div class="wiz-fields text-right">
                                    <br/><button type="button" id='createadhoctask' class="btn btn-primary" onClick="resAdhoc_add_genAdhocTask($('.pageAdhoc'),'adhocDiv')">Add Adhoc Task</button>
                                </div>  
                            </div>    
                        </div> 
 
                    </div>
                    
                   <!--Create CAPA -------------------------------------------------------------------->
                 <div class="tab-content col-md-12">
                 <div role="tabpanel" class="tab-pane" id="address_through_capa_tab">
                    <div class="panel panel-default" id="address_through_capa_tab">
                            <div class="panel-heading">CAPA</div>
                            <div class="panel-body">
                               <apex:outputPanel layout="none" rendered="{!NOT(ExternalSystemCapaReferenceNeeded)}"> 
                                <c:wiz_field FieldLabel="{!JSENCODE(IF(contains(customLabelKeys,'NC_CAPA_Number'),customLabels['NC_CAPA_Number'].Field_Label__c, $ObjectType.Non_Conformance__c.Fields.CAPA_Number__c.Label))}" required="true" jsid="capaNumber" rendered="{!$ObjectType.Non_Conformance__c.Fields.CAPA_Number__c.accessible}">
                                    <c:wiz_multi required="true" FieldId="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}CAPA_Number__c" multiple="false" queryFields="Name" querytable="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}CAPA__c" 
                                                 queryorderby="Name"
                                    initvalues="{value:'{!JSENCODE(NonConformance.CAPA_Number__c)}', label:'{!JSENCODE(NonConformance.CAPA_Number__c)}'}"
                                    onchange=""
                                    type="nccapa"
                                    disabled="{!OR(NonConformance.Closed__c,NonConformance.Workflow__c,NOT($ObjectType.Non_Conformance__c.Fields.CAPA_Number__c.updateable),AND(Non_Conformance__c.NC_Resolution_Code__c=='NC Workflow',Non_Conformance__c.NC_Status__c=='Reopened'))}"
                                    />
                                </c:wiz_field>
                                <apex:outputPanel rendered="{!ISBLANK(NonConformance.New_Capa_Number__c)}">
	                                <div class="form-group">
	                                   <c:wiz_checkbox FieldId="crtCAPAChk" 
	                                                      FieldName="crtCAPAChkBox" 
	                                                      initvalue=""
	                                                      onChangeFunction="toggleCreateCAPAButton"
	                                                      disabled="{!OR(NonConformance.Closed__c,NonConformance.Workflow__c,NOT($ObjectType.Non_Conformance__c.Fields.Risk_Assessment_Required__c.updateable),AND(Non_Conformance__c.NC_Resolution_Code__c=='NC Workflow',Non_Conformance__c.NC_Status__c=='Reopened'))}"
	                                   />  Create New CAPA ? <br/>
	                                   <button type="button" id='createCapaBtn' class="btn btn-primary " title="Creates a new Capa In the system" style="display:none" onClick="createCAPA('{!NonConformance.Id}','{!NonConformance.Name}','{!NonConformance.Full_Description__c}')">Create</button>
	                                </div>
                                </apex:outputPanel>
                               </apex:outputPanel>
                               <apex:outputPanel layout="none" rendered="{!ExternalSystemCapaReferenceNeeded}">
                                 
                                  <c:wiz_field FieldLabel="{!JSENCODE(IF(contains(customLabelKeys,'NC_CAPA_Number'),customLabels['NC_CAPA_Number'].Field_Label__c, $ObjectType.Non_Conformance__c.Fields.CAPA_Number__c.Label))}" jsid="extCapaNumberFL" rendered="{!$ObjectType.Non_Conformance__c.Fields.CAPA_Number__c.accessible}">
                                   <c:wiz_input fieldId="extCapaNum" initValue="{!JSENCODE(NonConformance.CAPA_Number__c)}"  fieldName="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}CAPA_Number__c" disabled="{!OR(NonConformance.Closed__c,NonConformance.Workflow__c,NOT($ObjectType.Non_Conformance__c.Fields.CAPA_Number__c.updateable),AND(Non_Conformance__c.NC_Resolution_Code__c=='NC Workflow',Non_Conformance__c.NC_Status__c=='Reopened'))}"/>
                                  </c:wiz_field>
                                 <div class="form-group">
                                  <c:wiz_checkbox FieldId="browseExtCAPAChk" 
                                                      FieldName="browseExtCAPAChkBox" 
                                                      initvalue=""
                                                      onChangeFunction="toggleBrowseExtCAPAButton"
                                                      disabled="{!OR(NonConformance.Closed__c,NonConformance.Workflow__c,NOT($ObjectType.Non_Conformance__c.Fields.Risk_Assessment_Required__c.updateable),AND(Non_Conformance__c.NC_Resolution_Code__c=='NC Workflow',Non_Conformance__c.NC_Status__c=='Reopened'))}"
                                   /> Browse From External System ? <br/>
                                   <button class="browse btn btn-primary" id="extCapaBtn" type="button" style="display:none" onClick="referToExternalCapa()"><i class="glyphicon glyphicon-search"></i> Browse</button>                             
                                  </div>
                               </apex:outputPanel>
                               
                             
                                <c:wiz_field FieldLabel="{!JSENCODE(IF(contains(customLabelKeys,'NC_Resolution_CAPA_Comment'),customLabels['NC_Resolution_CAPA_Comment'].Field_Label__c, $ObjectType.Non_Conformance__c.Fields.Resolution_CAPA_Comment__c.Label))}" required="false" jsid="resolution_capa_comments" wide="true">
                                  <c:wiz_richtext Rendered="{!NOT(OR(Non_Conformance__c.Closed__c,NonConformance.Workflow__c,NOT($ObjectType.Non_Conformance__c.Fields.Resolution_CAPA_Comment__c.updateable)))}"  FieldId="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Resolution_CAPA_Comment__c" initvalue="{!Non_Conformance__c.Resolution_CAPA_Comment__c}" Required="false" maxlength="4000"/>
                                   <apex:outputpanel rendered="{!OR(Non_Conformance__c.Closed__c,NonConformance.Workflow__c,NOT($ObjectType.Non_Conformance__c.Fields.Resolution_CAPA_Comment__c.updateable))}">
                                    <div class="alert alert-info" > <apex:outputField value="{!Non_Conformance__c.Resolution_CAPA_Comment__c}" /> </div>
                                  </apex:outputpanel>
                                </c:wiz_field>
                              
                                
                              </div>
                     </div>  
                 </div>    
             </div>            
                      
                    
                    
                    
                    
             </c:wiz_form> 
               <div class="tab-content col-md-12">
                      <div class="pageAdhoc" id="pageAdhoc">
                          <c:wiz_addadhoctask funcprefix="resAdhoc" status="{!JSENCODE(NonConformance.NC_Status__c)}" divfrom="pageAdhoc" adhocTaskList="{!adhocTasks}" divId="adhocDiv"  seqFieldId="adhocseq" userFieldId="adhocusr" allowDaysFieldId="adhocAllowed_Days__c" dueDateFieldId="adhocDue_Date__c" taskTitle="adhocTitle" isFieldRequired="false" typeOfUser="NC_Task_Owner" />
                      </div>
                      <!--Workflow -------------------------------------------------------------------->
                        <div role="tabpanel" class="tab-pane"  id="workflow_tab">
                        <br/>
                    <apex:repeat value="{!adhocTasks}" var="adt" rendered="{!OR(NonConformance.Workflow__c,NonConformance.Closed__c,NonConformance.NC_Status__c=='Reopened')}">
                              <c:wiz_displayadhoctasks taskTitle="{!JSENCODE(adt.AdhocTask_Title__c)}" seqInitValue="{!adt.Sequence_Position__c}"  userInitValue="{!JSENCODE(adt.Owner.Name)}" allowDaysInitValue="{!adt.Allowed_Days__c}" dueDateInitValue="{!adt.Due_Date__c}"/>
                          </apex:repeat>
                          
                          <c:wiz_task task="containment" taskTitle="Containment" seqFieldId="cont{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Sequence__c" seqInitValue="{!IF(ISBLANK(contTask.Sequence_Position__c),10,contTask.Sequence_Position__c)}" userFieldId="contUser" userInitValue="{value:'{!JSENCODE(contTask.OwnerId)}', label:'{!JSENCODE(contTask.Owner.Name)}'}" allowDaysFieldId="cont{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Allowed_Days__c" allowDaysInitValue="{!contTask.Allowed_Days__c}" dueDateFieldId="cont{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Due_Date__c" dueDateInitValue="{!contTask.Due_Date__c}"  ncCrDt="{!Non_Conformance__c.CreatedDate}"  isTaskChecked="{!hasContTask}" disabled="{!OR(NonConformance.Workflow__c,NonConformance.Closed__c,NonConformance.NC_Status__c=='Void',AND(NonConformance.NC_Resolution_Code__c=='NC Workflow',NonConformance.NC_Status__c=='Reopened'))}" typeoftaskowner="NC_Task_Owner">   </c:wiz_task>
                          
                          
                            <apex:variable value="{!0}" var="showdisposition" />
                            <apex:repeat value="{!Non_Conformance__c.NC_Products__r}">
                            <apex:variable value="{!showdisposition+1}" var="showdisposition" />
                            </apex:repeat>
                          <c:wiz_task rendered="{!(OR(Non_Conformance__c.Product__c!=null,showdisposition!=0))}" task="disposition" taskTitle="Disposition" seqFieldId="disp{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Sequence__c" seqInitValue="{!IF(ISBLANK(dispTask.Sequence_Position__c),20,dispTask.Sequence_Position__c)}" userFieldId="dispUser" userInitValue="{value:'{!JSENCODE(dispTask.OwnerId)}', label:'{!JSENCODE(dispTask.Owner.Name)}'}" allowDaysFieldId="disp{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Allowed_Days__c" allowDaysInitValue="{!dispTask.Allowed_Days__c}" dueDateFieldId="disp{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Due_Date__c" dueDateInitValue="{!dispTask.Due_Date__c}" ncCrDt="{!Non_Conformance__c.CreatedDate}"  isTaskChecked="{!hasDispTask}" disabled="{!OR(NonConformance.Workflow__c,NonConformance.Closed__c,NonConformance.NC_Status__c=='Void',AND(NonConformance.NC_Resolution_Code__c=='NC Workflow',NonConformance.NC_Status__c=='Reopened'))}" typeoftaskowner="NC_Task_Owner">  </c:wiz_task>
                          
                          <c:wiz_task task="investigation" taskTitle="Investigation" seqFieldId="inv{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Sequence__c" seqInitValue="{!IF(ISBLANK(invTask.Sequence_Position__c),30,invTask.Sequence_Position__c)}" userFieldId="invUser" userInitValue="{value:'{!JSENCODE(invTask.OwnerId)}', label:'{!JSENCODE(invTask.Owner.Name)}'}" allowDaysFieldId="inv{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Allowed_Days__c" allowDaysInitValue="{!invTask.Allowed_Days__c}" dueDateFieldId="inv{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Due_Date__c"  dueDateInitValue="{!invTask.Due_Date__c}" ncCrDt="{!Non_Conformance__c.CreatedDate}" isTaskChecked="{!hasInvTask}" disabled="{!OR(NonConformance.Workflow__c,NonConformance.Closed__c,NonConformance.NC_Status__c=='Void',AND(NonConformance.NC_Resolution_Code__c=='NC Workflow',NonConformance.NC_Status__c=='Reopened'))}" typeoftaskowner="NC_Task_Owner"> </c:wiz_task>
                          
                          <c:wiz_task task="implementation" taskTitle="Implementation" seqFieldId="impl{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Sequence__c" seqInitValue="{!IF(ISBLANK(implTask.Sequence_Position__c),40,implTask.Sequence_Position__c)}" userFieldId="implUser" userInitValue="{value:'{!JSENCODE(implTask.OwnerId)}', label:'{!JSENCODE(implTask.Owner.Name)}'}" allowDaysFieldId="impl{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Allowed_Days__c" allowDaysInitValue="{!implTask.Allowed_Days__c}" dueDateFieldId="impl{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Due_Date__c"  dueDateInitValue="{!implTask.Due_Date__c}" ncCrDt="{!Non_Conformance__c.CreatedDate}" isTaskChecked="{!hasImplTask}" disabled="{!OR(NonConformance.Workflow__c,NonConformance.Closed__c,NonConformance.NC_Status__c=='Void',AND(NonConformance.NC_Resolution_Code__c=='NC Workflow',NonConformance.NC_Status__c=='Reopened'))}" typeoftaskowner="NC_Task_Owner"> </c:wiz_task>

                          <!--   Selectable panes -->
                          <div id="closurePanel" class="panel panel-default panel-info">
                            <div class="panel-heading">Closure</div>
                            <div class="panel-body">
                                                            
                                                                <table class="table">
                                                                                <tbody>
                                                                                    <thead>
                                                                                        <tr>
                                                                                            <td width="40%"><span class="mandatory"><apex:outputtext value="*"/></span>&nbsp;&nbsp;Owner</td>
                                                                                            <td width="20%"><span class="mandatory"><apex:outputtext value="*"/></span>&nbsp;&nbsp;{!$ObjectType.General_Task__c.Fields.Allowed_Days__c.Label}</td>
                                                                                            <td><span class="mandatory"><apex:outputtext value="*"/></span>&nbsp;&nbsp;{!$ObjectType.General_Task__c.Fields.Due_Date__c.Label}</td>
                                                                                        </tr>
                                                                                    </thead>

                                                                                    <tbody>
                                                                                        <tr>
                                                                                            
                                                                                            <td>
                                                                                                   <c:wiz_multi width="100%" required="true"  disabled="{!OR(NonConformance.Workflow__c,NonConformance.Closed__c)}" FieldId="cloUser" multiple="false" queryFields="Name" querytable="User"
                                                                                                                     queryorderby="Id"
                                                                                                        initvalues="{value:'{!JSENCODE(closTask.OwnerId)}', label:'{!JSENCODE(closTask.Owner.Name)}'}" typeofuser="NC_Task_Owner"
                                                                                                        />
                                       
                                                                                               
                                                                                            </td>
                                                                                            <td>
                                                                                                <c:wiz_input disabled="{!OR(NonConformance.Workflow__c,NonConformance.Closed__c)}"  required="true" min="0" type="number" fieldname="closureAllowDaysFieldId" initvalue="{!closTask.Allowed_Days__c}"  onblur="autoCalculateDueDate(this,'cloDueDate','{!Non_Conformance__c.CreatedDate}')"></c:wiz_input>
                                                                                            </td>
                                                                                            <td>
                                                                                                <c:wiz_date maxdateallowed="{!month(today())}/{!day(today())}/{!year(today())+100}" FieldId="cloDueDate" initdate="{!closTask.Due_Date__c}" updateable="{!NOT(OR(NonConformance.Workflow__c,NonConformance.Closed__c))}"/>
                                                                                            </td>
                                                                                        </tr>
                                                                                    </tbody>
                                                                                </tbody>
                                                                            </table> 
                                                                            
                                
                              
                             
                              
                              <c:wiz_approval disabled="{!OR(NonConformance.Workflow__c,NonConformance.Closed__c,NonConformance.NC_Status__c=='Void',AND(NonConformance.NC_Resolution_Code__c=='NC Workflow',NonConformance.NC_Status__c=='Reopened'))}"  seqFieldId="closApprSeq" tableId="closApprTab" userFieldId="closApprUsr" allowDaysFieldId="closApprAllowed_Days__c" dueDateFieldId="closApprDue_Date__c" crDate="{!Non_Conformance__c.CreatedDate}" taskId="{!closTask.Id}" isApproverNoteNeeded="true" noteToApprover="{!closTask.Note_To_Approver__c}" isReloadNeeded="false" typeofapprover="NC_Approval" submitForm="ncForm"></c:wiz_approval>
                                                             
                              </div>  

                             

                          </div>
                         
                          <!--   Selectable panes -->
                        
                        
                        
                        
                        </div>
                        
                      <!--Workflow -------------------------------------------------------------------->
                      
                     
                      
                      
                     
                    
                    
                      
                    </div>        
                    </div>
             <script type="text/javascript">
               var errMsg='';
		       var months=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
		       $( document ).ready(function() {
		             $("#createadhoctask").hide();
		             if({!OR(NonConformance.Workflow__c,Non_Conformance__c.Closed__c,AND(NonConformance.NC_Resolution_Code__c=='NC Workflow',NonConformance.NC_Status__c=='Reopened'))})
		               $("#createadhoctask").attr('disabled','disabled');
		             $('#cloDueDate').datetimepicker({dayViewHeaderFormat: 'DD MMM YYYY', format: "DD MMM YYYY"}).on('dp.change',function(selected){
		                                                                                                                 //console.log('datetime picker change for  task selected.date '+selected.date);
		                                                                                                                 var selectedDate=new Date(selected.date);
		                                                                                                                 selectedDate=new Date(selectedDate.getDate()+' '+months[selectedDate.getMonth()]+' '+selectedDate.getFullYear());
		                                                                                                                 var difMS=selectedDate-new Date("{!NonConformance.CreatedDate}");
		                                                                                                                 console.log('(difMS/(1000*60*60*24)   '+(difMS/(1000*60*60*24)));
		                                                                                                                 var difDays=Math.ceil(difMS/(1000*60*60*24));
		                                                                                                                 $("#closureAllowDaysFieldId").val(difDays);
		                                                                                                                 $('#'+this.id+'_hidden').val(selectedDate);
		                                                                                                           });
		             $("#cloDueDate").data("DateTimePicker").minDate(new Date("{!NonConformance.CreatedDate}"));
		                                 
		             $(".workflow-panel").removeClass('panel-info').children().find('table').find("input,select").each(function(){
		                                                                                      $(this).attr('disabled', true);
		                     //console.log(this);
		                 });
		            console.log("closure Task note approver {!JSENCODE(closTask.Note_To_Approver__c)}");
		        });
             </script>
         </apex:outputPanel>
         <!-- End : Resolution -->
         
         <!-- Begin : Reference -->
          <apex:outputPanel rendered="{!$CurrentPage.parameters.pg=='nc_reference'}">
             <h2>References</h2>
             <table class="table table-hover table-condensed">
                 <tbody id="ncRefBody">
                     
                     <tr>
                         <th>Number</th>
                         <th>Title</th>
                         <th>Owner</th>
                         <th>Source</th>
                         <th>Status</th>
                     </tr>
                     <apex:repeat value="{!ncReferences}" var="ncRef">
                         <tr id="{!JSENCODE(ncRef.CAPA__c)}">
                             <td><a href='/{!JSENCODE(ncRef.CAPA__c)}'>{!JSENCODE(ncRef.CAPA__r.Name)}</a></td>
                             <td>{!JSENCODE(ncRef.CAPA__r.Title__c)}</td>
                             <td>{!JSENCODE(ncRef.CAPA__r.Owner.Name)}</td>
                             <td>{!JSENCODE(ncRef.CAPA__r.CAPA_Source__c)}</td>
                             <td>{!JSENCODE(ncRef.CAPA__r.CAPA_Status__c)}</td>
                        </tr>
                         
                     </apex:repeat> 
                 </tbody>
             </table>
         </apex:outputPanel>   
         
         <!--End : Reference -->
         
         <!-- Begin :Details -->
         <apex:outputPanel rendered="{!$CurrentPage.parameters.pg=='nc_details'}">
           <div class="col-md-12">
                
                
                <input type="hidden" name="page" id="page" value="nc_details"/>
                <input type="hidden" id="stepName" name="stepName" value="Details" />
                
                <div class="print-only ">
                    <img src ="{! URLFOR($Resource.bt_static,'/static/images/report-logo.png') }" class="report-logo"/>
                </div>
                
                <div class="print-only ">
                    
                    <h1><apex:outputText value="{!JSENCODE(IF(contains(customLabelKeys,'NC_Header_Section'),customLabels['NC_Header_Section'].Section_Label__c, 'Header'))}"/></h1>
                    <table class="table table-responsive table-bordered">
                        <tbody>
                            <tr>
                                <th>NC No.</th>
                                <th>NC Status</th>
                                <th>NC Owner</th>
                                <th>NC Life</th>
                                <th>NC Type</th>
                                <th>Initiating Site</th>
                            </tr>
                            
                            <tr>
                                <td>{!NonConformance.Name}</td>
                                <td>{!NonConformance.NC_Status__c}</td>
                                <td>{!NonConformance.Owner.Name}</td>
                                <td>{!NonConformance.Age__c} Day{!if(VALUE(NonConformance.Age__c)!=1,'s','')}</td>
                                <td>{!NonConformance.NC_Type__c}</td>
                                <td>{!NonConformance.Initiating_Site_name__c}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>  
                
                
                
                <apex:outputPanel layout="none" rendered="{!OR($ObjectType.Non_Conformance__c.Fields.NC_Type__c.Accessible,$ObjectType.Non_Conformance__c.Fields.Product__c.Accessible,$ObjectType.Non_Conformance__c.Fields.Process__c.Accessible,$ObjectType.Non_Conformance__c.Fields.Defect__c.Accessible,$ObjectType.Non_Conformance__c.Fields.Full_Description__c.accessible,$ObjectType.Non_Conformance__c.Fields.Occurance_Date__c.accessible,$ObjectType.Non_Conformance__c.Fields.Reported_Date__c.accessible,$ObjectType.Non_Conformance__c.Fields.Reporter__c.accessible,$ObjectType.Non_Conformance__c.FIelds.Department__c.Accessible,$ObjectType.Non_Conformance__c.FIelds.OwnerId.Accessible)}">
                
                <h1><apex:outputText value="{!JSENCODE(IF(contains(customLabelKeys,'NC_Init_Section'),customLabels['NC_Init_Section'].Section_Label__c, 'Initiation'))}"/></h1>
                
                <table class="table table-responsive table-bordered">
                    <tbody>
                       <apex:outputPanel rendered="{!$ObjectType.Non_Conformance__c.Fields.NC_Type__c.Accessible}"> 
                        <tr>
                          
                            <td class="title-col">
                                <apex:outputText value="{!JSENCODE(IF(contains(customLabelKeys,'NC_Type'),customLabels['NC_Type'].Field_Label__c, $ObjectType.Non_Conformance__c.Fields.NC_Type__c.Label))}"/>
                            </td>
                            <td>
                                {!NonConformance.NC_Type__c}
                            </td>
                          
                        </tr>
                        </apex:outputPanel>
                        <tr>
                            <td class="title-col">
                                <apex:outputText value="{!JSENCODE(IF(contains(customLabelKeys,'NC_Product'),customLabels['NC_Product'].Field_Label__c, $ObjectType.Non_Conformance__c.Fields.Product__c.Label))}" rendered="{!AND($ObjectType.Non_Conformance__c.Fields.Product__c.Accessible,NonConformance.NC_Type__c == 'Product')}"/>
                                <apex:outputText value="{!JSENCODE(IF(contains(customLabelKeys,'NC_Process'),customLabels['NC_Process'].Field_Label__c, $ObjectType.Non_Conformance__c.Fields.Process__c.Label))}" rendered="{!AND($ObjectType.Non_Conformance__c.Fields.Process__c.Accessible,NonConformance.NC_Type__c == 'Process')}"/>
                            </td>
                            <td>
                                <apex:outputField value="{!NonConformance.Product__r.Name}" rendered="{!AND($ObjectType.Non_Conformance__c.Fields.Product__c.Accessible,NonConformance.NC_Type__c == 'Product')}"/>
                                <apex:outputField value="{!NonConformance.Process__r.Name}" rendered="{!AND($ObjectType.Non_Conformance__c.Fields.Process__c.Accessible,NonConformance.NC_Type__c == 'Process')}"/>
                            </td>
                        </tr>
                         <apex:outputPanel rendered="{!$ObjectType.Non_Conformance__c.Fields.Defect__c.Accessible}">
                        <tr>
                         
                            <td class="title-col">
                                <apex:outputText value="{!JSENCODE(IF(contains(customLabelKeys,'NC_Defect'),customLabels['NC_Defect'].Field_Label__c, $ObjectType.Non_Conformance__c.Fields.Defect__c.Label))}"/> 
                            </td>
                            <td>
                                {!NonConformance.Defect__r.Name}
                            </td>
                        </tr>
                        </apex:outputPanel>
                        <apex:outputPanel rendered="{!$ObjectType.Non_Conformance__c.Fields.Full_Description__c.Accessible}">
                        <tr>
                            <td class="title-col">
                                <apex:outputText value="{!JSENCODE(IF(contains(customLabelKeys,'NC_Full_Description'),customLabels['NC_Full_Description'].Field_Label__c, $ObjectType.Non_Conformance__c.Fields.Full_Description__c.Label))}"/>
                            </td>
                            <td>
                                <div class="alert alert-info"> <apex:outputField value="{!NonConformance.Full_Description__c}" /> </div>
                            </td>
                        </tr>
                        </apex:outputPanel>
                        <apex:outputPanel rendered="{!$ObjectType.Non_Conformance__c.Fields.Occurance_Date__c.Accessible}">
                        <tr>
                            <td class="title-col">
                                <apex:outputText value="{!JSENCODE(IF(contains(customLabelKeys,'NC_Occurance_Date'),customLabels['NC_Occurance_Date'].Field_Label__c, $ObjectType.Non_Conformance__c.Fields.Occurance_Date__c.Label))}"/> 
                            </td>
                            <td>
                                <apex:outputText value="{0,date, dd MMMM yyyy}"> <!-- TODO: Make this dependent on Org settings so that date format can be updated from a central location -->
                                    <apex:param value="{!NonConformance.Occurance_Date__c}"/>
                                </apex:outputText>
                            </td>
                        </tr>
                       </apex:outputPanel>
                       <apex:outputPanel rendered="{!$ObjectType.Non_Conformance__c.Fields.Reported_Date__c.Accessible}">
                        <tr>
                            <td class="title-col">
                                <apex:outputText value="{!JSENCODE(IF(contains(customLabelKeys,'NC_Reported_Date'),customLabels['NC_Reported_Date'].Field_Label__c, $ObjectType.Non_Conformance__c.Fields.Reported_Date__c.Label))}"/>
                            </td>
                            <td>
                                <apex:outputText value="{0,date, dd MMMM yyyy}"> <!-- TODO: Make this dependent on Org settings so that date format can be updated from a central location -->
                                    <apex:param value="{!NonConformance.Reported_Date__c}"/>
                                </apex:outputText>
                            </td>
                        </tr>
                        </apex:outputPanel>
                        <apex:outputPanel rendered="{!$ObjectType.Non_Conformance__c.Fields.Reporter__c.Accessible}">
                        <tr>
                            <td class="title-col">
                                <apex:outputText value="{!JSENCODE(IF(contains(customLabelKeys,'NC_Reporter'),customLabels['NC_Reporter'].Field_Label__c, $ObjectType.Non_Conformance__c.Fields.Reporter__c.Label))}"/>
                            </td>
                            <td>
                                {!NonConformance.Reporter__r.Name}
                            </td>
                        </tr>
                       </apex:outputPanel>
                       <apex:outputPanel rendered="{!$ObjectType.Non_Conformance__c.Fields.OwnerId.Accessible}">
                        <tr>
                            <td class="title-col">
                                <apex:outputText value="{!JSENCODE(IF(contains(customLabelKeys,'NC_Owner'),customLabels['NC_Owner'].Field_Label__c,'Owner'))}"/>
                            </td>
                            <td> <!-- TODO: Need to decided which field represents the NC Owner. -->
                                {!IF(ISBLANK(NonConformance.OwnerId), $User.FirstName + ' ' + $User.LastName, NonConformance.Owner.Name)}
                            </td>
                        </tr>
                      </apex:outputPanel>
                    </tbody>
                </table> 
                </apex:outputPanel>
                
                <apex:outputPanel layout="none" rendered="{!OR($ObjectType.Non_Conformance__c.Fields.Department__c.Accessible,$ObjectType.Non_Conformance__c.Fields.Customer__c.Accessible,$ObjectType.Non_Conformance__c.Fields.BusinessUnit__c.Accessible,$ObjectType.Non_Conformance__c.Fields.Manufacturer_Supplier__c.Accessible,$ObjectType.Non_Conformance__c.Fields.NC_Source__c.accessible,$ObjectType.Non_Conformance__c.Fields.Supplier_Manufacturer_Part__c.accessible,$ObjectType.Non_Conformance__c.Fields.Audit__c.accessible,$ObjectType.Non_Conformance__c.Fields.PO_Number__c.accessible,$ObjectType.Non_Conformance__c.FIelds.Priority__c.Accessible,$ObjectType.Non_Conformance__c.FIelds.Other_Source__c.Accessible)}">
                <h1><apex:outputText value="{!JSENCODE(IF(contains(customLabelKeys,'NC_Cust_Field_Sec'),customLabels['NC_Add_Info_Section'].Section_Label__c, 'Additional Information'))}"/></h1>
                
                <table class="table table-responsive table-bordered">
                    <tbody>
                        
                        <tr>
                        <apex:outputPanel rendered="{!$ObjectType.Non_Conformance__c.Fields.Department__c.Accessible}">
                            <td class="title-col">
                                <apex:outputText value="{!JSENCODE(IF(contains(customLabelKeys,'NC_Department'),customLabels['NC_Department'].Field_Label__c, $ObjectType.Non_Conformance__c.Fields.Department__c.Label))}"/> 
                            </td>
                            <td style="width: 30%">
                                {!NonConformance.Department__r.Name}
                            </td>
                        </apex:outputPanel>
                        <apex:outputPanel rendered="{!$ObjectType.Non_Conformance__c.Fields.Customer__c.Accessible}">
                            <td class="title-col">
                                <apex:outputText value="{!JSENCODE(IF(contains(customLabelKeys,'NC_Customer'),customLabels['NC_Customer'].Field_Label__c, $ObjectType.Non_Conformance__c.Fields.Customer__c.Label))}"/>
                            </td>
                            <td style="width: 30%">
                                {!NonConformance.Customer__r.Name}
                            </td>
                         </apex:outputPanel>
                        </tr>
                        
                        <tr>
                           <apex:outputPanel rendered="{!$ObjectType.Non_Conformance__c.Fields.BusinessUnit__c.Accessible}">
                            <td class="title-col">
                                <apex:outputText value="{!JSENCODE(IF(contains(customLabelKeys,'NC_Business_Unit'),customLabels['NC_Business_Unit'].Field_Label__c, $ObjectType.Non_Conformance__c.Fields.BusinessUnit__c.Label))}"/>
                            </td>
                            <td>
                                {!NonConformance.BusinessUnit__c} 
                            </td>
                            </apex:outputPanel>
                            <apex:outputPanel rendered="{!$ObjectType.Non_Conformance__c.Fields.Manufacturer_Supplier__c.Accessible}">
                            <td class="title-col">
                                <apex:outputText value="{!JSENCODE(IF(contains(customLabelKeys,'NC_Manufacturer_Supplier'),customLabels['NC_Manufacturer_Supplier'].Field_Label__c, $ObjectType.Non_Conformance__c.Fields.Manufacturer_Supplier__c.Label))}"/> 
                            </td>
                            <td>
                                {!NonConformance.Manufacturer_Supplier__r.Name}
                            </td>
                           </apex:outputPanel>
                        </tr>
                        
                        <tr>
                          <apex:outputPanel rendered="{!$ObjectType.Non_Conformance__c.Fields.NC_Source__c.Accessible}">
                            <td class="title-col">
                                <apex:outputText value="{!JSENCODE(IF(contains(customLabelKeys,'NC_Source'),customLabels['NC_Source'].Field_Label__c, $ObjectType.Non_Conformance__c.Fields.NC_Source__c.Label))}"/> 
                            </td>
                            <td>
                                {!NonConformance.NC_Source__c}
                            </td>
                           </apex:outputPanel>
                           <apex:outputPanel rendered="{!$ObjectType.Non_Conformance__c.Fields.Supplier_Manufacturer_Part__c.Accessible}">
                            <td class="title-col">
                                <apex:outputText value="{!JSENCODE(IF(contains(customLabelKeys,'NC_Supplier_Manufacturer_Part'),customLabels['NC_Supplier_Manufacturer_Part'].Field_Label__c, $ObjectType.Non_Conformance__c.Fields.Supplier_Manufacturer_Part__c.Label))}"/> 
                            </td>
                            <td>
                                {!NonConformance.Supplier_Manufacturer_Part__c}
                            </td>
                            </apex:outputPanel>
                        </tr>
                        
                        <tr>
                          <apex:outputPanel rendered="{!$ObjectType.Non_Conformance__c.Fields.Audit__c.Accessible}">
                            <td class="title-col">
                                <apex:outputText value="{!JSENCODE(IF(contains(customLabelKeys,'NC_Audit'),customLabels['NC_Audit'].Field_Label__c, $ObjectType.Non_Conformance__c.Fields.Audit__c.Label))}"/> 
                            </td>
                            <td>
                                {!NonConformance.Audit__c}
                            </td>
                           </apex:outputPanel>
                           <apex:outputPanel rendered="{!$ObjectType.Non_Conformance__c.Fields.PO_Number__c.Accessible}">
                            <td class="title-col">
                                <apex:outputText value="{!JSENCODE(IF(contains(customLabelKeys,'NC_PO_Number'),customLabels['NC_PO_Number'].Field_Label__c, $ObjectType.Non_Conformance__c.Fields.PO_Number__c.Label))}"/>
                            </td>
                            <td>
                                {!NonConformance.PO_Number__c}
                            </td>
                            </apex:outputPanel>
                        </tr>
                        <tr>
                         <apex:outputPanel rendered="{!$ObjectType.Non_Conformance__c.Fields.Priority__c.Accessible}">
                            <td class="title-col">
                                <apex:outputText value="{!JSENCODE(IF(contains(customLabelKeys,'NC_Priority'),customLabels['NC_Priority'].Field_Label__c, $ObjectType.Non_Conformance__c.Fields.Priority__c.Label))}"/>
                            </td>
                            <td>
                                {!NonConformance.Priority__c}
                            </td>
                          </apex:outputPanel>
                          <apex:outputPanel rendered="{!$ObjectType.Non_Conformance__c.Fields.Other_Source__c.Accessible}">
                            <td class="title-col">
                                <apex:outputText value="{!JSENCODE(IF(contains(customLabelKeys,'NC_Other_Source'),customLabels['NC_Other_Source'].Field_Label__c, $ObjectType.Non_Conformance__c.Fields.Other_Source__c.Label))}"/>
                            </td>
                            <td>
                                {!JSENCODE(NonConformance.Other_Source__c)}
                            </td>
                           </apex:outputPanel>
                        </tr>
                        
                    </tbody>
                </table>
                </apex:outputPanel>
                                <!-------------custom fields using custom setting----------->
                 <div class="clearfix"></div>

                <apex:outputPanel layout="none" rendered="{!OR($ObjectType.Non_Conformance__c.Fields.UD_Text1__c.Accessible,$ObjectType.Non_Conformance__c.Fields.UD_Text2__c.Accessible,$ObjectType.Non_Conformance__c.Fields.UD_Picklist3__c.Accessible,$ObjectType.Non_Conformance__c.Fields.UD_Picklist4__c.Accessible,$ObjectType.Non_Conformance__c.Fields.UD_Text_Area5__c.accessible,$ObjectType.Non_Conformance__c.Fields.UD_Text_Area6__c.accessible,$ObjectType.Non_Conformance__c.Fields.UD_Long_Text_Area7__c.accessible,$ObjectType.Non_Conformance__c.Fields.UD_Long_Text_Area8__c.accessible,$ObjectType.Non_Conformance__c.FIelds.UD_Date9__c.Accessible,$ObjectType.Non_Conformance__c.FIelds.UD_Date10__c.Accessible)}">
                    <h1><apex:outputText value="{!JSENCODE(IF(contains(customLabelKeys,'NC_Cust_Field_Sec'),customLabels['NC_Cust_Field_Sec'].Section_Label__c, 'Custom Field Details'))}"/></h1>
                    
                    <table class="table table-responsive table-bordered">
                        <tbody>
                            
                            <tr>
                                <apex:outputPanel rendered="{!$ObjectType.Non_Conformance__c.Fields.UD_Text1__c.Accessible}">
                                    <td class="title-col">
                                        <apex:outputText value="{!JSENCODE(IF(contains(customLabelKeys,'NC_UD_Text1'),customLabels['NC_UD_Text1'].Field_Label__c, $ObjectType.Non_Conformance__c.Fields.UD_Text1__c.Label))}"/>
                                    </td>
                                    <td style="width: 30%">
                                        {!JSENCODE(NonConformance.UD_Text1__c)}
                                    </td>
                                </apex:outputPanel>
                                <apex:outputPanel rendered="{!$ObjectType.Non_Conformance__c.Fields.UD_Text2__c.Accessible}">
                                    <td class="title-col">
                                        <apex:outputText value="{!JSENCODE(IF(contains(customLabelKeys,'NC_UD_Text2'),customLabels['NC_UD_Text2'].Field_Label__c, $ObjectType.Non_Conformance__c.Fields.UD_Text2__c.Label))}"/>
                                    </td>
                                    <td style="width: 30%">
                                        {!JSENCODE(NonConformance.UD_Text2__c)}
                                    </td>
                                </apex:outputPanel>
                                                                

                            </tr>
                            
                            <tr>
                                <apex:outputPanel rendered="{!$ObjectType.Non_Conformance__c.Fields.UD_Picklist3__c.Accessible}">
                                    <td class="title-col">
                                        <apex:outputText value="{!JSENCODE(IF(contains(customLabelKeys,'NC_UD_Picklist3'),customLabels['NC_UD_Picklist3'].Field_Label__c, $ObjectType.Non_Conformance__c.Fields.UD_Picklist3__c.Label))}"/>
                                    </td>
                                    <td>
                                        {!NonConformance.UD_Picklist3__c} 
                                    </td>
                                </apex:outputPanel>                                

                                <apex:outputPanel rendered="{!$ObjectType.Non_Conformance__c.Fields.UD_Picklist4__c.Accessible}">
                                    <td class="title-col">
                                        <apex:outputText value="{!JSENCODE(IF(contains(customLabelKeys,'NC_UD_Picklist4'),customLabels['NC_UD_Picklist4'].Field_Label__c, $ObjectType.Non_Conformance__c.Fields.UD_Picklist4__c.Label))}"/> 
                                    </td>
                                    <td>
                                        {!NonConformance.UD_Picklist4__c}
                                    </td>
                                </apex:outputPanel>
                            </tr>
                            
                            <tr>
                                <apex:outputPanel rendered="{!$ObjectType.Non_Conformance__c.Fields.UD_Text_Area5__c.Accessible}">
                                    <td class="title-col">
                                        <apex:outputText value="{!JSENCODE(IF(contains(customLabelKeys,'NC_UD_Text_Area5'),customLabels['NC_UD_Text_Area5'].Field_Label__c, $ObjectType.Non_Conformance__c.Fields.UD_Text_Area5__c.Label))}"/>
                                    </td>
                                    <td>
                                        <apex:outputField value="{!NonConformance.UD_Text_Area5__c}" />
                                    </td>
                                </apex:outputPanel>
                                <apex:outputPanel rendered="{!$ObjectType.Non_Conformance__c.Fields.UD_Text_Area6__c.Accessible}">
                                    <td class="title-col">
                                        <apex:outputText value="{!JSENCODE(IF(contains(customLabelKeys,'NC_UD_Text_Area6'),customLabels['NC_UD_Text_Area6'].Field_Label__c, $ObjectType.Non_Conformance__c.Fields.UD_Text_Area6__c.Label))}"/> 
                                    </td>
                                    <td>
                                        <apex:outputField value="{!NonConformance.UD_Text_Area6__c}" />
                                    </td>
                                </apex:outputPanel>
                            </tr>
                            
                            <tr>
                                <apex:outputPanel rendered="{!$ObjectType.Non_Conformance__c.Fields.UD_Long_Text_Area7__c.Accessible}">
                                    <td class="title-col">
                                        <apex:outputText value="{!JSENCODE(IF(contains(customLabelKeys,'NC_UD_Long_Text_Area7'),customLabels['NC_UD_Long_Text_Area7'].Field_Label__c, $ObjectType.Non_Conformance__c.Fields.UD_Long_Text_Area7__c.Label))}"/> 
                                    </td>
                                    <td>
                                        <apex:outputField value="{!NonConformance.UD_Long_Text_Area7__c}" />
                                    </td>
                                </apex:outputPanel>
                                <apex:outputPanel rendered="{!$ObjectType.Non_Conformance__c.Fields.UD_Long_Text_Area8__c.Accessible}">
                                    <td class="title-col">
                                        <apex:outputText value="{!JSENCODE(IF(contains(customLabelKeys,'NC_UD_Long_Text_Area8'),customLabels['NC_UD_Long_Text_Area8'].Field_Label__c, $ObjectType.Non_Conformance__c.Fields.UD_Long_Text_Area8__c.Label))}"/>
                                    </td>
                                    <td>
                                        <apex:outputField value="{!NonConformance.UD_Long_Text_Area8__c}" /> 
                                    </td>
                                </apex:outputPanel>
                            </tr>
                            <tr>
                                <apex:outputPanel rendered="{!$ObjectType.Non_Conformance__c.Fields.UD_Date9__c.Accessible}">
                                    <td class="title-col">
                                        <apex:outputText value="{!JSENCODE(IF(contains(customLabelKeys,'NC_UD_Date9'),customLabels['NC_UD_Date9'].Field_Label__c, $ObjectType.Non_Conformance__c.Fields.UD_Date9__c.Label))}"/>
                                    </td>
                                    <td>
                                        <apex:outputText value="{0,date, dd MMMM yyyy}"><!-- TODO: Make this dependent on Org settings so that date format can be updated from a central location -->
                                            <apex:param value="{!NonConformance.UD_Date9__c}"/>
                                        </apex:outputText>
                                    </td>
                                </apex:outputPanel>
                                <apex:outputPanel rendered="{!$ObjectType.Non_Conformance__c.Fields.UD_Date10__c.Accessible}">
                                    <td class="title-col">
                                       <apex:outputText value="{!JSENCODE(IF(contains(customLabelKeys,'NC_UD_Date10'),customLabels['NC_UD_Date10'].Field_Label__c, $ObjectType.Non_Conformance__c.Fields.UD_Date10__c.Label))}"/>
                                    </td>
                                    <td>
                                        <apex:outputText value="{0,date, dd MMMM yyyy}"> <!-- TODO: Make this dependent on Org settings so that date format can be updated from a central location -->
                                            <apex:param value="{!NonConformance.UD_Date10__c}"/>
                                        </apex:outputText>
                                    </td>
                                </apex:outputPanel>
                            </tr>
                        </tbody>
                    </table>
                </apex:outputPanel>
                                <apex:outputPanel rendered="{!$ObjectType.Non_Conformance__c.FieldSets.NC_CustomFields.size!=0}">
                    <table class="table table-responsive table-bordered">
                        <tbody>
                            <apex:repeat value="{!$ObjectType.Non_Conformance__c.FieldSets.NC_CustomFields}" var="f">
                              <apex:outputPanel rendered="{!$ObjectType.Non_Conformance__c.Fields[f].Accessible}">
                                <tr>
                                    <td class="title-col">
                                      {!$ObjectType.Non_Conformance__c.Fields[f].label}
                                    </td>
                                    <td>
                                        <apex:outputPanel rendered="{!$ObjectType.Non_Conformance__c.Fields[f].type=='textarea'}">
                                            <div class="alert alert-info"> <apex:outputField value="{!NonConformance[f]}" /> </div>
                                        </apex:outputPanel>
                                        <apex:outputPanel rendered="{!$ObjectType.Non_Conformance__c.Fields[f].type=='date'}">
                                            <apex:outputText value="{0,date, dd MMMM yyyy}"> 
                                                <apex:param value="{!NonConformance[f]}"/>
                                            </apex:outputText>
                                        </apex:outputPanel>
                                        <apex:outputPanel rendered="{!NOT(OR($ObjectType.Non_Conformance__c.Fields[f].type=='date',$ObjectType.Non_Conformance__c.Fields[f].type=='reference',$ObjectType.Non_Conformance__c.Fields[f].type=='textarea'))}">
                                            {!JSENCODE(NonConformance[f])}
                                        </apex:outputPanel>
                                        <apex:outputPanel rendered="{!$ObjectType.Non_Conformance__c.Fields[f].type=='reference'}">
                                        	!JSENCODE(NonConformance[$ObjectType.Non_Conformance__c.Fields[f].relationshipName])}
                                        </apex:outputPanel>
                                    </td>
                                </tr>                                
                              </apex:outputPanel>  
                            </apex:repeat>
                        </tbody>
                    </table>
                </apex:outputPanel>    

                <!------------------custom fields using custom setting--END--------->
                <div class="page-break"></div>
                
                <!-- <h1>Products {!$CurrentPage.Name}{!(IF(NOT(ISBLANK(Prefix)),Prefix+'__nc_details','nc_details'))}</h1> -->
                <h1><apex:outputText value="{!JSENCODE(IF(contains(customLabelKeys,'NC_Prod_Section'),customLabels['NC_Prod_Section'].Section_Label__c, 'Products'))}"/></h1>
                <!-- TODO: Expand/Collapse behavior is inconsistent.  Expanding second collapses top but not vice versa. -->
                <apex:repeat value="{!Non_Conformance__c.NC_Products__r}" var="p">
                    <c:wiz_added_Product recordid="{!p.id}" notDetails="false" editable="false"/>
                </apex:repeat>
                <!---------------------start- new nc details---------->
                <apex:outputPanel layout="none" rendered="{!OR($ObjectType.Non_Conformance__c.Fields.Risk_Severity__c.Accessible,$ObjectType.Non_Conformance__c.Fields.Risk_Occurrence__c.Accessible,$ObjectType.Non_Conformance__c.Fields.CAPA_Required__c.Accessible,$ObjectType.Non_Conformance__c.Fields.Risk_Description__c.accessible,$ObjectType.Non_Conformance__c.Fields.Justification_for_CAPA_no_CAPA__c.accessible)}">
                <div class="panel-group screen-only" id="accordion" role="tablist" aria-multiselectable="true">
                    <div class="panel panel-default">
                        <div class="panel-heading" role="tab" id="headingRiskAssessment">
                            <h4 class="panel-title">
                                
                                <a class="btn btn-link btn-xs pull-right" data-toggle="collapse" data-parent="#accordion" href="#collapseRiskAssessment" aria-expanded="true" aria-controls="collapseRiskAssessment">
                                    <span class="glyphicon glyphicon-chevron-down" aria-hidden="true"></span>
                                </a>                            
                                
                                
                                <a data-toggle="collapse" data-parent="#accordion" href="#collapseRiskAssessment" aria-expanded="true" aria-controls="collapseRiskAssessment">
                                    <apex:outputpanel layout="none" rendered="{!AND($ObjectType.Non_Conformance__c.Fields.Risk_Assessment_Required__c.Accessible,NonConformance.Risk_Assessment_Required__c == 'No')}">
                                        Risk Assessment Not Required
                                    </apex:outputpanel>
                                    <apex:outputpanel layout="none" rendered="{!AND($ObjectType.Non_Conformance__c.Fields.Risk_Assessment_Required__c.Accessible,NonConformance.Risk_Assessment_Required__c == 'Yes')}">
                                        Risk Assessment Required
                                    </apex:outputpanel>
                                </a>
                            </h4>
                        </div>
                        
                        
                        
                        <div id="collapseRiskAssessment" class="panel-collapse collapse out" role="tabpanel" aria-labelledby="headingRiskAssessment">
                            <div class="panel-body">                        
                                <div class="add-contain-wrapper added-containment-action screen-only">
                                    <div class="add-containment">
                                        
                                        <table class="table table-responsive table-bordered">
                                            <tbody>
                                                <apex:outputPanel rendered="{!$ObjectType.Non_Conformance__c.Fields.Risk_Severity__c.Accessible}">
                                                <tr>
                                                    <td class="title-col" style="width: 20%">
                                                        <apex:outputText value="{!JSENCODE(IF(contains(customLabelKeys,'NC_Risk_Severity'),customLabels['NC_Risk_Severity'].Field_Label__c, $ObjectType.Non_Conformance__c.Fields.Risk_Severity__c.Label))}"/>
                                                    </td>
                                                    <td>
                                                        {!NonConformance.Risk_Severity__r.Name}
                                                    </td>
                                                </tr>
                                                </apex:outputPanel>
                                                <apex:outputPanel rendered="{!$ObjectType.Non_Conformance__c.Fields.Risk_Occurrence__c.Accessible}">
                                                <tr>
                                                    <td class="title-col">
                                                        <apex:outputText value="{!JSENCODE(IF(contains(customLabelKeys,'NC_Risk_Occurrence'),customLabels['NC_Risk_Occurrence'].Field_Label__c, $ObjectType.Non_Conformance__c.Fields.Risk_Occurrence__c.Label))}"/> 
                                                    </td>
                                                    <td>
                                                        {!NonConformance.Risk_Occurrence__r.Name} 
                                                    </td>
                                                </tr>
                                                </apex:outputPanel>
                                                <apex:outputPanel rendered="{!$ObjectType.Non_Conformance__c.Fields.Risk_Priority__c.Accessible}">
                                                <tr>
                                                    <td class="title-col">
                                                       <apex:outputText value="{!JSENCODE(IF(contains(customLabelKeys,'NC_Risk_Priority'),customLabels['NC_Risk_Priority'].Field_Label__c, $ObjectType.Non_Conformance__c.Fields.Risk_Priority__c.Label))}"/>
                                                    </td>
                                                    <td>
                                                        {!NonConformance.Risk_Priority__r.Name}
                                                    </td>
                                                </tr>
                                                </apex:outputPanel>
                                                <apex:outputPanel rendered="{!$ObjectType.Non_Conformance__c.Fields.CAPA_Required__c.Accessible}">
                                                <tr>
                                                    <td class="title-col">
                                                        <apex:outputText value="{!JSENCODE(IF(contains(customLabelKeys,'NC_CAPA_Required'),customLabels['NC_CAPA_Required'].Field_Label__c, $ObjectType.Non_Conformance__c.Fields.CAPA_Required__c.Label))}"/>
                                                    </td>
                                                    <td>
                                                        {!NonConformance.CAPA_Required__c}
                                                    </td>
                                                </tr>
                                                </apex:outputPanel>
                                                <apex:outputPanel rendered="{!$ObjectType.Non_Conformance__c.Fields.Risk_Description__c.Accessible}">
                                                <tr>
                                                
                                                    <td class="title-col">
                                                        <apex:outputText value="{!JSENCODE(IF(contains(customLabelKeys,'NC_Risk_Description'),customLabels['NC_Risk_Description'].Field_Label__c, $ObjectType.Non_Conformance__c.Fields.Risk_Description__c.Label))}"/> 
                                                    </td>
                                                    <td>
                                                        <div class="alert alert-info"> <apex:outputField value="{!NonConformance.Risk_Description__c}" /> </div>
                                                        
                                                    </td>
                                                </tr>
                                                </apex:outputPanel>
                                                <apex:outputPanel rendered="{!$ObjectType.Non_Conformance__c.Fields.Justification_for_CAPA_no_CAPA__c.Accessible}">
                                                <tr>
                                                    <td class="title-col">
                                                        <apex:outputText value="{!JSENCODE(IF(contains(customLabelKeys,'NC_Just_No_CAPA'),customLabels['NC_Just_No_CAPA'].Field_Label__c, $ObjectType.Non_Conformance__c.Fields.Justification_for_CAPA_no_CAPA__c.Label))}"/> 
                                                    </td>
                                                    <td>
                                                        <div class="alert alert-info"> <apex:outputField value="{!NonConformance.Justification_for_CAPA_no_CAPA__c}" /> </div>
                                                    </td>
                                                </tr>
                                                </apex:outputPanel>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                
                            </div>
                            
                        </div>
                    </div>
                </div>                                    
                </apex:outputPanel>
                <div class="page-break"></div>
                <apex:outputPanel rendered="{!$ObjectType.Non_Conformance__c.Fields.NC_Resolution_Code__c.Accessible}">
                <div class="panel-group screen-only" id="accordion" role="tablist" aria-multiselectable="true">
                    <div class="panel panel-default">
                        <div class="panel-heading" role="tab" id="headingNCResolutionCode">
                            <h4 class="panel-title">
                                <a class="btn btn-link btn-xs pull-right" data-toggle="collapse" data-parent="#accordion" href="#collapseNCResolutionCode" aria-expanded="true" aria-controls="collapseNCResolutionCode">
                                    <span class="glyphicon glyphicon-chevron-down" aria-hidden="true"></span>
                                </a>                            
                                
                                
                                <a data-toggle="collapse" data-parent="#accordion" href="#collapseNCResolutionCode" aria-expanded="true" aria-controls="collapseNCResolutionCode">
                                    Resolution({!NonConformance.NC_Resolution_Code__c})
                                </a>
                            </h4> 
                        </div>            
                        
                        <div id="collapseNCResolutionCode" class="panel-collapse collapse out" role="tabpanel" aria-labelledby="headingNCResolutionCode">
                            <div class="panel-body">                        
                                <div class="add-contain-wrapper added-containment-action screen-only">
                                    <div class="add-containment">                    
                                        
                                        <apex:outputPanel rendered="{!if(OR(NonConformance.NC_Resolution_Code__c=='No Action Required',NonConformance.NC_Resolution_Code__c=='Discarded'),true,false)}">
                                            <apex:outputPanel rendered="{!$ObjectType.Non_Conformance__c.Fields.Resolution_Closed_Comment__c.Accessible}">
                                            <table class="table table-responsive table-bordered">
                                                <tbody>
                                                    <tr>
                                                        <td class="title-col">
                                                            <apex:outputText value="{!JSENCODE(IF(contains(customLabelKeys,'NC_Resolution_Closed_Comment'),customLabels['NC_Resolution_Closed_Comment'].Field_Label__c, $ObjectType.Non_Conformance__c.Fields.Resolution_Closed_Comment__c.Label))}"/>
                                                        </td>
                                                        <td>
                                                            <div class="alert alert-info">   <apex:outputfield value="{!NonConformance.Resolution_Closed_Comment__c}"></apex:outputfield></div>
                                                        </td>
                                                        
                                                    </tr>
                                                </tbody>
                                            </table>
                                            </apex:outputPanel>
                                        </apex:outputPanel>
                                        <apex:outputPanel rendered="{!JSENCODE(NonConformance.NC_Resolution_Code__c)=='Addressed through CAPA'}">
                                            <table class="table table-responsive table-bordered">
                                                <tbody>
                                                    <apex:outputPanel rendered="{!$ObjectType.Non_Conformance__c.Fields.CAPA_Number__c.Accessible}">
                                                    <tr>
                                                        <td class="title-col">
                                                            <apex:outputText value="{!JSENCODE(IF(contains(customLabelKeys,'NC_CAPA_Number'),customLabels['NC_CAPA_Number'].Field_Label__c, $ObjectType.Non_Conformance__c.Fields.CAPA_Number__c.Label))}"/> 
                                                        </td>
                                                        <td>
                                                            {!JSENCODE(NonConformance.CAPA_Number__c)}
                                                        </td>
                                                        
                                                    </tr>
                                                    </apex:outputPanel>
                                                    <apex:outputPanel rendered="{!$ObjectType.Non_Conformance__c.Fields.Resolution_CAPA_Comment__c.Accessible}">
                                                    <tr>
                                                        <td class="title-col">
                                                            <apex:outputText value="{!JSENCODE(IF(contains(customLabelKeys,'NC_Resolution_CAPA_Comment'),customLabels['NC_Resolution_CAPA_Comment'].Field_Label__c, $ObjectType.Non_Conformance__c.Fields.Resolution_CAPA_Comment__c.Label))}"/>
                                                        </td>
                                                        <td>
                                                            <div class="alert alert-info">   <apex:outputField value="{!NonConformance.Resolution_CAPA_Comment__c}"></apex:outputField></div>
                                                        </td>
                                                        
                                                    </tr>
                                                    </apex:outputPanel>
                                                </tbody>
                                            </table>
                                        </apex:outputPanel>
                                        
                                        <apex:outputPanel rendered="{!if(NonConformance.NC_Resolution_Code__c=='NC Workflow',true,false)}">
                                            <table class="table table-responsive table-bordered">
                                                <tbody>
                                                    <tr>
                                                        <th>Task Name</th>
                                                        <th>Sequence</th>
                                                        <th>Owner</th>
                                                        <th>Allowed Days</th>
                                                        <th>Due Date</th>
                                                    </tr>
                                                    <apex:repeat value="{!tasksWithSequences}"  var="General_Tasks"> 
                                                        <apex:outputPanel rendered="{!BEGINS(General_Tasks,'Containment')}">
                                                            <apex:repeat value="{!contTask}" var="General_Task">
                                                                <tr>
                                                                    <td>{!General_Task.RecordType.Name}</td>
                                                                    <td>{!if(General_Task.RecordType.Name=='Closure','',General_Task.Sequence_Position__c)}</td>
                                                                    <td>{!General_Task.Owner.Name}</td>
                                                                    <td>{!General_Task.Allowed_Days__c}</td>
                                                                    <td>  
                                                                        <apex:outputText value="{0,date,dd MMM yyyy}">
                                                                            <apex:param value="{!General_Task.Due_Date__c}" /> 
                                                                        </apex:outputText>
                                                                    </td>
                                                                </tr>
                                                            </apex:repeat>
                                                        </apex:outputPanel>
                                                        <apex:outputPanel rendered="{!BEGINS(General_Tasks,'Implementation')}">
                                                            <apex:repeat value="{!implTask}" var="General_Task">
                                                                <tr>
                                                                    <td>{!General_Task.RecordType.Name}</td>
                                                                    <td>{!if(General_Task.RecordType.Name=='Closure','',General_Task.Sequence_Position__c)}</td>
                                                                    <td>{!General_Task.Owner.Name}</td>
                                                                    <td>{!General_Task.Allowed_Days__c}</td>
                                                                    <td>  
                                                                        <apex:outputText value="{0,date,dd MMM yyyy}">
                                                                            <apex:param value="{!General_Task.Due_Date__c}" /> 
                                                                        </apex:outputText>
                                                                    </td>
                                                                </tr>
                                                            </apex:repeat>
                                                        </apex:outputPanel>
                                                        <apex:outputPanel rendered="{!BEGINS(General_Tasks,'Investigation')}">
                                                            <apex:repeat value="{!invTask}" var="General_Task">
                                                                <tr>
                                                                    <td>{!General_Task.RecordType.Name}</td>
                                                                    <td>{!if(General_Task.RecordType.Name=='Closure','',General_Task.Sequence_Position__c)}</td>
                                                                    <td>{!General_Task.Owner.Name}</td>
                                                                    <td>{!General_Task.Allowed_Days__c}</td>
                                                                    <td>  
                                                                        <apex:outputText value="{0,date,dd MMM yyyy}">
                                                                            <apex:param value="{!General_Task.Due_Date__c}" /> 
                                                                        </apex:outputText>
                                                                    </td>
                                                                </tr>
                                                            </apex:repeat>                                                        
                                                        </apex:outputPanel>
                                                        <apex:outputPanel rendered="{!BEGINS(General_Tasks,'Disposition')}">
                                                            <apex:repeat value="{!dispTask}" var="General_Task">
                                                                <tr>
                                                                    <td>{!General_Task.RecordType.Name}</td>
                                                                    <td>{!if(General_Task.RecordType.Name=='Closure','',General_Task.Sequence_Position__c)}</td>
                                                                    <td>{!General_Task.Owner.Name}</td>
                                                                    <td>{!General_Task.Allowed_Days__c}</td>
                                                                    <td>  
                                                                        <apex:outputText value="{0,date,dd MMM yyyy}">
                                                                            <apex:param value="{!General_Task.Due_Date__c}" /> 
                                                                        </apex:outputText>
                                                                    </td>
                                                                </tr>
                                                            </apex:repeat>                                                        
                                                        </apex:outputPanel>
                                                    </apex:repeat>
                                                    <apex:repeat value="{!adhocTasks}"  var="General_Task">   
                                                        <tr>
                                                            <td>{!General_Task.RecordType.Name}</td>
                                                            <td>{!if(General_Task.RecordType.Name=='Closure','',General_Task.Sequence_Position__c)}</td>
                                                            <td>{!General_Task.Owner.Name}</td>
                                                            <td>{!General_Task.Allowed_Days__c}</td>
                                                            <td>  
                                                                <apex:outputText value="{0,date,dd MMM yyyy}">
                                                                    <apex:param value="{!General_Task.Due_Date__c}" /> 
                                                                </apex:outputText>
                                                            </td>
                                                        </tr>                                                 
                                                    </apex:repeat>
                                                    <tr>
                                                        <td>{!closTask.RecordType.Name}</td>
                                                        <td>{!if(closTask.RecordType.Name=='Closure','',closTask.Sequence_Position__c)}</td>
                                                        <td>{!closTask.Owner.Name}</td>
                                                        <td>{!closTask.Allowed_Days__c}</td>
                                                        <td>  
                                                            <apex:outputText value="{0,date,dd MMM yyyy}">
                                                                <apex:param value="{!closTask.Due_Date__c}" /> 
                                                            </apex:outputText>
                                                        </td>
                                                    </tr>   
                                                </tbody>
                                            </table> 
                                            
                                        </apex:outputPanel>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                </apex:outputPanel>
                <apex:outputPanel rendered="{!if(AND($ObjectType.Non_Conformance__c.Fields.NC_Resolution_Code__c.Accessible,NonConformance.NC_Resolution_Code__c=='NC Workflow'),true,false)}">
                    <c:wiz_task_details containmentTask="{!contTask}" dispositionTask="{!dispTask}"  investigationTask="{!invTask}" implementationTask="{!implTask}" adhocTasks="{!adhocTasks}" closureTask="{!closTask}"></c:wiz_task_details>
                </apex:outputPanel>
                <!------------------new nc details      end----------------------->
                
                <!--  Accordian COPY FROM PRODUCT PAGE-->
                
                <!--  Accordian -->
                
                
                
                
            </div>           
           
         </apex:outputPanel>
         <!-- End : Details -->
        </apex:define>
        <apex:define name="buttonbar">
          <!-- Begin : Buttons For Init -->
           <apex:outputPanel rendered="{!OR($CurrentPage.parameters.pg=='nc_init',ISBLANK($CurrentPage.parameters.pg))}">
              <apex:outputpanel layout="none"
                    rendered="{!AND(NOT(OR(NonConformance.Workflow__c,Non_Conformance__c.Closed__c)), OR($ObjectType.Non_Conformance__c.Updateable, AND(ISBLANK(Non_Conformance__c.Id), $ObjectType.Non_Conformance__c.Createable)))}">
                    <button type="button" class="btn btn-default"
                        onclick="cancelPopup();"><span class="fa fa-close"></span> Cancel</button>
                    
                   <apex:outputpanel layout="none" rendered="{!ISBLANK(NonConformance.Id)}">        
                       <button class="btn btn-success dont-allow-multiple-clicks" onclick="validate()"><span class="fa fa-send"></span> Submit</button>
                   </apex:outputpanel>
                    <apex:outputpanel layout="none" rendered="{!NOT(ISBLANK(NonConformance.Id))}">      
                       <button class="btn btn-primary dont-allow-multiple-clicks" onclick="validate()"><span class="fa fa-floppy-o"></span> Save</button>
                   </apex:outputpanel>
                        
                
               </apex:outputpanel>
               <apex:outputpanel layout="none"
                    rendered="{!NOT(ISBLANK(Non_Conformance__c.Id))}">
                   
                    <button type="submit"
                        onclick="window.location='/apex/NonConformance?id={!$Currentpage.parameters.Id}&pg=nc_products'"
                        class="btn btn-primary dont-allow-multiple-clicks"><span class="fa fa-step-forward"></span> Next</button>
                   
                
               </apex:outputpanel>
 
           </apex:outputPanel>
          <!-- End : Buttons For Init -->
            
          <!-- Begin : Buttons For Product Information -->
           <apex:outputPanel rendered="{!$CurrentPage.parameters.pg=='nc_products'}">
             <button type="button" class="btn btn-primary" id="prodNextBtn" onclick="window.location='/apex/NonConformance?id={!NonConformance.Id}&pg=nc_resolution'"><span class="fa fa-step-forward"></span> Next</button>
            <apex:outputpanel layout="none" rendered="{!AND(NOT(OR(NonConformance.Workflow__c,NonConformance.Closed__c)), OR($ObjectType.Non_Conformance__c.Updateable, AND(ISBLANK(Non_Conformance__c.Id), $ObjectType.Non_Conformance__c.Createable)))}">
                    
                <script type="text/javascript">
                if(isPrimaryProduct){
                        $('#create-product-button').hide();
                        $('#prodCancelBtn').hide();
                        $("#prodNextBtn").hide();
                        $("#prodSaveBtn").show();
                  }
                    function submitInitBatchForm(){
                       $('#initBatchForm').submit();
                    }
                </script>
                
             </apex:outputpanel>
            </apex:outputPanel>
           <!-- End : Buttons For Product Information -->
            
           <!-- Begin : Buttons For Resolution -->
            <apex:outputPanel rendered="{!$CurrentPage.parameters.pg=='nc_resolution'}">
            <apex:outputpanel layout="none" rendered="{!AND(Non_Conformance__c.Status_Is_Open__c,NOT(Non_Conformance__c.Closed__c),NOT(NonConformance.Workflow__c),$ObjectType.Non_Conformance__c.Updateable)}">
                <button type="button" id="PageCancelButton" class="btn btn-default" onclick="cancelPopup();"><span class="fa fa-close"></span> Cancel</button>
        </apex:outputpanel>
        
         <apex:outputpanel layout="none" rendered="{!AND(NOT(Non_Conformance__c.Closed__c),NOT(NonConformance.Workflow__c),$ObjectType.Non_Conformance__c.Updateable)}">
                <button 
                    id="PageSaveButton" 
                    type="button" 
                    onclick="$(this).addClass('most-recent-click'); $('#PageSubmitButton').removeClass('most-recent-click');$('#{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}NC_Status__c').val('Open');disableApprovals();validate({'save':true})" 
                    class="btn btn-primary"
                ><span class="fa fa-floppy-o"></span> Save</button>
        </apex:outputpanel>
        <apex:outputpanel layout="none" rendered="{!AND(NOT(NonConformance.Closed__c),NOT(NonConformance.Workflow__c), $ObjectType.Non_Conformance__c.Updateable)}">        
                 <button 
                    id="PageSubmitButton" 
                    type="button" 
                    onclick="$(this).addClass('most-recent-click'); $('#PageSaveButton').removeClass('most-recent-click'); $('#{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}NC_Status__c').attr('Name','{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}NC_Status__c');updateStatus();disableApprovals();validate({'submit':true});" 
                    class="btn btn-success" 
                    data-target="#signature"
                ><span class="fa fa-send"></span> Submit</button>
        </apex:outputpanel>
        <apex:outputPanel layout="none" rendered="{!OR(AND(NonConformance.NC_Resolution_Code__c !='NC Workflow',NonConformance.NC_Status__c=='Closed'),AND(NonConformance.NC_Resolution_Code__c !='NC Workflow',NonConformance.NC_Status__c=='Void'))}" >
              <button type="button" onclick=" window.location = '/apex/NonConformance?id={!$CurrentPage.parameters.id}&pg=nc_details';" class="btn btn-primary dont-allow-multiple-clicks" ><span class="fa fa-step-forward"></span> Next</button>
        </apex:outputPanel>
        <apex:outputPanel layout="none" rendered="{!OR(Non_Conformance__c.Workflow__c,AND(NonConformance.NC_Resolution_Code__c =='NC Workflow',NonConformance.NC_Status__c=='Closed'),AND(NonConformance.NC_Resolution_Code__c =='NC Workflow',NonConformance.NC_Status__c=='Void'),AND(NonConformance.NC_Resolution_Code__c =='NC Workflow',NonConformance.NC_Status__c=='Reopened'))}">
            <div id="nextbtn">
               <button type="button" id="single-next"  class="btn btn-primary dont-allow-multiple-clicks" ><span class="fa fa-step-forward"></span> Next</button>
            <div class="btn-group" id="btn-group" >
                <button type="button" id="nextbtn"  class="btn btn-primary dont-allow-multiple-clicks"><span class="fa fa-step-forward"></span> Next</button>
                <button type="button" id="butdropdwn" class="btn btn-primary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    <span class="caret"></span>
                    <span class="sr-only">Toggle Dropdown</span>
                </button>
                <ul class="dropdown-menu" id="seqence-tasks">
                    
                </ul>
            </div> 
            </div>
           
            
             <script>
         
          $(document).ready(function(){
            $('#single-next').hide();
            $('#btn-group').hide();
            var sequenceRectype = {};
            var data=[];
            
           <apex:repeat value="{!Non_Conformance__c.General_Tasks__r}" var="c">
            
                  data=sequenceRectype[{!c.Sequence_Position__c}];
                  if(!data){
                       data=[];
                       sequenceRectype[{!c.Sequence_Position__c}]=data;
                  }
                 if("{!c.RecordType.Name}"!="AdhocTask")
                  data.push(['task?id={!$CurrentPage.parameters.Id}&gtid={!c.id}&type={!c.RecordType.Name}','{!JSENCODE(c.RecordType.Name)}']);
                else if("{!c.RecordType.Name}"=="AdhocTask")
                  data.push(['task?id={!$CurrentPage.parameters.Id}&gtid={!c.id}&type={!c.RecordType.Name}','{!JSENCODE(c.AdhocTask_Title__c)}']);
             
            </apex:repeat>
             console.log(sequenceRectype);
             
              $.each(sequenceRectype, function(k, v) {
                  //display the key and value pair
                  console.log(k + ' is ' + v +' length is= '+v.length);
                  var taskslen = v.length;
                  if(taskslen>1){
                        isTasksExistWithSameSequence=true
                        $('#btn-group').show();
                      console.log('group urls');
                        $.each(v, function(i) {
                            console.log(v[i][0]+' '+v[i][1]);
                            $('#seqence-tasks').append("<li><a href=/apex/nc_"+v[i][0]+">"+v[i][1]+"</a></li>");
                            });
                      // window.location='/apex/nc_'+v;
                      }else if(taskslen=1){
                         $('#single-next').show();                          
                          var urlval = "window.location='/apex/nc_"+v[0][0]+"';";
                          console.log(urlval);
                         $('#single-next').attr('onClick',urlval);   
                      }
                     return false;   
              });
              
              
            });
          </script>  
        
        </apex:outputPanel>
           <!-- End : Buttons For Resolution --> 
                        
            </apex:outputPanel>
        </apex:define>
        <apex:define name="rightpane">
            
            <!-- Right container -->
          
              <div class="tab-content">  
                
                <!-- Help Pane -->
                <div class="tab-pane active help" id="help">
                  <c:Contextual_Help currentpage="{!IF(ISBLANK($CurrentPage.parameters.pg),'nc_init',$CurrentPage.parameters.pg)}" />
                </div>
                <!-- Help Pane -->
                  <div class="tab-pane  chronology" id="chronology">
                      <c:nc_chronology rendered="{!$CurrentPage.parameters.pg=='nc_details'}" NCID="{!NonConformance.id}"/>                     
                  </div>
                <!-- Attachment List -->

                 <c:wiz_attachments disable="{!Non_Conformance__c.NC_Status__c=='Void'}" record_id="{!NonConformance.Id}" showAddButtonLink="{! NonConformance.NC_Status__c != 'Closed' }"></c:wiz_attachments>
                 
              </div>        
          <!-- Right container -->
            
         </apex:define>
    </apex:composition>
   </div>
    
    
     <!-- Begin : JavaScript For Init -->
    <apex:outputPanel rendered="{!OR($CurrentPage.parameters.pg=='nc_init',ISNULL($CurrentPage.parameters.pg))}">
      
    

    <script type="text/javascript">
        $( document ).ready(function() {
            $('#{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Occurance_Date__c').datetimepicker()
            .on('dp.change', function(e){
                $('#{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Reported_Date__c').data("DateTimePicker").minDate(e.date);
            });
            $('#{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Reported_Date__c').data("DateTimePicker").minDate($('#{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Occurance_Date__c').data("DateTimePicker").date());
            
            
            
            $('#{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Reported_Date__c').datetimepicker()
            .on('dp.change', function(e){
                $('#{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Occurance_Date__c').data("DateTimePicker").maxDate(e.date);
            });
            $('#{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Occurance_Date__c').data("DateTimePicker").maxDate($('#{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Reported_Date__c').data("DateTimePicker").date());
            
          if('{!OR(Non_Conformance__c.Closed__c,NOT($ObjectType.Non_Conformance__c.Fields.Supplier_Manufacturer_Part__c.updateable))}' == 'true')
            {
                 $('#Supplier_Manufacturer_Part__c').attr('disabled', true); 
            }

          if('{!OR(Non_Conformance__c.Closed__c,NOT($ObjectType.Non_Conformance__c.Fields.PO_Number__c.updateable))}' == 'true')
            {
                 $('#PO_Number__c').attr('disabled', true); 
            }
         
        });
        

        function cancelPopup()
        {
            var r = confirm('You will lose unsaved changes!');
                if (r == true) {
                    x = "You pressed OK!";
                    alert(x);
                    window.location.href='/{!$ObjectType.Non_Conformance__c}/o';
                    } else
                    x = "You pressed Cancel!";

        }
        
        function onValidInit(){
          console.log('nc_init onValidInit  ');
          if({!NOT(ISBLANK(Non_Conformance__c.Id))}){
              $('#ncForm').submit();
          }
          else{
            var isDigSigNd='<apex:outputText value="{!$Setup.QC_settings__c.Is_Digital_Signature_Needed__c}"/>'
            if(isDigSigNd=='true'){
               $('#uname').val('');$('#pw').val('');$('.dont-allow-multiple-clicks').removeAttr('disabled'); $('#signature').modal('show');
            }else{
             navigateAfterDigitalSignature();
            }
          }
        }
        function navigateAfterDigitalSignature(){
            if(!$('.dont-allow-multiple-clicks').attr('disabled')){
                   $('.dont-allow-multiple-clicks').attr('disabled', true); 
                   if({!Can_Reopen})
                   {
                       reopennc();
                   }
                   if({!JSENCODE(NonConformance.NC_Status__c) == 'Reopened'})
                   {
                       closenc();
                   }
                   else
                   {
                       $('#ncForm').submit();
                   }
         }
        }

        
        
      
        </script>
      
    </apex:outputPanel>
    <!-- End : JavaScript For Init -->

    <!-- Begin : JavaScript For Product Information -->
    <apex:outputPanel rendered="{!$CurrentPage.parameters.pg=='nc_products'}">
      <div class="col-md-12">
       <script type="text/javascript">
           $( document ).ready(function() {
             $('#newncp').on('hidden.bs.modal', function () {
                  isEdit=false;
             });
         });
     
     function deleteProds(id){
          Visualforce.remoting.Manager.invokeAction('{!$RemoteAction.NonConformance.deleteProduct}',id,function(result, event){ 
                                                                                                  if(result)
                                                                                                      //document.location.reload(true); // using .reload causes POST to occur again.  This caused a bug where attachments were attached over and over.
                                                                                                      window.location= '/apex/NonConformance?id={!NonConformance.id}&pg=nc_products';
                                                                                                });
     }
     
     function deleteBatch(id){
        console.log(id);
        Visualforce.remoting.Manager.invokeAction('{!$RemoteAction.NonConformance.deleteBatch}',id,function(result, event){ 
            if(result)
                //document.location.reload(true); // using .reload causes POST to occur again.  This caused a bug where attachments were attached over and over.
                window.location= '/apex/NonConformance?id={!NonConformance.id}&pg=nc_products';
        });
     }
     
      function cancelPopup()
        {
            var r = confirm('You will lose unsaved changes!');
                if (r == true) {
                    x = "You pressed OK!";
                    alert(x);
                    window.location.href='/{!$ObjectType.Non_Conformance__c}/o';
                    } else
                    x = "You pressed Cancel!";

        }
     function navigateAfterDigitalSignature(){
       if({!Can_Reopen}){
        reopennc();
       }
      if({!JSENCODE(NonConformance.NC_Status__c) == 'Reopened'}){
        closenc();
       }
     }
    
    
        function resetprodform() {
            clearerrors();
            $('#{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Product__c, #Manufacturing_Site__c, #{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Defect_Codes__c, #Lot_Quantity_Affected__c, #{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Lot_Bacth_Number__c').val(null).trigger('change');
            $('#{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}UOM__c').val('  ').trigger('change');
            $('#{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}NC_Product__c').val(null);
            $('#ncpid').attr('name', 'Id');
            var prefix='<apex:outputText value="{!JSENCODE($Setup.Dev_Only__c.Namespace_Prefix__c)}" />';
             prefix=prefix?prefix+'__':'';
             console.log(lotBatch);
             $('#'+prefix+'Lot_Bacth_Number__c_error').html('');
             $('#{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Product__c_error').html('');
        }
        
        function isExistingProduct(pId){
           console.log('wiz_add_prod  isExistingProduct '+pId+' isEdit    '+isEdit);
           $('#{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Product__c_error').html('');
           if($.inArray(pId?pId.trim():pId, existingProducts )>=0){
                $('#{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Product__c_error').append('This Product is already exist').css('color','red');
                console.log('returning false  ');
                return false;
           }
           console.log('returning true   ');
           return true;    
        }
        
        function createprod() {
            resetprodform();
            $('#prodinfo').show();
            $('#newncp').modal('show');
        
            $('#ncpid').attr('name', 'notid');
            $('#batchinfo').show();
        }

        function addbatch(NCProductId, ProductId) {
            resetprodform();
            $("#addedProdId").val(ProductId);
            $('#prodinfo').hide();
            $("#addedProdId").val(ProductId);
            $('#ncpid').attr('name', 'Id');
            $('#batchinfo').show();         
            $('#{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}NC_Product__c').val(NCProductId);
            $('#{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Defect_Codes__c').data('id', ProductId);
            $('#ncpid').attr('name', 'notid');

            
            $('#newncp').modal('show');
        }
        
        function editbatch(RecordId) {
            resetprodform();
            isEdit=true;
            Visualforce.remoting.Manager.invokeAction(
                 '{!$RemoteAction.NonConformance.getLot}',RecordId,function(result, event){
                                                                                        console.log('get lot');
                                                                                        console.log(result);
                                                                                        $('#{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}NC_Product__c').val(escapeHtml(result.NC_Product__c));
                                                                                        $('#lotid').val(escapeHtml(result.Id));
                                                                                        $('#{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Lot_Bacth_Number__c').val(escapeHtml(result.{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Lot_Bacth_Number__c));
                                                                                        $('#{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Lot_Quantity_Affected__c').val(escapeHtml(result.{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Lot_Quantity_Affected__c));
                                                                                        $('#{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}UOM__c').val(escapeHtml(result.{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}UOM__c)).trigger('change');
                                                                                        if(typeof escapeHtml(result.{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Defect_Codes__c) != 'undefined'){
                                                                                            console.log(escapeHtml(result.{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Defect_Codes__c));
                                                                                            console.log(escapeHtml(result.{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Defect_Codes__c.split(',')));
                                                                                            var h = '';
                                                                                            
                                                                                            if(typeof escapeHtml(result.{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}NC_Product_Defects__r) != 'undefined')
                                                                                            for(var i=0; i<result.{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}NC_Product_Defects__r.length; i++)
                                                                                                h += '<option selected="selected" value="' + escapeHtml(result.{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}NC_Product_Defects__r[i].{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Defect__c) + '">' + escapeHtml(result.{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}NC_Product_Defects__r[i].{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Defect__r.Name) + '</option>';
                                                                                            
                                                                                            console.log(h);  
                                                                                            $('#{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Defect_Codes__c').data('id', escapeHtml(result.{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}NC_Product__r.{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Non_Conformance__r.{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Product__c));
                                                                                            $('#{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Defect_Codes__c').html(h);
                                                                                            $('#{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Defect_Codes__c').trigger('change');
                                                                                        }
                                                                                        
                                                                                        
                                                                                        $('#prodinfo').hide();
                                                                                        $('#batchinfo').show(); 
                                                                                        
                                                                                        $('#newncp').modal('show');  
                                                                             
                                                                       });
            
            
        }

        function editprod(RecordId) {
            resetprodform();
            isEdit=true;
            Visualforce.remoting.Manager.invokeAction(
                 '{!$RemoteAction.NonConformance.getRemoteNCP}',RecordId,function(result, event){
                                                                              console.log(event);
                                                                              console.log(result);
                                                                              if(typeof result.{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Product__c != 'undefined'){
                                                                              
                                                                              $('#{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Product__c').html('<option selected="selected" value="' + escapeHtml(result.{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Product__c) + '">' + escapeHtml(result.{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Product__r.Name) + '</option>').trigger('change');
                                                                              
                                                                              if(typeof result.{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Manufacturing_Site__c != 'undefined')
                                                                              $('#Manufacturing_Site__c').html('<option selected="selected" value="' + escapeHtml(result.{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Manufacturing_Site__c)+ '">' + escapeHtml(result.{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Manufacturing_Site__r.Name) + '</option>').trigger('change');
                                                                              
                                                                              $('#Manufacturing_Site__c').val(escapeHtml(result.{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Manufacturing_Site__c)).trigger('change');
                                                                              $('#ncpid').val(result.Id);
                                                                              $('#prodinfo').show();
                                                                              $('#batchinfo').hide();
                                                                              
                                                                              $('#newncp').modal('show');
                                                                              }else{
                                                                                $('#ncpid').attr('name', 'notid');
                                                                              }
                                                                       });
        }

        function submitprodform() {
            var prefix='<apex:outputText value="{!JSENCODE($Setup.Dev_Only__c.Namespace_Prefix__c)}" />';
            prefix=prefix?prefix+'__':'';
            var lotBatchVal=$('#'+prefix+'Lot_Bacth_Number__c').val();
            //console.log('submitprodform lotBatchVal '+lotBatchVal+'     isEdit   '+isEdit);
            var prodId=$('#{!JSENCODE(IF(NOT(ISBLANK(Prefix)),Prefix+'__',''))}Product__c').val();
            var addedProdId=$("#addedProdId").val();
            console.log('NonConformance  submitprodform    prodId   '+prodId);
            if(isEdit || (checkLotBatchNumber(prodId?prodId:addedProdId,lotBatchVal) && isExistingProduct(prodId))){
	            if(!$('.dont-allow-multiple-clicks').attr('disabled')){
	             $('.dont-allow-multiple-clicks').attr('disabled', true);
	                if ($('#prodinfo').css('display') !== 'none') {
	                    console.log('prodform');
	                    $('#prodform').submit();
	                } else {
	                    if ($('#batchinfo').css('display') !== 'none') {
	                        console.log('batchform');
	                        $('#batchform').submit();
	                    }
	                }
	            }
           }
      }
           
       </script>
       
    <!--    Add Product Dialog      -->
 <!--   <div class="modal fade" id="newncp" tabindex="-1" role="dialog" aria-labelledby="newncp">-->
   <div class="modal fade" id="newncp" role="dialog" aria-labelledby="newncp">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="newncp">Add Product Info</h4>
                </div>
                <div class="modal-body">

                    <!--     screen content -->
                    <!--  screen content -->
                    <span id="prodinfo">
                    <c:wiz_form formclass="prodform validate" formid="prodform" submitpage="stringify_sobject" recordid="" postsavejs="
                      console.log('entering postsavejs');
                       if($('#batchinfo').css('display') !== 'none'){ 
                        $('#{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}NC_Product__c').val(RecordId);
                        console.log('post prodform submit, submit batchform');
                        $('#batchform').submit();
                       }else{
                         
                         window.location = '/apex/NonConformance?id={!JSENCODE(NonConformance.Id)}&pg=nc_products';
                       }
                      ">
                        <input type="hidden" name="sobj" value="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}nc_product__c"/>
                        <input type="hidden" name="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Non_Conformance__c" value="{!NonConformance.Id}"/>
                    
                       <input id="ncpid" type="hidden" name="Id" value=""/>
                   
                        <div id="prodforminsert"></div>
                        
                        <div class="col-md-12">
                            <div class="form-group">
                                <label for="exampleInputEmail1"><span class="mandatory">*</span> Primary Defect Code:</label>
                    <c:wiz_readonly value="{!Non_Conformance__c.Defect__r.Name}" />
                </div>
            </div>
            <div class="col-md-6">
                <c:wiz_field FieldLabel="Product" required="true" isPopup="true" jsid="select_Product" rendered="{!$ObjectType.NC_Product__c.accessible}">
                    <c:wiz_multi disabled="{!OR(NCP.Non_Conformance__r.Closed__c, NOT($ObjectType.NC_Product__c.Fields.Product__c.updateable))}" width="100%" required="true" initValues="" FieldId="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Product__c" FieldName="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Product__c" queryFields="Name,{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Product_Code__c" querytable="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Product__c" onchange="
                      $('#{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Defect__c').val(null).trigger('change');
                                             
                                              if($('#{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Product__c').val() == ''){
                                                 $('#{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Defect_Codes__c').data('id', '');
                                                 $('#{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Defect_Codes__c').prop('disabled', true);
                                              }
                                              else{
                                                console.log($('#{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Product__c').val());
                                                $('#{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Defect_Codes__c').prop('disabled', false);
                                                $('#{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Defect_Codes__c').data('id', $('#{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Product__c').val());
                                              } 
                    " />
                </c:wiz_field>
            </div>

            <div class="col-md-6">
                <c:wiz_field FieldLabel="Manufacturing Site" required="true" isPopup="true" jsid="site" rendered="{!$ObjectType.NC_Product__c.Fields.Manufacturing_Site__c.accessible}">
                    <c:wiz_multi width="100%" required="true" FieldId="Manufacturing_Site__c"
                    disabled="{!NOT($ObjectType.NC_Product__c.Fields.Manufacturing_Site__c.updateable)}"
                    FieldName="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Manufacturing_Site__c" 
                    multiple="false" 
                    queryFields="Name" 
                    querytable="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Manufacturing_Site__c" 
                    initValues="" />
                </c:wiz_field>
            </div>
            </c:wiz_form>
            </span>
            <span id="batchinfo">
                    <div class="add-widget-container">
        <c:wiz_form formclass="batchform validate" formid="batchform"  submitpage="stringify_sobject" recordid="" postsavejs="window.location = '/apex/NonConformance?id={!JSENCODE(Non_Conformance__c.Id)}&pg=nc_products';">
            <input type="hidden" name="sobj" value="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}product_lot_numbers__c"/>
            <input type="hidden" name="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}NC_Product__c" value="" class="QPMS__NC_Product__c" id="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}NC_Product__c"/>
            <input id="lotid" type="hidden" name="Id" value=""/>
            <div class="add-toolbar">
                <label>Lot/Batch</label>

            </div>

            <!-- slimscroll panel -->
            <div >

                <div class="add-prod-wrapper">
                    <div class="add-product">
                        <div class="top-row">
                          
                                <c:wiz_field divclass="col-md-5" isPopup="true" FieldLabel="{!$ObjectType.Product_Lot_Numbers__c.Fields.Lot_Bacth_Number__c.Label}" required="true" jsid="batchnum" rendered="{!$ObjectType.Product_Lot_Numbers__c.Fields.Lot_Bacth_Number__c.Accessible}">
                                    <c:wiz_input fieldname="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Lot_Bacth_Number__c" required="true" initvalue="" disabled="{!NOT($ObjectType.Product_Lot_Numbers__c.Fields.Lot_Bacth_Number__c.updateable)}"/>    
                                </c:wiz_field>
                 
                                <c:wiz_field divclass="col-md-4" isPopup="true" FieldLabel="{!$ObjectType.Product_Lot_Numbers__c.Fields.Lot_Quantity_Affected__c.Label}" required="true" jsid="qty" rendered="{!$ObjectType.Product_Lot_Numbers__c.Fields.Lot_Quantity_Affected__c.Accessible}">
                                    <c:wiz_input type="number" fieldname="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Lot_Quantity_Affected__c" min="1" required="true" initvalue="" disabled="{!NOT($ObjectType.Product_Lot_Numbers__c.Fields.Lot_Quantity_Affected__c.updateable)}" />    
                                </c:wiz_field>

                                <c:wiz_field divclass="col-md-3" isPopup="true" FieldLabel="{!$ObjectType.Product_Lot_Numbers__c.Fields.UOM__c.Label}" required="true" jsid="uom" rendered="{!$ObjectType.Product_Lot_Numbers__c.Fields.UOM__c.Accessible}">
                                    <c:wiz_select disabled="{!NOT($ObjectType.Product_Lot_Numbers__c.Fields.UOM__c.updateable)}" 
                                    ObjectName="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Product_Lot_Numbers__c"
                                    FieldName="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}UOM__c" 
                                    required="true" 
                                    initvalue=""
                                    unSelectedDisplayText="   "
                                    developername="UOM" />
                                </c:wiz_field>
                           

                            <div class="clearfix"></div>
                        </div>
                        <apex:outputpanel layout="block" styleclass="defect-code">
                            <div class="col-md-12">
                                <label>{!$ObjectType.Product_Lot_Numbers__c.Fields.Defect_Codes__c.Label}:</label>
                            </div>
                            <div class="search-field">
                                <c:wiz_multi width="100%" FieldId="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Defect_Codes__c" FieldName="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Defect_Codes__c" multiple="true" queryFields="Name,{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Defect__c" type="prod" querytable="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Defect__c" dataid="" required="false">
                                </c:wiz_multi>
                            </div>
                                                        
                        </apex:outputpanel><br/>
                    </div>
                </div>
            </div>
            <!-- slimscroll panel -->
        </c:wiz_form>
        
    </div>
                    </span>
        </div>
        <div class="clearfix"></div>
        <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
            <button type="button" onclick="validate(null,submitprodform,'prodform@batchform');" class="btn btn-primary dont-allow-multiple-clicks">Ok</button>
        </div>
    </div>
    </div>
    </div>  
    </div>
    </apex:outputPanel>
    <!-- Begin : JavaScript For Product Information -->

    <!-- Begin : JavaScript For Resolution -->
    <apex:outputPanel rendered="{!$CurrentPage.parameters.pg=='nc_resolution'}">
      <script type="text/javascript">
        function onValidResolution(validateParams){
          //console.log('onValidResolution   '+validateParams);
          if(isTasksValid() && isDatesValid()){
            if(validateParams.save){
              if($('#ResolutionCodeField').val()=='NC Workflow' && $('#{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}NC_Status__c').val()!='NC Workflow'){
                 $('#PageSaveButton').attr('disabled','true');$('#PageSubmitButton').attr('disabled','true');$('#PageCancelButton').attr('disabled','true');createTasks();
              }
              else{
                  $('#PageSaveButton').attr('disabled','true');$('#PageSubmitButton').attr('disabled','true');$('#PageCancelButton').attr('disabled','true');$('#ncForm').submit();
              }
            } 
            if(validateParams.submit){
                var isDigSigNd='<apex:outputText value="{!$Setup.QC_settings__c.Is_Digital_Signature_Needed__c}"/>'
                if(isDigSigNd=='true'){
                    $('#uname').val('');$('#pw').val('');$('#signature').modal('show');
                }
                else{
                 navigateAfterDigitalSignature();
                }
            }
          }
       }
        function cancelPopup()
        {
           var YESButtonInRedirectModalOnClick = function () {
               window.location.href = '/apex/nc_resolution?id={!JSENCODE($CurrentPage.parameters.id)}';
           };
           var NOButtonInRedirectModalOnClick = function () {
               
           };
           $('#redirectDialog .btn-primary').bind( "click", YESButtonInRedirectModalOnClick);
           $('#redirectDialog .btn-default').bind( "click", NOButtonInRedirectModalOnClick);
           
           // Show the redirect dialog
           $('#redirectDialog').modal('show');
           
           // Remove the onClick event
           $('#redirectDialog').on('hidden.bs.modal', function () {
               $('#redirectDialog .btn-primary').unbind( "click", YESButtonInRedirectModalOnClick);
               $('#redirectDialog .btn-default').unbind( "click", NOButtonInRedirectModalOnClick);
           })

        }
        
        
        
        function referToExternalCapa(){
          showDialog("1","You don't have access to any external CAPA systems.<br/>Please enter CAPA Number manually");
           
        }
        
        function toggleCreateCAPAButton(createCapaChk){
           if(createCapaChk.checked){
              $("#createCapaBtn").show();
           }
           else{
            $("#extCapaNum").attr('disabled',true);
             $("#createCapaBtn").hide();
             
           }
           $("#{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}CAPA_Number__c").attr('disabled',createCapaChk.checked);
           $("#PageSubmitButton").attr('disabled',createCapaChk.checked);
           $("#PageSaveButton").attr('disabled',createCapaChk.checked);
           $("#PageCancelButton").attr('disabled',createCapaChk.checked);
        }
        
        function toggleBrowseExtCAPAButton(browseExtCapa){
          if(browseExtCapa.checked){
             $("#extCapaBtn").show()
          }
          else{
             $("#extCapaBtn").hide()
          }
        }
        
       
        
        function createCAPA(ncId,ncNumber,problemStmt){
           //createCAPAFromNC(String ncId,String ncNumber,String problemStmt)
          $("#extCapaNum").attr('disabled','true');
          $("#extCapaNum").hide();
          $("#extCapaBtn").attr('disabled',true);
          $("#PageSubmitButton").attr('disabled','true');
          $("#PageSaveButton").attr('disabled','true');
          $("#PageCancelButton").attr('disabled','true');
          Visualforce.remoting.Manager.invokeAction(
                                    // @RemoteAction
                                    '{!$RemoteAction.NonConformance.createCAPAFromNC}',ncId,ncNumber,problemStmt,
                                    // Callback
                                    function(result, event){
                                        console.log('createCAPAFromNC   result  '+result);
                                        $('#ncForm').submit();
                                        //location.reload();
                                    },
                                    // Don't know, couldn't find docs
                                    {escape: true}
          );
        }
    
         function createTasks(isSubmit){
             console.log('Creating Tasks');
                     var tasks={},contDueDate,dispDueDate,invDueDate,implDueDate;
                    //GET ALL adhocdata
                     var adhocTasks = [];
             adhocTasks = resAdhoc_pageAdhoc_getAllAdhoctasks(); 
             //------------------------
                     console.log(' resolution Page adhoc task isValid     '+isValid);
                     console.log('$("#containment").checked   '+$("#containment").is(':checked'));
                     
                     if($("#containment").is(':checked')){
                         contDueDate=new Date($("#cont{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Due_Date__c_GRDATE").val());
                         tasks['Containment']=[$("#cont{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Sequence__c").val(),$("#contUser").val(),$("#cont{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Allowed_Days__c").val(),(contDueDate.getMonth()+1)+"/"+contDueDate.getDate()+"/"+contDueDate.getFullYear()];
                     }
                     if($("#disposition").is(':checked')){
                         dispDueDate=new Date($("#disp{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Due_Date__c_GRDATE").val());
                         tasks['Disposition']=[$("#disp{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Sequence__c").val(),$("#dispUser").val(),$("#disp{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Allowed_Days__c").val(),(dispDueDate.getMonth()+1)+"/"+dispDueDate.getDate()+"/"+dispDueDate.getFullYear()]
                     }
                     if($("#investigation").is(':checked')){
                         invDueDate=new Date($("#inv{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Due_Date__c_GRDATE").val());
                         tasks['Investigation']=[$("#inv{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Sequence__c").val(),$("#invUser").val(),$("#inv{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Allowed_Days__c").val(),(invDueDate.getMonth()+1)+"/"+invDueDate.getDate()+"/"+invDueDate.getFullYear()]
                     }
                     if($("#implementation").is(':checked')){
                         implDueDate=new Date($("#impl{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Due_Date__c_GRDATE").val());
                         tasks['Implementation']=[$("#impl{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Sequence__c").val(),$("#implUser").val(),$("#impl{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Allowed_Days__c").val(),(implDueDate.getMonth()+1)+"/"+implDueDate.getDate()+"/"+implDueDate.getFullYear()]
                     }
                     var closureDueDate=new Date($("#cloDueDate_GRDATE").val());
                     console.log(' closureDueDate    '+closureDueDate);
                     var appDueDate=new Date($("#app{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Due_Date__c_GRDATE").val());
                     tasks['Closure']=[200,$("#cloUser").val(),$("#closureAllowDaysFieldId").val(),(closureDueDate.getMonth()+1)+"/"+closureDueDate.getDate()+"/"+closureDueDate.getFullYear()];
                     Visualforce.remoting.Manager.invokeAction(
                                    // @RemoteAction
                                    '{!$RemoteAction.NonConformance.createNCTasks}',
                                    
                                     adhocTasks,tasks,'{!NonConformance.Id}',(isSubmit)?true:false,$("#closApprTab_chk").is(':checked'),false,
                                    
                                    // Callback
                                    function(result, event){
                                        console.log('createTasks   result  '+result);
                                        if($("#closApprTab_chk").is(':checked')){
                                           saveApprovalData(result['Closure']);
                                        }
                                        else{
                                         $('#ncForm').submit();
                                        }
                                        
                                        
                                    },
                                    // Don't know, couldn't find docs
                                    {escape: true}
                    );
                    
                    
                     
           }
           
           function createNCCAPA(ncId,ncName,defectStatement,capaNumber){
               console.log('createNCCAPA ncId '+ncId+' ncName '+ncName+' defectStatement  '+defectStatement+' capaNumber  '+capaNumber);
               Visualforce.remoting.Manager.invokeAction(
                                    // @RemoteAction
                                    '{!$RemoteAction.NonConformance.createNCCAPAJunction}',ncId,ncName,defectStatement,capaNumber,
                                    
                                    // Callback
                                    function(result, event){
                                        console.log('createNCCAPA   result  '+result);
                                        if(result)
                                          window.open('apex/CAPA?id='+result+'&pg=capa_reference','_newtab');
                                        $('#ncForm').submit();
                                        
                                    },
                                    // Don't know, couldn't find docs
                                    {escape: true}
                    );
                
           }
           
           function updateStatus(){
                    var resCode=$('#ResolutionCodeField').val();
                    if(resCode=='NC Workflow'){
                       
                            $('#{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}NC_Status__c').val('NC Workflow');
                            $('#{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}NC_Workflow_Status__c').val('Open');
                    }
                    else{
                        $('#{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}NC_Status__c').val('Closed');
                        $('#{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}NC_Workflow_Status__c').val('');
                    }
                    if(resCode=='Addressed through CAPA'){
                       $("#createCapaBtn").show();
                    }
           }
           function navigateAfterDigitalSignature(){
               //alert('Submitting Resolution....');
                    if({!can_reopen}){
                        reopennc();
                    }
                    else{
                        $("#PageSubmitButton").attr('disabled','true');
                        $("#PageSaveButton").attr('disabled','true');
                        $("#PageCancelButton").attr('disabled','true');
                        var resCode=$('#ResolutionCodeField').val();
                        if(resCode=='NC Workflow' && {!NOT(NonConformance.Workflow__c)}){
                           createTasks(true);
                        }
                        if(resCode=='Addressed through CAPA' && {!NOT(ExternalSystemCapaReferenceNeeded)}){
                           createNCCAPA('{!JSENCODE(NonConformance.Id)}','{!JSENCODE(NonConformance.Name)}','{!JSENCODE(NonConformance.Full_Description__c)}',$("#{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}CAPA_Number__c").val());
                        }
                        else{
                          $('#ncForm').submit();
                        }
                    }
    
           }
           
           function isTasksValid(){
              
              var isTaskValid=true;
            if($('#ResolutionCodeField').val()=='NC Workflow'){
              if($("#containment").is(':checked')){
                  var tempValid=isContainmentValid();
                  isTaskValid=isTaskValid?tempValid:isTaskValid;
              }
              if($("#disposition").is(':checked')){
                  var tempValid=isDispositionValid();
                  isTaskValid=isTaskValid?tempValid:isTaskValid;
              }
              if($("#investigation").is(':checked')){
                  var tempValid=isInvestigationValid();
                  isTaskValid=isTaskValid?tempValid:isTaskValid;
              }
              if($("#implementation").is(':checked')){
                  var tempValid=isImplementationValid();
                  isTaskValid=isTaskValid?tempValid:isTaskValid;
              }
              if($("#closApprTab_chk").is(':checked')){
                 var tempValid=isApprovalsValid();
                 isTaskValid=isTaskValid?tempValid:isTaskValid;
              }
              if(!$("#cloDueDate_GRDATE").val()){
                 isTaskValid=false;
                 $('#cloDueDate_error').html("<p><font color='red'>This field is required</font></p>");
              }
              if(!$("#cloUser").val()){
                 isTaskValid=false;
                 $('#cloUser_error').html("<p><font color='red'>This field is required</font></p>");
              }
              if(!$("#closureAllowDaysFieldId").val()){
                 isTaskValid=false;
                 $('#closureAllowDaysFieldId_error').html("<p><font color='red'>This field is required</font></p>");
              }
           }
              
              return isTaskValid;
           }
           
           function isDatesValid(){
               var isDateValid=true;
               var isAdhocValid=true
               errMsg='';
               if($('#ResolutionCodeField').val()=='NC Workflow'){
                 var isDueDateValidationNeeded="<apex:outputText value="{!$Setup.QC_settings__c.Is_Due_Date_Validation_Needed__c}"/>";
                 //alert('Is Due Date Validation Needed '+  isDueDateValidationNeeded);
                 var adhocTasks=resAdhoc_pageAdhoc_getAllAdhoctasks();
                 if(isDueDateValidationNeeded=="true"){
                     var seqDueDateMap={},seqs=[];
                      if(adhocTasks){
                        $.each(adhocTasks,function(index,adhocTask){
                           adhocTask=adhocTask.split('@');
                           seq=adhocTask[0];
                           dueDate=seqDueDateMap[seq];
                           newDueDate=new Date(adhocTask[3]);
                           console.log('adhoc seq  '+seq+' dueDate  '+dueDate+' newDueDate  '+newDueDate);
                           if(dueDate){
                                dueDate=new Date(dueDate);
                                if(dueDate.getTime()<newDueDate.getTime()){
                                    seqDueDateMap[seq]=newDueDate;
                                }
                           }
                           else{
                             seqDueDateMap[seq]=newDueDate;
                             seqs.push(seq);
                           }
                        });
                     }
                     if($("#containment").is(':checked')){
                           seq=$("#cont{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Sequence__c").val();
                           dueDate=seqDueDateMap[seq];
                           newDueDate=new Date($("#cont{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Due_Date__c_GRDATE").val());
                           console.log('cont date  '+$("#cont{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Due_Date__c_GRDATE").val());
                           //console.log('seq  '+seq+' dueDate  '+dueDate+' newDueDate  '+newDueDate);
                           if(dueDate){
                                dueDate=new Date(dueDate);
                                if(dueDate.getTime()<newDueDate.getTime()){
                                    seqDueDateMap[seq]=newDueDate;
                                }
                           }
                           else{
                             seqDueDateMap[seq]=newDueDate;
                             seqs.push(seq);
                           }
                      }
                    if($("#disposition").is(':checked')){
                           seq=$("#disp{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Sequence__c").val();
                           dueDate=seqDueDateMap[seq];
                           newDueDate=new Date($("#disp{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Due_Date__c_GRDATE").val());
                           //console.log('seq  '+seq+' dueDate  '+dueDate+' newDueDate  '+newDueDate);
                           if(dueDate){
                                dueDate=new Date(dueDate);
                                if(dueDate.getTime()<newDueDate.getTime()){
                                    seqDueDateMap[seq]=newDueDate;
                                }
                           }
                           else{
                            seqDueDateMap[seq]=newDueDate;
                            seqs.push(seq);
                           }
                    }
                  if($("#investigation").is(':checked')){
                           seq=$("#inv{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Sequence__c").val();
                           dueDate=seqDueDateMap[seq];
                           newDueDate=new Date($("#inv{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Due_Date__c_GRDATE").val());
                           if(dueDate){
                            dueDate=new Date(dueDate);
                            if(dueDate.getTime()<newDueDate.getTime()){
                                seqDueDateMap[seq]=newDueDate;
                            }
                        }
                        else{
                         seqDueDateMap[seq]=newDueDate;
                         seqs.push(seq);
                       }
                  }
                  if($("#implementation").is(':checked')){
                    seq=$("#impl{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Sequence__c").val();
                    dueDate=seqDueDateMap[seq];
                    newDueDate=new Date($("#impl{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Due_Date__c_GRDATE").val());
                    if(dueDate){
                        dueDate=new Date(dueDate);
                        if(dueDate.getTime()<newDueDate.getTime()){
                            seqDueDateMap[seq]=newDueDate;
                        }
                    }
                    else{
                     seqDueDateMap[seq]=newDueDate;
                     seqs.push(seq);
                    }
                  }
                  seqs.sort(sortSeq);
                  var hsd,lsd
                  for(var i=0;i<seqs.length-1;i++){
                     for(var j=i+1;j<seqs.length;j++){
                         hsd=seqDueDateMap[seqs[j]];
                         lsd=seqDueDateMap[seqs[i]];
                         if(hsd.getTime()<lsd.getTime()){
                            isDateValid=false;
                            showDialog('1','The task Due Date cannot be less than the Due Date of lower sequence task.')
                            return false;
                         }
                     }
                  }
                 if(isDateValid){      
                  var closureDueDate=new Date($("#cloDueDate_GRDATE").val());
                  closureDueDate=new Date($("#cloDueDate_GRDATE").val());
                  if($("#closApprTab_chk").is(':checked')){
                   $('#closApprTab_table > tbody  > tr').each(function() {
                      tds=$(this).find('td');
                      dueDt=$("#"+tds.eq(3).find('div').find('input[type="text"]').attr('id')).val(); 
                      console.log('dueDt   '+dueDt);
                      if(new Date(dueDt).getTime()>closureDueDate.getTime()){
                         isDateValid=false;
                         showDialog('1','The Closure Task Due Date cannot be less than the Approval(s) Due Date.');
                         return false; 
                      }
                      else if(seqs.length > 0 && seqDueDateMap[seqs[seqs.length-1]].getTime() > new Date(dueDt).getTime()){
                         isDateValid=false;
                         showDialog('1','The Closure Task Approval Due date should not be less than the Task Due Date');
                         return false; 
                      }
                      
                    });
                    if(isDateValid){  
                       if(!isApprovalDueDatesValid()){
                         showDialog('1','The Closure Task Approval Due Date cannot be less than  the lower sequence Approval(s) Due Date.');
                         return false;
                       }
                    }
                  }
                  else {
                    $.each(seqs,function(index,sq){
                       if(closureDueDate.getTime()<seqDueDateMap[sq].getTime()){
                          isDateValid=false;
                          showDialog('1','The Closure Task Due Date cannot be less than the task(s) Due Date.');
                          return false;
                       }
                    });
                  }
            }
            
           }
           
           
           isAdhocValid=isValid;    
          }
               
               return isDateValid && isAdhocValid;
           }
    
           function disableApprovals(){
               if(!$("#closApprTab_chk").is(':checked')){
                   $("#closApprTab_table").find("input,select").each(function(){
                             $(this).attr('disabled', true);
               });
           }
           }
           
           
        
    </script>
    
    </apex:outputPanel>
    <!-- Begin : JavaScript For Resolution -->
    
    <!-- Begin : Alert,Digital Signature and Validator Components -->
    <c:wiz_alert alertId="invalidDateAlert"/>
    <c:digital_signature onSuccess="navigateAfterDigitalSignature()" />
    <c:wiz_validator onValid="if({!$CurrentPage.parameters.pg=='nc_resolution'})onValidResolution(validateParams);else if({!OR($CurrentPage.parameters.pg=='nc_init',ISNULL($CurrentPage.parameters.pg))})onValidInit();" ignorehidden="{!$CurrentPage.parameters.pg=='nc_products'}"/>
   <!-- End : Alert,Digital Signature and Validator Components -->
</apex:page>