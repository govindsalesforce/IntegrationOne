<!--
v1.0        Qualityze Inc(SLVR)         15-JUN-2016         Initial Version.

                                                            This page includes CR init and Doc Info belonging to the Change Management.
                                                            
v1.1        Qualityze Inc(SS)           20-July-2016        Changed the UI based on the new requirement,Added four new fields  

v1.2    Qualityze Inc(ST)       13-AUG-2016     Created methods for cr_details

v1.3    Qualityze Inc(ST)       19-AUG-2016     Created methods for chronology

v1.4    Qualityze Inc(ST)       09-SEP-2016     Created methods for cr_detals_print
                                                            
-->
<apex:page sidebar="false" standardController="Change_Management__c" extensions="ChangeManagementControllerExt,Approvalclass,QC_custom_settings" showHeader="false" standardStylesheets="false" docType="html-5.0">
    <script type="text/javascript">
$( document ).ready(function() {
    setTimeout(show(), 1000);
}); 
function show(){
$("#loading").hide();
$("#overlay").hide();
}

function cancelPopup(){
    /*var YESButtonInRedirectModalOnClick = function () { 
    if({!OR(JSENCODE($CurrentPage.parameters.pg)=='cr_init',ISBLANK(JSENCODE($CurrentPage.parameters.pg)))}){
        window.location.href = '/apex/qlt_dashboard';
        }
    };*/
    var YESButtonInRedirectModalOnClick = function () {
    if("{!JSENCODE($CurrentPage.parameters.id)}" == '' || "{!JSENCODE($CurrentPage.parameters.pg)}" == 'cr_init'){
        window.location.href = '/apex/ChangeManagement';
        }
      else{
        window.location.href = '/apex/qlt_dashboard';
        }  
    };
    var NOButtonInRedirectModalOnClick = function () {
       if("{!JSENCODE($CurrentPage.parameters.id)}" == '' || "{!JSENCODE($CurrentPage.parameters.pg)}" == 'cr_init'){
         window.location.href = '/apex/qlt_dashboard';  
         } 
    };
    $('#redirectDialog .btn-primary').bind( "click", YESButtonInRedirectModalOnClick);
    $('#redirectDialog .btn-default').bind( "click", NOButtonInRedirectModalOnClick);
        
    // Show the redirect dialog
    $('#redirectDialog').modal('show');
        
    // Remove the onClick event
    $('#redirectDialog').on('hidden.bs.modal', function () {
        $('#redirectDialog .btn-primary').unbind( "click", YESButtonInRedirectModalOnClick);
        $('#redirectDialog .btn-default').unbind( "click", NOButtonInRedirectModalOnClick);
    }) 
}

 $( document ).ready(function() {
             $('#{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}New_Due_Date__c').datetimepicker({dayViewHeaderFormat: 'DD MMM YYYY', format: "DD MMM YYYY"});
                 $('.LI_decision').hide();
                 $('.doVerifyUserNameButton').hide(); 
                 $('#ApprovaButtonIdNcContainment').hide(); 
                 var flag=false;
            
                var taskId="{!JSENCODE($CurrentPage.parameters.id)}";
                 Visualforce.remoting.Manager.invokeAction(
                        // @RemoteAction
                        '{!$RemoteAction.Approvalclass.getCMApprover}',taskId,function(result, event){
                            //  alert(+result);
                            if(result.length!=0){
                                    if(result[0].hasOwnProperty('Workitems')){
                                        
                                        
                                                $.each(result[0].Workitems,function(i, record) {
                                                    if(record.ActorId=='{!JSENCODE($User.id)}')
                                                    {
                                                    
                                                        flag=true;
                                                    }
                                                    }); 
                                                if(flag){
                                                    //alert(flag);
                                                    
                                                    $('.LI_decision').show();
                                                    $('.doVerifyUserNameButton').show();
                                                    $('#ApprovaButtonIdNcContainment').show(); 
                                                }
                                             
                                                if(result[0].SubmittedById=='{!JSENCODE($User.id)}'){
                                                    $('#javascriptidForApprovalbutton_decision_wiz-fields-wide').hide();  
                                                    $('#javascriptidForApprovalbutton_Comment_Required').show(); 
                                                    $('#javascriptidForApprovalbutton__ApprovalRescomment').addClass('javascriptidForApprovalbutton_required');   
                                                    recall=true;
                                                
                                                }
         
                                                }
                                             else{
                                                 //  alert(flag);
                                                    $('.LI_decision').hide();
                                                    $('.doVerifyUserNameButton').hide();  
                                                    $('#ApprovaButtonIdNcContainment').show();
                                                    
                                                 }  
                                
                                    }
                                else{                                       
                                    $('.LI_decision').hide();
                                    $('.doVerifyUserNameButton').hide(); 
                                    $('#ApprovaButtonIdNcContainment').hide();
                                }
                            });
                     });



                        function ApprovePopupModal(){
                            
                           
                          
                          
                $('#ahrefjavascriptidForApprovalbutton_LI_decision').html('Approve');
                $('.LI_decision').show();
                $('#javascriptidForApprovalbutton_decision_wiz-fields-wide').show();  
                $('#javascriptidForApprovalbutton_header').html('Approve {!JSENCODE($CurrentPage.Parameters.type)} Approval');
                $('#javascriptidForApprovalbutton_Comment_Required').hide(); 
                $('.doVerifyUserNameButton').show();
                $('#ApprovaButtonIdNcContainment').show(); 
                $('#javascriptidForApprovalbutton__ApprovalRescomment').removeClass('javascriptidForApprovalbutton_required');
                $('#javascriptidForApprovalbutton').modal('show');
                $('#javascriptidForApprovalbutton_user_name').val('');
                $('#javascriptidForApprovalbutton_password').val('');       
                $('#javascriptidForApprovalbutton__ApprovalRescomment').val('');
                recall=false;
                              
            }  


            function RecallPopupModal(){
                $('.LI_decision').hide();
                $('.doVerifyUserNameButton').hide(); 
                $('#ahrefjavascriptidForApprovalbutton_LI_decision').html('Recall');
                $('#javascriptidForApprovalbutton_decision_wiz-fields-wide').hide();  
                $('#javascriptidForApprovalbutton_header').html('Recall {!JSENCODE($CurrentPage.Parameters.type)} Approval');
                $('#javascriptidForApprovalbutton_Comment_Required').show(); 
                $('#javascriptidForApprovalbutton__ApprovalRescomment').addClass('javascriptidForApprovalbutton_required');   
                $('#javascriptidForApprovalbutton').modal('show');
                $('#javascriptidForApprovalbutton_user_name').val('');
                $('#javascriptidForApprovalbutton_password').val('');  
                $('#javascriptidForApprovalbutton__ApprovalRescomment').val('');                    
                recall=true;
            }
                function SubmitApprovalRequest(RecordId,UserId,listid,ApprovalReqcomment,FieldId,TochangeFieldName,newDueDate){
                     Visualforce.remoting.Manager.invokeAction(
                                // @RemoteAction
                                '{!$RemoteAction.Approvalclass.submitforApprovalRequest}',RecordId,UserId,listid,ApprovalReqcomment,FieldId,TochangeFieldName,newDueDate,function(result, event){
                                                                                                if(event.status){
                                                                                                    //location.reload();
                                                                                                    window.location.href = '/apex/changemanagement?id={!JSENCODE($CurrentPage.parameters.id)}&pg={!JSENCODE($CurrentPage.parameters.pg)}';
                                                                                                }
                                    });

            }

            function ApprovalResponse(RecordId,ApprovalRescomment,approved,FieldId){
                        Visualforce.remoting.Manager.invokeAction(
                        // @RemoteAction
                        '{!$RemoteAction.Approvalclass.submitforApprovalResponse}',RecordId,ApprovalRescomment,approved,FieldId,function(result, event){
                                                                                        if(event.status){
                                                                                            //alert('sucess');
                                                                                            //location.reload();
                                                                                            window.location.href = '/apex/changemanagement?id={!JSENCODE($CurrentPage.parameters.id)}&pg={!JSENCODE($CurrentPage.parameters.pg)}';
                                                                                        }
                            });
            }
            function ChangeFieldRequest(RecordId,listid,ApprovalReqcomment,FieldId,value,datatype,submitforApproval,label){
            console.log(RecordId+' RecordId '+listid+' listid '+ApprovalReqcomment+' ApprovalReqcomment '+FieldId+' FieldId '+value+' value '+datatype+' datatype '+submitforApproval+' submitforApproval '+label);
            Visualforce.remoting.Manager.invokeAction(
                // @RemoteAction
                '{!$RemoteAction.Approvalclass.ChangeFieldRequest}',RecordId,listid,ApprovalReqcomment,FieldId,value,datatype,submitforApproval,label,
                function(result, event){
                    if(event.status){
                        location.reload();                                                                                                        
                    }
                });
            }
</script>
<div id="overlay" style="background-color: rgba(0, 0, 0, 0.15);z-index: 999;position: absolute;left: 0;top: 0;width: 100%;height: 200%;"></div>
<div id="loading" style="height: 64px;width: 64px;align:center; position: absolute;margin: -100px 0 0 -200px;top: 80%;left: 50%;z-index:1000">
    <i class="fa fa-spinner fa-pulse fa-3x fa-fw"></i>
    <span class="sr-only">Loading...</span>
</div>
<div id="container" class="{!if($CurrentPage.parameters.pg=='cr_details_print','hidden','')}">
    <apex:composition template="qualityze_app_layout">
        <apex:define name="header_bar_component">           
           <!--Begin : Header Bar With Search Option -->               
    <c:header_bar ObjectType="{!$ObjectType.Change_Management__c}" ObjectTypeLinkTitle="Create Change Request"/>                
    <!--End  : Header Bar With Search Option -->
</apex:define>

<apex:define name="theheader">
    <!--   To do    -->
    <c:changemanagement_header recordid="{!ChangeManagement.Id}" rendered="{!NOT(ISBLANK(ChangeManagement.Id))}"/>
</apex:define>
<apex:define name="wizsteps">
    <!-- To do   -->
    <!--balu start--
    <c:cr_wizard_steps subTask="{!Change_Management__c.General_Tasks__r}" rendered="{!NOT(ISBLANK(ChangeManagement.Id))}" changeManagement="{!ChangeManagement}"></c:cr_wizard_steps>
    
    <!--balu end-->
    <c:wizard_steps_cr step="{!IF($CurrentPage.parameters.pg=='cr_init',1,IF($CurrentPage.parameters.pg=='doc_prof',2,IF($CurrentPage.parameters.pg=='cr_resolution',3,10)))}"
                rendered="{!NOT(ISBLANK(Change_Management__c.Id))}"
                requestedFieldHolder="{!Change_Management__c.Status__c},{!Change_Management__c.Resolution_Code__c}"
                tasks="{!dcTasks}" adhocTaskDetails="{!adhocTaskDetails}"
                object="{!Change_Management__c}" />
</apex:define>
<apex:define name="from-holder-title">
    <apex:outputText value="{!IF(OR(JSENCODE($CurrentPage.parameters.pg)=='cr_init',ISBLANK($CurrentPage.parameters.pg)),'Change Request Initiation',IF($CurrentPage.parameters.pg=='doc_info','Document Information',IF($CurrentPage.parameters.pg=='cr_details','CR Details','CR Resolution')))}" />
</apex:define>
<apex:define name="theform">

    <!-- Begin : CR Initiation  UI-->
   <apex:outputPanel rendered="{!OR(JSENCODE($CurrentPage.parameters.pg)=='cr_init',ISBLANK($CurrentPage.parameters.pg))}">
        <c:wiz_form FormId="crForm" FormClass="appform validate"
            postSaveJS=" window.location.href = '/apex/ChangeManagement?id=' + RecordId + '&pg=doc_info';"
            submitPage="stringify_sobject" RecordId="{!changemanagement.Id}">
            <input type="hidden" name="sobj" value="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Change_Management__c" />
            <input type="hidden" name="page" id="page" value="cr_init" />
            <input type="hidden" name="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Status__c" id="status" value="{!IF(ISBLANK(ChangeManagement.Id),'Open',ChangeManagement.Status__c)}"/>
            <input type="hidden" name="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Phase__c" id="status" value="Draft"/>
            <input type="hidden" name="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Current_Revision__c" id="CurrentRevision" value="{!IF(ChangeManagement.Change_Type__c == 'New','',ChangeManagement.Current_Revision__c)}"/>
            <apex:repeat value="{!$ObjectType.Change_Management__c.FieldSets.Initiation_Fields}"
                var="f">
                <c:wiz_field Wide="{!OR($ObjectType.Change_Management__c.Fields[f].type=='textarea',$ObjectType.Change_Management__c.Fields[f].type=='multipicklist',f==IF(NOT(ISBLANK(Prefix)),Prefix+'__Title__c','Title__c'))}"
                    FieldLabel="{!if($ObjectType.Change_Management__c.Fields[f].Label=='Owner ID','Owner',$ObjectType.Change_Management__c.Fields[f].Label)}"
                    required="{!f.required}" jsid="{!LEFT(f,LEN(f)-3)}"
                    rendered="{!AND($ObjectType.Change_Management__c.Fields[f].Accessible,f!='OwnerId')}">
                    <div class="clearfix"></div>
                    <c:wiz_richtext rendered="{!AND($ObjectType.Change_Management__c.Fields[f].type=='textarea',$ObjectType.Change_Management__c.Fields[f].htmlFormatted,NOT(OR(NOT($ObjectType.Change_Management__c.Fields[f].updateable),ChangeManagement.Status__c=='Closed',ChangeManagement.Status__c=='Pending Approval',ChangeManagement.Status__c=='Document Change Order',ChangeManagement.ChangeFieldApprovalStatus__c=='Pending Approval')))}"
                        FieldId="{!f}" FieldName="{!f}"
                        initvalue="{!changemanagement[f]}" Required="{!f.required}" maxlength="4000"></c:wiz_richtext>
                    <apex:outputpanel rendered="{!AND($ObjectType.Change_Management__c.Fields[f].type=='textarea',$ObjectType.Change_Management__c.Fields[f].htmlFormatted,OR(NOT($ObjectType.Change_Management__c.Fields[f].updateable),ChangeManagement.Status__c=='Closed',ChangeManagement.Status__c=='Pending Approval',ChangeManagement.Status__c=='Document Change Order',ChangeManagement.ChangeFieldApprovalStatus__c=='Pending Approval'))}">
                        <div class="alert alert-info">
                            <apex:outputField value="{!changemanagement[f]}" />
                        </div>
                    </apex:outputpanel>
                    <c:wiz_textarea rendered="{!AND($ObjectType.Change_Management__c.Fields[f].type=='textarea',NOT($ObjectType.Change_Management__c.Fields[f].htmlFormatted),NOT(OR(NOT($ObjectType.Change_Management__c.Fields[f].updateable),ChangeManagement.Status__c=='Closed',ChangeManagement.Status__c=='Pending Approval',ChangeManagement.Status__c=='Document Change Order',ChangeManagement.ChangeFieldApprovalStatus__c=='Pending Approval')))}"
                        ObjectName="{!$ObjectType.Change_Management__c.name}"
                        FieldId="{!f}" FieldName="{!f}"
                        initvalue="{!changemanagement[f]}" Required="{!f.required}"></c:wiz_textarea>
                    <apex:outputpanel rendered="{!AND($ObjectType.Change_Management__c.Fields[f].type=='textarea',NOT($ObjectType.Change_Management__c.Fields[f].htmlFormatted),OR(NOT($ObjectType.Change_Management__c.Fields[f].updateable),ChangeManagement.Status__c=='Closed',ChangeManagement.Status__c=='Pending Approval',ChangeManagement.Status__c=='Document Change Order',ChangeManagement.ChangeFieldApprovalStatus__c=='Pending Approval'))}">
                        <div class="alert alert-info">
                            <apex:outputField value="{!changemanagement[f]}" />
                        </div>
                    </apex:outputpanel>
                    <c:wiz_date rendered="{!$ObjectType.Change_Management__c.Fields[f].type=='date'}"
                        FieldId="{!f}" required="{!if(f.required,'','none')}none"
                        FieldName="{!f}" initdate="{!today()}"
                        updateable="{!NOT(OR(NOT($ObjectType.Change_Management__c.Fields[f].updateable),ChangeManagement.Status__c=='Closed',ChangeManagement.Status__c=='Pending Approval',ChangeManagement.Status__c=='Document Change Order',ChangeManagement.ChangeFieldApprovalStatus__c=='Pending Approval'))}">
                    </c:wiz_date>
                    <c:wiz_multi width="100%"
                        rendered="{!AND($ObjectType.Change_Management__c.Fields[f].type=='reference')}"
                        required="{!f.required}" FieldId="{!f}" multiple="false"
                        queryFields="Name"
                        querytable="{!IF(f=='OwnerId','User',$ObjectType.Change_Management__c.Fields[f].referenceTo[0])}"
                        initvalues="{value:'{!if(NOT(ISBLANK(ChangeManagement[f])),JSENCODE(ChangeManagement[f]),if(f=='OwnerId',$User.Id,ChangeManagement[f]))}',label:'{!if(NOT(ISBLANK(ChangeManagement[f])),JSENCODE(ChangeManagement[$ObjectType.Change_Management__c.Fields[f].relationshipName].Name),if(f=='OwnerId',JSENCODE($User.FirstName) + ' ' + JSENCODE($User.LastName),ChangeManagement[f]))}'}"
                        disabled="{!OR(NOT($ObjectType.Change_Management__c.Fields[f].updateable),ChangeManagement.Status__c=='Closed',ChangeManagement.Status__c=='Pending Approval',ChangeManagement.Status__c=='Document Change Order',ChangeManagement.ChangeFieldApprovalStatus__c=='Pending Approval')}">

                    </c:wiz_multi>
                    
                 <apex:outputPanel rendered="{!AND($ObjectType.Change_Management__c.Fields[f].type=='string',f=='Document_Number__c')}">
                        <div class="hidden" id="piclistDocumentNUmber">
                            
                            <c:wiz_multi width="100%"
                                         required="{!f.required}" FieldId="{!f}" multiple="false"
                                         queryFields="Name"
                                         onchange="showCurrentRevision();"
                                         querytable="Document_Profile__c"
                                         initvalues="{value: '{!JSENCODE(changemanagement[f])}', label:'{!JSENCODE(changemanagement[f])}'}"
                                         disabled="{!OR(NOT($ObjectType.Change_Management__c.Fields[f].updateable),ChangeManagement.Status__c=='Closed',ChangeManagement.Status__c=='Pending Approval',ChangeManagement.Status__c=='Document Change Order',ChangeManagement.ChangeFieldApprovalStatus__c=='Pending Approval')}">
                                
                            </c:wiz_multi>
                            
                        </div> 
                        
                    </apex:outputPanel>
                    <apex:outputPanel rendered="{!$ObjectType.Change_Management__c.Fields[f].type=='date'}">
                        <script>                            
                                        $(document).ready(function() {
                                            $("#{!f}").datetimepicker({dayViewHeaderFormat: 'DD MMM YYYY', format: "DD MMM YYYY" });
                                        });
                                        </script>

                    </apex:outputPanel>
                    <c:wiz_select ObjectName="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Change_Management__c"
                        developername="{!f}" onChangeFunction="chnageTypeMakeMandatory" width="100%"
                        rendered="{!$ObjectType.Change_Management__c.Fields[f].type=='picklist'}"
                        FieldId="{!f}" FieldName="{!f}"
                        initvalue="{!if(OR(AND(ISBLANK(changemanagement[f]),f=='Source__c'),AND(f=='Change_Request_Type__c',ISBLANK(changemanagement[f]))),'Document',changemanagement[f])}"
                        unSelectedDisplayText="   " Required="{!f.required}"
                        disabled="{!OR(NOT($ObjectType.Change_Management__c.Fields[f].updateable),ChangeManagement.Status__c=='Closed',ChangeManagement.Status__c=='Pending Approval',ChangeManagement.Status__c=='Document Change Order',ChangeManagement.ChangeFieldApprovalStatus__c=='Pending Approval')}"></c:wiz_select>
                    <apex:outputPanel rendered="{!AND($ObjectType.Change_Management__c.Fields[f].type=='multipicklist')}">
                        
                        <select id="{!f}" name="{!f}" class="form-control"
                            multiple="multiple" style="width: 100%;"></select>

                    </apex:outputPanel>
                    <c:wiz_input rendered="{!$ObjectType.Change_Management__c.Fields[f].type=='string'}"
                        fieldId="{!if(f=='Document_Number__c','Document_Number__cTobehidden',f)}" fieldname="{!f}"
                        initvalue="{!changemanagement[f]}" required="{!f.required}"
                        disabled="{!OR(NOT($ObjectType.Change_Management__c.Fields[f].updateable),ChangeManagement.Status__c=='Closed',ChangeManagement.Status__c=='Pending Approval',ChangeManagement.Status__c=='Document Change Order',ChangeManagement.ChangeFieldApprovalStatus__c=='Pending Approval')}"></c:wiz_input>
                
                     
                </c:wiz_field>
                <!--change owner cr stert-->

                    <c:wiz_field FieldLabel="Owner" required="true" jsid="owner"
                                 rendered="{!AND(f=='OwnerId',$ObjectType.Change_Management__c.Fields.OwnerId.Accessible,ISBLANK($CurrentPage.parameters.id))}">
                            <c:wiz_multi width="100%"
                                         required="{!f.required}" FieldId="{!f}__disabled" multiple="false"
                                         queryFields="Name"
                                         onchange="showCurrentRevision();"
                                         querytable="User"
                                         initvalues="{value:'{!if(NOT(ISBLANK(ChangeManagement[f])),JSENCODE(ChangeManagement[f]),if(f=='OwnerId',$User.Id,ChangeManagement[f]))}',label:'{!if(NOT(ISBLANK(ChangeManagement[f])),JSENCODE(ChangeManagement[$ObjectType.Change_Management__c.Fields[f].relationshipName].Name),if(f=='OwnerId',JSENCODE($User.FirstName) + ' ' + JSENCODE($User.LastName),ChangeManagement[f]))}'}"
                                         disabled="{!OR(NOT($ObjectType.Change_Management__c.Fields.OwnerId.updateable),ChangeManagement.Status__c=='Closed',ChangeManagement.Status__c=='Pending Approval',ChangeManagement.Status__c=='Document Change Order',ChangeManagement.ChangeFieldApprovalStatus__c=='Pending Approval')}">
                                
                            </c:wiz_multi>
                    </c:wiz_field>
                    
                    
                    
                    
                                  <apex:outputPanel rendered="{!AND(f=='OwnerId',$ObjectType.Change_Management__c.Fields.OwnerId.Accessible,NOT(ISBLANK($CurrentPage.parameters.id)))}">
                                    <div class="col-md-6 col-sm-6 col-xs-12  form-group" id="owner">
                                        <label for="owner">
                                            <span class="mandatory">
                                                *
                                            </span>Owner:
                                        </label>
                                        <apex:outputPanel rendered="{!AND(Change_Management__c.ChangeFieldApprovalStatus__c!='Pending Approval',changemanagement.Status__c=='Open')}">
                                            <label class="pull-right" for="Change">
                                                <a href="#" onclick='OwnerIdCRModal_show()'>Change</a>
                                            </label>
                                        </apex:outputPanel> 
                                        
                                        <apex:outputPanel rendered="{!AND(Change_Management__c.ChangeFieldApprovalStatus__c=='Pending Approval',changemanagement.Status__c=='Open')}">
                                            <label class="pull-right" for="Change">
                                                <a href="#" onclick='OwnerIdCRModal_show()'>Pending Approval</a>
                                            </label>
                                        </apex:outputPanel> 
                                        <br/>
                                        <c:wiz_multi disabled="true"
                                                     width="100%" FieldId="disableOwnerId" multiple="false"
                                                     queryFields="Name" querytable="User" onchange=""
                                                     initValues="{label: '{!JSENCODE(IF(NOT(ISBLANK(changemanagement.OwnerId)) , changemanagement.Owner.Name, $User.FirstName + ' ' + $User.LastName))}',
                                                                 value: '{!JSENCODE(IF(NOT(ISBLANK(changemanagement.OwnerId)), changemanagement.OwnerId, $User.Id))}'}" />
                                    </div>
                                </apex:outputPanel>
                <!--change owner cr end-->                                

            </apex:repeat>
            
            <div class="clearfix"></div>
            
            <div class="hidden" id="SourceRelatedFields">
            <apex:outputPanel rendered="{!OR(JSENCODE($CurrentPage.parameters.pg)=='cr_init',ISBLANK($CurrentPage.parameters.pg))}">
             <apex:outputPanel layout="none" rendered="{!OR($ObjectType.Change_Management__c.Fields.NC_Number__c.Accessible,$ObjectType.Change_Management__c.Fields.CAPA_Number__c.Accessible,$ObjectType.Change_Management__c.Fields.Audit_Number__c.Accessible)}">
                 
                  <apex:repeat value="{!$ObjectType.Change_Management__c.FieldSets.Source_Related_Fieldset}"
                                    var="f">
                                    
                      <c:wiz_field Wide="{!OR($ObjectType.Change_Management__c.Fields[f].type=='textarea',$ObjectType.Change_Management__c.Fields[f].type=='multipicklist')}"
                                        FieldLabel="{!$ObjectType.Change_Management__c.Fields[f].Label}"
                                        required="{!f.required}" jsid="{!LEFT(f,LEN(f)-3)}"
                                        rendered="{!$ObjectType.Change_Management__c.Fields[f].Accessible}">
                          
                          <c:wiz_multi width="100%"
                                            rendered="{!$ObjectType.Change_Management__c.Fields[f].type=='reference'}"
                                            required="{!f.required}" FieldId="{!f}" multiple="false"
                                            queryFields="Name"
                                            querytable="{!IF(f=='OwnerId','User',$ObjectType.Change_Management__c.Fields[f].referenceTo[0])}"
                                            filtervalue=""
                                            initvalues="{value: '{!JSENCODE(changemanagement[f])}', label:'{!JSENCODE(changemanagement[$ObjectType.Change_Management__c.Fields[f].relationshipName].Name)}'}"
                                            disabled="{!OR(NOT($ObjectType.Change_Management__c.Fields[f].updateable),ChangeManagement.Status__c=='Closed',ChangeManagement.Status__c=='Pending Approval',ChangeManagement.Status__c=='Document Change Order',ChangeManagement.ChangeFieldApprovalStatus__c=='Pending Approval')}">
                                        </c:wiz_multi>
                                        
                          <c:wiz_input rendered="{!$ObjectType.Change_Management__c.Fields[f].type=='string'}"
                                            fieldId="{!f}" fieldname="{!f}"
                                            initvalue="{!changemanagement[f]}"
                                            required="{!f.required}"
                                            disabled="{!OR(NOT($ObjectType.Change_Management__c.Fields[f].updateable),ChangeManagement.Status__c=='Closed',ChangeManagement.Status__c=='Pending Approval',ChangeManagement.Status__c=='Document Change Order',ChangeManagement.ChangeFieldApprovalStatus__c=='Pending Approval')}"></c:wiz_input>
                          
                      
                      </c:wiz_field>              
                  </apex:repeat>
             </apex:outputPanel>
            </apex:outputPanel> 
            </div>

            <!--  Additional fields   -->
            <apex:outputPanel layout="none"
                rendered="{!OR($ObjectType.Change_Management__c.Fields.Initiating_Site__c.Accessible,$ObjectType.Change_Management__c.Fields.Business_Unit__c.Accessible,$ObjectType.Change_Management__c.Fields.Impacted_Sites__c.Accessible)}">
            
                                <apex:repeat value="{!$ObjectType.Change_Management__c.FieldSets.Additional_Fields}"
                                    var="f">
                                    <c:wiz_field Wide="{!OR($ObjectType.Change_Management__c.Fields[f].type=='textarea',$ObjectType.Change_Management__c.Fields[f].type=='multipicklist',f==IF(NOT(ISBLANK(Prefix)),Prefix+'__Title__c','Title__c'))}"
                                        FieldLabel="{!$ObjectType.Change_Management__c.Fields[f].Label}"
                                        required="{!f.required}" jsid="{!LEFT(f,LEN(f)-3)}"
                                        rendered="{!$ObjectType.Change_Management__c.Fields[f].Accessible}">
                                        <div class="clearfix"></div>
                                        <c:wiz_richtext rendered="{!AND($ObjectType.Change_Management__c.Fields[f].type=='textarea',$ObjectType.Change_Management__c.Fields[f].htmlFormatted,NOT(OR(NOT($ObjectType.Change_Management__c.Fields[f].updateable),ChangeManagement.Status__c=='Closed',ChangeManagement.Status__c=='Pending Approval',ChangeManagement.Status__c=='Document Change Order',ChangeManagement.ChangeFieldApprovalStatus__c=='Pending Approval')))}"
                                            FieldId="{!f}" FieldName="{!f}"
                                            initvalue="{!changemanagement[f]}"
                                            Required="{!f.required}"></c:wiz_richtext>
                                        <apex:outputpanel rendered="{!AND($ObjectType.Change_Management__c.Fields[f].type=='textarea',$ObjectType.Change_Management__c.Fields[f].htmlFormatted,OR(NOT($ObjectType.Change_Management__c.Fields[f].updateable),ChangeManagement.Status__c=='Closed',ChangeManagement.Status__c=='Pending Approval',ChangeManagement.Status__c=='Document Change Order',ChangeManagement.ChangeFieldApprovalStatus__c=='Pending Approval'))}">
                                            <div class="alert alert-info">
                                                <apex:outputField value="{!changemanagement[f]}" />
                                            </div>
                                        </apex:outputpanel>
                                        <c:wiz_textarea rendered="{!AND($ObjectType.Change_Management__c.Fields[f].type=='textarea',f!=IF(NOT(ISBLANK(Prefix)),Prefix+'__Impacted_Sites__c','Impacted_Sites__c'),NOT($ObjectType.Change_Management__c.Fields[f].htmlFormatted),NOT(OR(NOT($ObjectType.Change_Management__c.Fields[f].updateable),ChangeManagement.Status__c=='Closed',ChangeManagement.Status__c=='Pending Approval',ChangeManagement.Status__c=='Document Change Order',ChangeManagement.ChangeFieldApprovalStatus__c=='Pending Approval')))}"
                                            ObjectName="{!$ObjectType.Change_Management__c.name}"
                                            FieldId="{!f}" FieldName="{!f}"
                                            initvalue="{!changemanagement[f]}"
                                            Required="{!f.required}"></c:wiz_textarea>
                                        <apex:outputpanel rendered="{!AND($ObjectType.Change_Management__c.Fields[f].type=='textarea',f!=IF(NOT(ISBLANK(Prefix)),Prefix+'__Impacted_Sites__c','Impacted_Sites__c'),NOT($ObjectType.Change_Management__c.Fields[f].htmlFormatted),OR(NOT($ObjectType.Change_Management__c.Fields[f].updateable),ChangeManagement.Status__c=='Closed',ChangeManagement.Status__c=='Pending Approval',ChangeManagement.Status__c=='Document Change Order',ChangeManagement.ChangeFieldApprovalStatus__c=='Pending Approval'))}">
                                            <div class="alert alert-info">
                                                <apex:outputField value="{!changemanagement[f]}" />
                                            </div>
                                        </apex:outputpanel>
                                         <apex:outputPanel rendered="{!AND(f==IF(NOT(ISBLANK(Prefix)),Prefix+'__Impacted_Sites__c','Impacted_Sites__c'),ISBLANK($CurrentPage.parameters.id))}">
                                               
                                                <c:wiz_multi width="100%"
                                                             required="{!f.required}" FieldId="{!f}" multiple="true"
                                                             onchange="removeselectdots"
                                                             queryFields="Name"
                                                             querytable="Manufacturing_Site__c"
                                                             initvalues="{value: '{!JSENCODE(changemanagement[f])}', label:'{!JSENCODE(changemanagement[$ObjectType.Change_Management__c.Fields[f].relationshipName].Name)}'}"
                                                             disabled="{!OR(NOT($ObjectType.Change_Management__c.Fields[f].updateable),ChangeManagement.Status__c=='Closed',ChangeManagement.Status__c=='Pending Approval',ChangeManagement.Status__c=='Document Change Order',ChangeManagement.ChangeFieldApprovalStatus__c=='Pending Approval')}">
                                                    
                                                </c:wiz_multi> 
                                                
                                            </apex:outputPanel>
                                       <apex:outputPanel rendered="{!AND(f==IF(NOT(ISBLANK(Prefix)),Prefix+'__Impacted_Sites__c','Impacted_Sites__c'),NOT(ISBLANK($CurrentPage.parameters.id)))}">
                                         <div class="col-md-12">
                                          <c:wiz_multi width="100%"
                                             required="{!f.required}"
                                             FieldId="{!f}"
                                             multiple="true"
                                             FieldName="{!f}"
                                             queryFields="Name"
                                             querytable="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Manufacturing_Site__c"
                                             dataid=""                                      
                                             disabled="{!OR(NOT($ObjectType.Change_Management__c.Fields[f].updateable),ChangeManagement.Status__c=='Closed',ChangeManagement.Status__c=='Pending Approval',ChangeManagement.Status__c=='Document Change Order',ChangeManagement.ChangeFieldApprovalStatus__c=='Pending Approval')}">
                                           <apex:repeat value="{!ImpactedSites}" var="impatedsite">
                                            <option selected="selected" value="{!JSENCODE(impatedsite.id)}">{!JSENCODE(impatedsite.Name)}</option>
                                           </apex:repeat>
                                           </c:wiz_multi>                                    
                                           </div>
                    
                    <!-- initvalues="{value: '{!JSENCODE(documentProfile[f])}', label:'{!JSENCODE(documentProfile[$ObjectType.Document_Profile__c.Fields[f].relationshipName].Name)}'}"-->                       
                                      </apex:outputPanel>                                      
                                        <c:wiz_date rendered="{!$ObjectType.Change_Management__c.Fields[f].type=='date'}"
                                            FieldId="{!f}" required="{!if(f.required,'','none')}none"
                                            FieldName="{!f}" initdate=""
                                            updateable="{!NOT(OR(NOT($ObjectType.Change_Management__c.Fields[f].updateable),ChangeManagement.Status__c=='Closed',ChangeManagement.Status__c=='Pending Approval',ChangeManagement.Status__c=='Document Change Order',ChangeManagement.ChangeFieldApprovalStatus__c=='Pending Approval'))}">
                                        </c:wiz_date>


                                        <c:wiz_multi width="100%"
                                            rendered="{!$ObjectType.Change_Management__c.Fields[f].type=='reference'}"
                                            required="{!f.required}" FieldId="{!f}" multiple="false"
                                            queryFields="Name"
                                            querytable="{!IF(f=='OwnerId','User',$ObjectType.Change_Management__c.Fields[f].referenceTo[0])}"
                                            filtervalue=""
                                            initvalues="{value: '{!JSENCODE(changemanagement[f])}', label:'{!JSENCODE(changemanagement[$ObjectType.Change_Management__c.Fields[f].relationshipName].Name)}'}"
                                            disabled="{!OR(NOT($ObjectType.Change_Management__c.Fields[f].updateable),ChangeManagement.Status__c=='Closed',ChangeManagement.Status__c=='Pending Approval',ChangeManagement.Status__c=='Document Change Order',ChangeManagement.ChangeFieldApprovalStatus__c=='Pending Approval')}">

                                        </c:wiz_multi>
                                        
                                        <apex:outputPanel rendered="{!AND($ObjectType.Change_Management__c.Fields[f].type=='string',f=='Document_Number__c')}">
                                             <div class="hidden" id="piclistDocumentNUmberAdd">
                            
                                       <c:wiz_multi width="100%"
                                         required="{!f.required}" FieldId="{!f}" multiple="false"
                                         queryFields="Name"
                                         onchange=""
                                         querytable="Document_Profile__c"
                                         initvalues="{value: '{!JSENCODE(changemanagement[f])}', label:'{!JSENCODE(changemanagement[f])}'}"
                                         disabled="{!OR(NOT($ObjectType.Change_Management__c.Fields[f].updateable),ChangeManagement.Status__c=='Closed',ChangeManagement.Status__c=='Pending Approval',ChangeManagement.Status__c=='Document Change Order',ChangeManagement.ChangeFieldApprovalStatus__c=='Pending Approval')}">
                                
                                       </c:wiz_multi>
                            
                                            </div> 
                        
                                          </apex:outputPanel>
                                        <apex:outputPanel rendered="{!$ObjectType.Change_Management__c.Fields[f].type=='date'}">
                                            <script>                            
                                        $(document).ready(function() {
                                            $("#{!f}").datetimepicker({dayViewHeaderFormat: 'DD MMM YYYY', format: "DD MMM YYYY" });
                                        });
                                        </script>

                                        </apex:outputPanel>

                                        <c:wiz_select ObjectName="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Change_Management__c"
                                            developername="{!f}" onChangeFunction="" width="100%"
                                            rendered="{!OR($ObjectType.Change_Management__c.Fields[f].type=='picklist')}"
                                            FieldId="{!f}" FieldName="{!f}"
                                            initvalue="{!IF(AND(ISBLANK(changemanagement[f]),f=='Source__c'),'Document',changemanagement[f])}"
                                            unSelectedDisplayText="   " Required="{!f.required}"
                                            disabled="{!OR(NOT($ObjectType.Change_Management__c.Fields[f].updateable),ChangeManagement.Status__c=='Closed',ChangeManagement.Status__c=='Pending Approval',ChangeManagement.Status__c=='Document Change Order',ChangeManagement.ChangeFieldApprovalStatus__c=='Pending Approval')}"></c:wiz_select>
                                        <apex:outputPanel rendered="{!AND($ObjectType.Change_Management__c.Fields[f].type=='multipicklist')}">

                                            <select id="{!f}" name="{!f}" class="form-control"
                                                multiple="multiple" style="width: 100%;"></select>


                                        </apex:outputPanel>
                                        <c:wiz_input rendered="{!$ObjectType.Change_Management__c.Fields[f].type=='string'}"
                                            fieldId="{!f}" fieldname="{!f}"
                                            initvalue="{!changemanagement[f]}"
                                            required="{!f.required}"
                                            disabled="{!OR(NOT($ObjectType.Change_Management__c.Fields[f].updateable),ChangeManagement.Status__c=='Closed',ChangeManagement.Status__c=='Pending Approval',ChangeManagement.Status__c=='Document Change Order',ChangeManagement.ChangeFieldApprovalStatus__c=='Pending Approval')}"></c:wiz_input>
                                    </c:wiz_field>
                                </apex:repeat>
                    

            </apex:outputPanel>
        
            <div class="clearfix"></div>
        
        <div class="clearfix"></div>

        <apex:variable value="{!0}" var="showCustomFieldSection"/>
        <apex:repeat value="{!$ObjectType.Change_Management__c.FieldSets.ChangeManagement_Custom_Fields }" var="f">
         <apex:outputPanel rendered="{!$ObjectType.Change_Management__c.Fields[f].Accessible}">
         <apex:variable value="{!showCustomFieldSection+1}" var="showCustomFieldSection"/>
         </apex:outputPanel>
        </apex:repeat>
        <apex:outputPanel rendered="{!AND($ObjectType.Change_Management__c.FieldSets.ChangeManagement_Custom_Fields.size!=0,showCustomFieldSection!=0)}">
            <div class="push-down panel-group"></div>
            <div class="panel-group col-md-12" id="accordionCustomFields" role="tablist"
                 aria-multiselectable="true">
                <div class="panel panel-default">
                    <div class="panel-heading" role="tab" id="headingOneCustomFields">
                        <h4 class="panel-title">
                            <a data-toggle="collapse" data-parent="#accordionCustomFields"
                               href="#collapseOneCustomFields" aria-expanded="true"
                               aria-controls="collapseOne" class="collapsed"> <span class="col-exp"></span> Custom Fields
                            </a>
                        </h4>
                    </div>
                                            <div id="collapseOneCustomFields" class="panel-collapse collapse out"
                            role="tabpanel" aria-labelledby="headingOne">
                            <div class="panel-body">
                                <apex:repeat value="{!$ObjectType.Change_Management__c.FieldSets.ChangeManagement_Custom_Fields }"
                                    var="f">
                                    <c:wiz_field Wide="{!OR($ObjectType.Change_Management__c.Fields[f].type=='textarea',$ObjectType.Change_Management__c.Fields[f].type=='multipicklist',f==IF(NOT(ISBLANK(Prefix)),Prefix+'__UD_text9__c','UD_text9__c'))}"
                                        FieldLabel="{!$ObjectType.Change_Management__c.Fields[f].Label}"
                                        required="{!f.required}" jsid="{!LEFT(f,LEN(f)-3)}"
                                        rendered="{!$ObjectType.Change_Management__c.Fields[f].Accessible}">
                                        <div class="clearfix"></div>
                                        <c:wiz_richtext maxlength="{!if($ObjectType.Change_Management__c.Fields[f].length>2000,2000,$ObjectType.Change_Management__c.Fields[f].length)}" rendered="{!AND($ObjectType.Change_Management__c.Fields[f].type=='textarea',$ObjectType.Change_Management__c.Fields[f].htmlFormatted,NOT(OR(NOT($ObjectType.Change_Management__c.Fields[f].updateable),ChangeManagement.Status__c=='Closed',ChangeManagement.Status__c=='Pending Approval',ChangeManagement.Status__c=='Document Change Order',ChangeManagement.ChangeFieldApprovalStatus__c=='Pending Approval')))}"
                                            FieldId="{!f}" FieldName="{!f}"
                                            initvalue="{!changemanagement[f]}"
                                            Required="{!f.required}"></c:wiz_richtext>
                                        <apex:outputpanel rendered="{!AND($ObjectType.Change_Management__c.Fields[f].type=='textarea',$ObjectType.Change_Management__c.Fields[f].htmlFormatted,OR(NOT($ObjectType.Change_Management__c.Fields[f].updateable),ChangeManagement.Status__c=='Closed',ChangeManagement.Status__c=='Pending Approval',ChangeManagement.Status__c=='Document Change Order',ChangeManagement.ChangeFieldApprovalStatus__c=='Pending Approval'))}">
                                            <div class="alert alert-info">
                                                <apex:outputField value="{!changemanagement[f]}" />
                                            </div>
                                        </apex:outputpanel>
                                        <c:wiz_textarea maxlength="{!if($ObjectType.Change_Management__c.Fields[f].length>2000,2000,$ObjectType.Change_Management__c.Fields[f].length)}" rendered="{!AND($ObjectType.Change_Management__c.Fields[f].type=='textarea',NOT($ObjectType.Change_Management__c.Fields[f].htmlFormatted),NOT(OR(NOT($ObjectType.Change_Management__c.Fields[f].updateable),ChangeManagement.Status__c=='Closed',ChangeManagement.Status__c=='Pending Approval',ChangeManagement.Status__c=='Document Change Order',ChangeManagement.ChangeFieldApprovalStatus__c=='Pending Approval')))}"
                                            ObjectName="{!$ObjectType.Change_Management__c.name}"
                                            FieldId="{!f}" FieldName="{!f}"
                                            initvalue="{!changemanagement[f]}"
                                            Required="{!f.required}"></c:wiz_textarea>
                                        <apex:outputpanel rendered="{!AND($ObjectType.Change_Management__c.Fields[f].type=='textarea',NOT($ObjectType.Change_Management__c.Fields[f].htmlFormatted),OR(NOT($ObjectType.Change_Management__c.Fields[f].updateable),ChangeManagement.Status__c=='Closed',ChangeManagement.Status__c=='Pending Approval',ChangeManagement.Status__c=='Document Change Order',ChangeManagement.ChangeFieldApprovalStatus__c=='Pending Approval'))}">
                                            <div class="alert alert-info">
                                                <apex:outputField value="{!changemanagement[f]}" />
                                            </div>
                                        </apex:outputpanel>
                                        <c:wiz_date rendered="{!$ObjectType.Change_Management__c.Fields[f].type=='date'}"
                                            FieldId="{!f}" required="{!if(f.required,'','none')}none"
                                            FieldName="{!f}" initdate="{!changemanagement[f]}"
                                            updateable="{!NOT(OR(NOT($ObjectType.Change_Management__c.Fields[f].updateable),ChangeManagement.Status__c=='Closed',ChangeManagement.Status__c=='Pending Approval',ChangeManagement.Status__c=='Document Change Order',ChangeManagement.ChangeFieldApprovalStatus__c=='Pending Approval'))}">
                                        </c:wiz_date>


                                        <c:wiz_multi width="100%"
                                            rendered="{!$ObjectType.Change_Management__c.Fields[f].type=='reference'}"
                                            required="{!f.required}" FieldId="{!f}" multiple="false"
                                            queryFields="Name"
                                            querytable="{!IF(f=='OwnerId','User',$ObjectType.Change_Management__c.Fields[f].referenceTo[0])}"
                                            filtervalue=""
                                            initvalues="{value: '{!JSENCODE(changemanagement[f])}', label:'{!JSENCODE(changemanagement[$ObjectType.Change_Management__c.Fields[f].relationshipName].Name)}'}"
                                            disabled="{!OR(NOT($ObjectType.Change_Management__c.Fields[f].updateable),ChangeManagement.Status__c=='Closed',ChangeManagement.Status__c=='Pending Approval',ChangeManagement.Status__c=='Document Change Order',ChangeManagement.ChangeFieldApprovalStatus__c=='Pending Approval')}">

                                        </c:wiz_multi>
                                        <apex:outputPanel rendered="{!AND($ObjectType.Change_Management__c.Fields[f].type=='string',f=='Document_Number__c')}">
                                           <div class="hidden" id="piclistDocumentNUmber">
                            
                                            <c:wiz_multi width="100%"
                                         required="{!f.required}" FieldId="{!f}" multiple="false"
                                         queryFields="Name"
                                         onchange=""
                                         querytable="Document_Profile__c"
                                         initvalues="{value: '{!JSENCODE(changemanagement[f])}', label:'{!JSENCODE(changemanagement[f])}'}"
                                         disabled="{!OR(NOT($ObjectType.Change_Management__c.Fields[f].updateable),ChangeManagement.Status__c=='Closed',ChangeManagement.Status__c=='Pending Approval',ChangeManagement.Status__c=='Document Change Order',ChangeManagement.ChangeFieldApprovalStatus__c=='Pending Approval')}">
                                
                                           </c:wiz_multi>
                            
                                        </div> 
                        
                                     </apex:outputPanel>
                                        <apex:outputPanel rendered="{!$ObjectType.Change_Management__c.Fields[f].type=='date'}">
                                            <script>                            
                                        $(document).ready(function() {
                                            $("#{!f}").datetimepicker({dayViewHeaderFormat: 'DD MMM YYYY', format: "DD MMM YYYY" });
                                        });
                                        </script>

                                        </apex:outputPanel>

                                        <c:wiz_select ObjectName="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Change_Management__c"
                                            developername="{!f}" onChangeFunction="" width="100%"
                                            rendered="{!OR($ObjectType.Change_Management__c.Fields[f].type=='picklist')}"
                                            FieldId="{!f}" FieldName="{!f}"
                                            initvalue="{!IF(AND(ISBLANK(changemanagement[f]),f=='Source__c'),'Document',changemanagement[f])}"
                                            unSelectedDisplayText="   " Required="{!f.required}"
                                            disabled="{!OR(NOT($ObjectType.Change_Management__c.Fields[f].updateable),ChangeManagement.Status__c=='Closed',ChangeManagement.Status__c=='Pending Approval',ChangeManagement.Status__c=='Document Change Order',ChangeManagement.ChangeFieldApprovalStatus__c=='Pending Approval')}"></c:wiz_select>
                                        <apex:outputPanel rendered="{!AND($ObjectType.Change_Management__c.Fields[f].type=='multipicklist')}">

                                            <select id="{!f}" name="{!f}" class="form-control"
                                                multiple="multiple" style="width: 100%;"></select>


                                        </apex:outputPanel>
                                        <c:wiz_input maxlength="{!if($ObjectType.Change_Management__c.Fields[f].length>2000,2000,$ObjectType.Change_Management__c.Fields[f].length)}" rendered="{!$ObjectType.Change_Management__c.Fields[f].type=='string'}"
                                            fieldId="{!f}" fieldname="{!f}"
                                            initvalue="{!changemanagement[f]}"
                                            required="{!f.required}"
                                            disabled="{!OR(NOT($ObjectType.Change_Management__c.Fields[f].updateable),ChangeManagement.Status__c=='Closed',ChangeManagement.Status__c=='Pending Approval',ChangeManagement.Status__c=='Document Change Order',ChangeManagement.ChangeFieldApprovalStatus__c=='Pending Approval')}"></c:wiz_input>
                                    </c:wiz_field>
                                </apex:repeat>
                            </div>
                        </div>

                    </div>
                </div>

            </apex:outputPanel>

            
        </c:wiz_form>
        
        <!--change cr owner start-->
        <apex:outputPanel rendered="{!AND($ObjectType.Change_Management__c.Fields.OwnerId.Accessible,NOT(ISBLANK($CurrentPage.parameters.id)))}">
            <!--Update change Owner  start-->
            
            <c:wizard_ChangeField field="OwnerId__CHID"
                                  datatype="{!$ObjectType.Change_Management__c.Fields.OwnerId.type}"
                                  recordId="{!ChangeManagement.Id}"
                                  ModalId="OwnerIdCRModal" typeofApprover="Change_Request_Approver"
                                  fieldlabel="Owner"
                                  InApproval="{!ChangeManagement.ChangeFieldApprovalStatus__c=='Pending Approval'}"
                                  sObjJsid="CRJSOwnerId" ToChangeFieldId="OwnerId__CHID" TochangeFieldName="OwnerId" >
                <c:wiz_field Wide="false"
                             FieldLabel="{!if($ObjectType.Change_Management__c.Fields['OwnerId'].Label=='Owner ID','Owner',$ObjectType.Change_Management__c.Fields['OwnerId'].Label)}"
                             required="true" jsid="OwnerId"
                             rendered="{!$ObjectType.Change_Management__c.Fields.OwnerId.Accessible}">
                    <c:wiz_multi rendered="true"
                                 FieldId="OwnerId__ID" required="true"
                                 FieldName="OwnerId__Name"
                                 initValues="{label: '{!JSENCODE(IF(NOT(ISBLANK(changemanagement.OwnerId)) , changemanagement.Owner.Name, $User.FirstName + ' ' + $User.LastName))}',value: '{!JSENCODE(IF(NOT(ISBLANK(changemanagement.OwnerId)), changemanagement.OwnerId, $User.Id))}'}"    
                                 querytable="User" width="100%"
                                 disabled="true">
                    </c:wiz_multi>
                    
                </c:wiz_field>
                <c:wiz_field Wide="false"
                             FieldLabel="{!if($ObjectType.Change_Management__c.Fields.OwnerId.Label=='Owner ID','Owner',$ObjectType.Change_Management__c.Fields.OwnerId.Label)}"
                             required="true" jsid="CROwnerId"
                             rendered="{!$ObjectType.Change_Management__c.Fields['OwnerId'].Accessible}">
                    <c:wiz_multi rendered="{!AND(ChangeManagement.ChangeFieldApprovalStatus__c!='Pending Approval',$ObjectType.Change_Management__c.Fields.OwnerId.type=='reference')}"
                                 FieldId="OwnerId__CHID" required=""  querytable="User"
                                 FieldName="OwnerId__CHID" initValues="" width="100%"
                                 disabled="false">
                    </c:wiz_multi>                                 
                    <c:wiz_multi rendered="{!AND(ChangeManagement.ChangeFieldApprovalStatus__c=='Pending Approval',$ObjectType.Change_Management__c.Fields.OwnerId.type=='reference')}"
                                 FieldId="OwnerId__CHID" required=""  querytable="User"
                                 initValues="{label: '{!JSENCODE(IF(NOT(ISBLANK(changemanagement.OwnerId)) , changemanagement.New_Owner__r.Name, $User.FirstName + ' ' + $User.LastName))}',value: '{!JSENCODE(IF(NOT(ISBLANK(changemanagement.OwnerId)), changemanagement.New_Owner__c, $User.Id))}'}"    
                                 FieldName="OwnerId__CHID"  width="100%"
                                 disabled="true">                                 
                    </c:wiz_multi>
                </c:wiz_field>
            </c:wizard_ChangeField>     
            
            <!--Update change Owner  end-->  
        </apex:outputPanel>
        <!--change cr owner end-->
    </apex:outputPanel>
    
<!-- End of CR Init UI --><!-- javascript for CR Init --->
    <apex:outputPanel rendered="{!OR($CurrentPage.parameters.pg=='cr_init',ISBLANK($CurrentPage.parameters.pg))}">
        <script>
        
               
                var getDocuments = [];
                //var isLoaded = false;           <!-- v1.1 starts here  -->
        $( document ).ready(function() {
         //alert('doumnet ready');
        //$("#Change_Request_Type__c,#Source__c,#Change_Type__c").on('change', chnageTypeMakeMandatory);
                var param = '{!$CurrentPage.parameters.pg}';
                var pageids = '{!$CurrentPage.parameters.Id}';
                
                checkForSourceDependentFieldValues();
                
            
                var documentProfId = '{!$CurrentPage.parameters.dpid}';
                var docmntType = '{!$CurrentPage.parameters.dpty}';
                var docNumber = '{!$CurrentPage.parameters.dpname}';
                console.log('parameter is here for type'+docmntType);
                
                if(docmntType != '' || documentProfId != '' || docNumber!=''){
                   console.log('inside change request functiontype'+docmntType+'profileId'+docNumber);
                   if(docmntType == 'Temp' || docmntType == 'Revise'){
                   
                      console.log('inside second if');
                      $('#piclistDocumentNUmber').removeClass('hidden');
                      $('#Document_Number__cTobehidden').addClass('hidden');
                      //$('#Change_Type__c').val(docmntType);
                      //$('#Change_Type__c option:selected').text(docmntType);
                      $('#{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Change_Type__c').html('<option selected="selected" value="' + docmntType + '">' + escapeHtml(docmntType) + '</option>').trigger('change');
                      
                      $('#select2-Change_Type__c-container').attr('title',docmntType).text(docmntType);
                      $('#{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Document_Number__c').html('<option selected="selected" value="' + documentProfId + '">' + escapeHtml(documentProfId) + '</option>').trigger('change');
                      $('#select2-Document_Number__c-container').attr('title',documentProfId).text(documentProfId);
                      //$('#Document_Number__cTobehidden').val(docNumber);
                      
                      getDocumentCurrentRevision(documentProfId);
                      
                    } 
                }
             
            var documentIds = $('#select2-Document_Number__c-container').attr('title');
            console.log('documentIds is here'+documentIds);
            console.log('chnge type'+$('#select2-Change_Type__c-container').attr('title'));
           
             console.log('getDocumentProfileName function'+documentIds);
             
            getDocumentProfileName(documentIds);
                      
        
            if('{!JSENCODE(ChangeManagement.Status__c)}'=='Closed' || '{!JSENCODE(ChangeManagement.Status__c)}'=='Document Change Order' || '{!JSENCODE(ChangeManagement.Status__c)}'=='Pending Approval' || '{!JSENCODE(ChangeManagement.ChangeFieldApprovalStatus__c)}'=='Pending Approval'){
            $('#Impacted_Sites__c').attr('disabled','disabled');
            }
            
            $('#Current_Revision__c').attr('disabled','disabled');
            
            
            <apex:repeat value="{!Domncs}" var="docmnts">
                        getDocuments.push('{!JSENCODE(docmnts.Id)}@{!JSENCODE(docmnts.Name)}@{!JSENCODE(docmnts.Current_Rev__c)}');
                    </apex:repeat>
                    
             var changeRequestType;              <!-- v1.1 ends here -->
             
            var today = new Date(); 
            $('#{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Due_Date__c').datetimepicker().data("DateTimePicker").minDate(today.getDate());
            
       
          /*  var availableImpctedSites='{!JSENCODE(availableImpctedSites )}'.split(','); 
            var selectedImpctedSites='{!JSENCODE(ChangeManagement.Impacted_Sites__c)}'.split(',');
            console.log(availableImpctedSites);
            console.log(selectedImpctedSites);
            for(var i=0;i<availableImpctedSites.length-1;i++){
                console.log('Impacted Site  '+  availableImpctedSites[i] +'    '+jQuery.inArray(availableImpctedSites[i],selectedImpctedSites));
                if(jQuery.inArray(availableImpctedSites[i],selectedImpctedSites)>-1){
                    $("#Impacted_Sites__c").append('<option selected="selected" value='+availableImpctedSites[i]+'>'+availableImpctedSites[i]+'</option>');
                }
                else{
                    $("#Impacted_Sites__c").append('<option value='+availableImpctedSites[i]+'>'+availableImpctedSites[i]+'</option>');
                } 
                
            } 
          
            $("#Impacted_Sites__c").select2({
                closeOnSelect:false
            });*/
            
        });
        
        function getDocumentCurrentRevision(documntid){
         console.log('documntid i shere'+documntid);
              Visualforce.remoting.Manager.invokeAction(
          // @RemoteAction
            '{!$RemoteAction.ChangeManagementControllerExt.getDocumentCurrentRevision}',documntid,function(result, event){
            if(event.status){
                $('#Current_Revision__c').val(result.Current_Rev__c);     
                                        
               }
              
           }
           );
          
        }
       
       function removeselectdots(){
           alert('inside removeselectdots'+$('#Impacted_Sites').find('ul.select2-selection__rendered').find('li.select2-selection__choice').text());
           $('#Impacted_Sites').find('ul.select2-selection__rendered').find('li.select2-selection__choice:contains(Select ....)').remove();
             } 
       
        
        function checkForSourceDependentFieldValues(){
                    var sourceVal = $('#Source__c').val();
                    console.log('source value is here'+sourceVal);
                    
                    if(sourceVal == 'CAPA'){
                          console.log('if it is CAPA');
                          $('#SourceRelatedFields').removeClass('hidden');
                          $('#NC_Number').addClass('hidden');
                          $('#Audit_Number').addClass('hidden');
                          $('#CAPA_Number').removeClass('hidden');
                    }
                   else if(sourceVal == 'NC'){
                          console.log('if it is NC');
                          $('#SourceRelatedFields').removeClass('hidden');
                          $('#CAPA_Number').addClass('hidden');
                          $('#NC_Number').removeClass('hidden');
                          $('#Audit_Number').addClass('hidden');  
                    }
                   else if(sourceVal == 'Audit'){
                          console.log('if it is Audit');
                          $('#SourceRelatedFields').removeClass('hidden');
                          $('#NC_Number').addClass('hidden');
                          $('#Audit_Number').removeClass('hidden');
                          $('#CAPA_Number').addClass('hidden');
                    }
                   else if(sourceVal == 'Document' || sourceVal == 'Product' || sourceVal == 'Process'){
                          console.log('if it is Document');
                          $('#SourceRelatedFields').addClass('hidden'); 
                    } 
                   
                }
            
        var initialchangeTypeName;
        function getDocumentProfileName(docId){ 
        //alert('inside getDocumentProfileName');
            console.log('docId inside the function coming'+docId);
             Visualforce.remoting.Manager.invokeAction(
          // @RemoteAction
            '{!$RemoteAction.ChangeManagementControllerExt.getDocumentProfileName}',docId,function(result, event){
            if(result){
                //console.log(result);
                //console.log('result name'+result.Name);
                console.log('result name'+result.Id);
              var x =  $('#select2-Document_Number__c-container').attr('title',result.Name).text(result.Name); 
              if(result.Id){
                $('#{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Document_Number__c').html('<option selected="selected" value="' + result.Id + '">' + escapeHtml(result.Name) + '</option>').trigger('change');
                       }
               }
              
           }
           );
        } 
        <!-- v1.1 starts here  -->
           
                function chnageTypeMakeMandatory(){
                //alert('alert chnageTypeMakeMandatory');
                 console.log('Type  '+$('#Change_Type__c').val());
                    
                    console.log('type is jere');
                     
                          $('#Document_Number__c').val('');
                          $('#select2-Document_Number__c-container').attr('title','');
                          $('#select2-Document_Number__c-container').text('');
                       // $('#Current_Revision__c').val('');
                          
                          //$('#Document_Number__c').find('option').last().attr('value','');
                          //$('#Document_Number__c').find('option').last().text('');                            
                    checkForSourceDependentFieldValues();
                   
                    var chnagRquestTypeId=  $('#Change_Request_Type__c').val();
                    console.log('chnage request type' +chnagRquestTypeId);
                    if(chnagRquestTypeId == 'Document'){
                        $('#Change_Type').find('label>span').attr('class','mandatory');
                        $('#Change_Type').find('label>span').html('* ');
                        /*=========Appended by balu Start*/
                        $('#Change_Type__c').addClass('required');
                        
                        $('#Change_Type').last().append('<div id="Change_Type__c_error" class="help-block with-errors"></div>');
                        /*=========Appended by balu end*/
                    }
                    
                    else{                               
                        $('#Change_Type').find('label>span').html('');
                        /*=========Appended by balu Start*/
                        $('#Change_Type__c').removeClass('required');
                        /*=========Appended by balu end*/
                    }                 
                    var changetypeId=  $('#Change_Type__c').val();
                    console.log('chagetype id'+ changetypeId);
                    if(changetypeId== 'Temp' || changetypeId== 'Revise'){
                        console.log('it is not new if temp || revise ');
                        $('#Document_Number__cTobehidden').addClass('hidden');
                        //$('#Document_Number__cTobehidden').attr('name','');
                        $('#piclistDocumentNUmber').removeClass('hidden');
                        $('#piclistDocumentNUmber').find('#Document_Number__c').attr('name','');
                        /*=========Appended by balu Start*/
                        $('#piclistDocumentNUmber').find('#Document_Number__c').addClass('required');
                        $('#Document_Number').find('label>span').attr('class','mandatory');
                        $('#Document_Number').find('label>span').html('* ');
                        $('#Document_Number__C').addClass('required');
                        /*=========Appended by balu end*/
                    }else if(changetypeId == 'New'){
                        
                         $('#piclistDocumentNUmber').find('#Document_Number__c').removeClass('required');
                         $('#Document_Number__C').removeClass('required');
                         $('#Document_Number').find('label>span').html(' ');
                        
                        $('#Document_Number__cTobehidden').removeClass('hidden');
                        //$('#Document_Number__cTobehidden').attr('name','Document_Number__c');
                        $('#piclistDocumentNUmber').addClass('hidden');
                        $('#piclistDocumentNUmber').find('#Document_Number__c').attr('name','');
                       
                        showCurrentRevision();
                        
                    }
                  
                  
                  //isLoaded = true;  
                }
                // var crIsClosed = false ;
                 
                $('#Document_Number').click(function() {
				  
				  if($('#select2-Document_Number__c-container').children('span').hasClass('select2-selection__placeholder')){
                              //alert('inside cross click');
                                $('#Current_Revision__c').val('');
                               }
				});
				
				var selectedDocument;
                 function showCurrentRevision(){
                      
                    // alert('alert showCurrentRevision');
                   if($('#Change_Type__c').val() != 'New'){ 
                          
                         console.log('came in side if part showCurrentRevision  ');
                             selectedDocument= $('#Document_Number__c').find('option').last().attr('value');
                        console.log('selected documnet   '+selectedDocument);
                         
                        checkForCrStatus(selectedDocument); 
                         
                         
                      
                    
                    }
                    
                   if($('#Change_Type__c').val() == 'New')
                     {
                        
                         //console.log('came inside else part   ');  
                         //console.log($('#Document_Number__c').find('option').last().attr('value'));
                         //$('#Document_Number__cTobehidden').val($('#Document_Number__c').find('option').last()attr('value',''));
                         var pgId = '{!$CurrentPage.parameters.id}';
                         
                        if(pgId == ''){
                             //alert('coming inside pgid blank'); 
                          
                         
                            var parameterName = '{!$CurrentPage.parameters.id}';
                          //if('{!changemanagement.Document_Number__c}' != ''){  
						    $('#Document_Number__cTobehidden').val('');
						   // deleteChangeRequestDocumentNumber(parameterName);
						   // }
						    $('#Current_Revision__c').val('');
						  }						
                    } 
                
                
                } 
              function deleteChangeRequestDocumentNumber(chaneRquestId){
              //alert('inside delete function');
                       Visualforce.remoting.Manager.invokeAction(
          // @RemoteAction
            '{!$RemoteAction.ChangeManagementControllerExt.deleteChangeRequestDocumentNumber}',chaneRquestId,function(result, event){
            if(event.status){
                $('#Document_Number__cTobehidden').val('');     
                                        
               }
              
           }
           );
                 }
                 
          function checkForCrStatus(selectedDocumentId){ 
           
                 Visualforce.remoting.Manager.invokeAction(
          // @RemoteAction
            '{!$RemoteAction.ChangeManagementControllerExt.checkForExistingChangeRequestDocumentNumber}',selectedDocumentId,function(result, event){
            console.log('result.length is here  befor function  '+result.length);
            if(result.length > 0 || result.length != 0){
                   //	crIsClosed = false; 
                    console.log('result is here that is return value '+result.length);
                    
                    
                           showDialog('1','There is Already an existing ChangeRequest on this Document that is not yet Closed');
                           $('#Document_Number__c').find('option').last().val('');
                           $('#select2-Document_Number__c-container').attr('title','').text('');
                     
                    
               }
               else{
                   //crIsClosed = true;
                   
                   console.log('crIsClosed value is here in elese '+result.length);
                    for(i=0;i<getDocuments.length-1;i++){
                          //console.log('array'+ getDocuments[i]);
                          var splitDocArray= getDocuments[i].split('@');
                          // console.log('whole splitted array'+splitDocArray);
                          // console.log('splitted array'+splitDocArray[1]);
                           if(splitDocArray[0]==selectedDocument){
                             console.log('current revision'+ splitDocArray[2]);
                             $('#Current_Revision__c').val(splitDocArray[2]);
                             $('#CurrentRevision').val(splitDocArray[2]);
                         
                            // console.log('current revision  '+ $('#Current_Revision__c').val());
                           }
                         } 
                         
                        $('#piclistDocumentNUmber').find('#Document_Number__c').attr('name','');
                        //$('#Document_Number__cTobehidden').val($('#select2-Document_Number__c-container').attr('title'));
                        console.log($('#Document_Number__c').find('option').last().attr('value'));
                        $('#Document_Number__cTobehidden').val($('#Document_Number__c').find('option').last().attr('value')).trigger('change');
                        //console.log('this is the option selected id'+$('#Document_Number__c').find('option').last().attr('value'));
                      
                  }
              
           }
           );
              
              }       
        <!-- v1.1 ends here  -->
                               
        function onValidInit(){
      console.log('cr _init onValidInit  ');
      //if({!NOT(ISBLANK(JSENCODE(ChangeManagement.Id)))}){
        //  $('#crForm').submit();
      //}
      //else{
        var isDigSigNd='<apex:outputText value="{!$Setup.QC_settings__c.Is_Digital_Signature_Needed__c}"/>'
        if(isDigSigNd=='true'){
           $('#uname').val('');$('#pw').val('');$('.dont-allow-multiple-clicks').removeAttr('disabled'); $('#signature').modal('show');
        }else{
         navigateAfterDigitalSignature();
        }
      //}
    }
     
    
        function navigateAfterDigitalSignature(){
    if(!$('.dont-allow-multiple-clicks').attr('disabled')){
        $('.dont-allow-multiple-clicks').attr('disabled', true);
    } 
    
    $('#crForm').submit();
}

 


   
        </script>
    </apex:outputPanel>
<!-- End of Javascript  -->


    <!--  Document Information -->
        <apex:outputPanel rendered="{!$CurrentPage.parameters.pg=='doc_info'}">
     
        <script type="text/javascript">
            //Script for Document Info----------------------------------------------------------------------------------------------
            var docTypes = [],searchDocs = [],doc,isSub=false,documentListSize,defaultDocProfile,type,docText;
            $( document ).ready(function() {
                
                /*<apex:repeat value="{!types}" var="t">
                    docTypes.push('{!JSENCODE(t)}');
                </apex:repeat>*/
                <apex:repeat value="{!searchDocs}" var="doc">
                    searchDocs.push('{!JSENCODE(doc.DocumentChild__c)}@{!JSENCODE(doc.DocumentChild__r.Document_Name__c)}@{!JSENCODE(doc.DocumentChild__r.Name)}@{!JSENCODE(doc.Child_Revision__c)}@{!JSENCODE(doc.Child_Status__c)}@{!JSENCODE(doc.RelationWithParent__c)}@{!JSENCODE(doc.Child_Owner__c)}@{!JSENCODE(doc.DocumentParent__c)}@{!JSENCODE(doc.DocumentParent__r.Document_Name__c)}@{!JSENCODE(doc.DocumentParent__r.Name)}@{!JSENCODE(doc.RelationWithChild__c)}@{!JSENCODE(doc.Current_Rev__c)}@{!JSENCODE(doc.Parent_Status__c)}@{!JSENCODE(doc.Parent_Owner__c)}');
                </apex:repeat>
                searchDocs.push('{!JSENCODE(docProf.Id)}@{!JSENCODE(docProf.Document_Name__c)}@{!JSENCODE(docProf.Name)}@{!JSENCODE(docProf.Current_Rev__c)}@{!JSENCODE(docProf.Status__c)}@{!JSENCODE(docProf.Relation__c)}@{!JSENCODE(docProf.Owner.Name)}');
                console.log('searchDocs '+searchDocs);
                if($("#docInfoTable").children().length < 3){
                    $("#docInfoTbody0").clone().insertAfter('#docTabHeader').removeAttr('class');
                }
                type = '{!JSENCODE(changemanagement.Change_Type__c)}';
                assignDynamicIdsToDocInfoTable();
                
                // new enhancements ---------
                 
                documentListSize = '{!JSENCODE(text(documentListSize))}';
                if(parseInt(documentListSize) <= 0){
                    defaultDocProfile = '{!JSENCODE(changemanagement.Document_Number__c)}';
                    //type = '{!JSENCODE(changemanagement.Change_Type__c)}';
                    console.log('type '+type+' defaultDocProfile '+defaultDocProfile);
                    $.each(searchDocs, function(sdoc) {
                        doc = searchDocs[sdoc].split('@');
                        //console.log('outside if type '+type);
                        if(type != 'New'){
                            //console.log('inside if type '+type);
                            if(doc[0] == defaultDocProfile || doc[7] == defaultDocProfile){
                            	if(doc[0] == defaultDocProfile){
                                	//docText = doc[1]+'('+doc[2]+')';
                                	docText = doc[2];
                                    $("#docInfoTbody1Row1_Search option[value="+doc[0]+"]").attr('selected','selected');
                                	$("#docInfoTbody1Row1_CurRev").text(escapeHtml(doc[3]));
                                	$("#docInfoTbody1Row1_Status").text(escapeHtml(doc[4]));
                                    //$("#docInfoTbody1Row1_Relation").text(escapeHtml(doc[5]));
                                    $("#docInfoTbody1Row1_Owner").text(escapeHtml(doc[6]));
                                }else if(doc[7] == defaultDocProfile){
                                	//docText = doc[8]+'('+doc[9]+')';
                                	docText = doc[9];
                                    $("#docInfoTbody1Row1_Search option[value="+doc[7]+"]").attr('selected','selected');
                                	//$("#docInfoTbody1Row1_Relation").text(escapeHtml(doc[10]));
                                    $("#docInfoTbody1Row1_CurRev").text(escapeHtml(doc[11]));
                                	$("#docInfoTbody1Row1_Status").text(escapeHtml(doc[12]));
                                    $("#docInfoTbody1Row1_Owner").text(escapeHtml(doc[13]));
                                }
                                $("#docInfoTbody1Row1_SelectedType").val(type).attr('disabled','true');
                                $('#docInfoTbody1Row1_Search').attr('disabled','true');
                                $("#docInfoTbody1Row1_Search").next().find('span').eq(2).attr('title',escapeHtml(docText));
                                $("#docInfoTbody1Row1_Search").next().find('span').eq(2).text(escapeHtml(docText));
								$('#docInfoTbody1Row1_Close').hide();
                            }
                        }
                    });
                    if(type == 'New'){
                        //console.log('inside else type '+type);
                        $("#docInfoTbody1Row1_SelectedType").val(type).attr('disabled','true');
                        $('#docInfoTbody1Row1_Input').val(defaultDocProfile).attr('disabled','true');
                        $('#docInfoTbody1Row1_Close').hide();
                    }
                }
                //--end new enhancements------
                
                var id_start = 1;
                $("#docInfoTable>tbody").not(':first').each(function(){
                    if($(this).attr('class') != 'hidden'){
                        tId = 'docInfoTbody' + (id_start++);
                        if($("#"+tId+"Row1_SelectedType option:selected").val() == 'New'){
                            $("#"+tId+"Row1_Search").parent().hide();
                            $("#"+tId+"Row1_Input").show();
                        }else{
                            $("#"+tId+"Row1_Input").hide();
                            $("#"+tId+"Row1_Search").parent().show();
                        }
                        
                    }
                });
                var genTaskOwner,loggedinuser,crOwner,profile,docStatus,approvalReq,documentChangeStatus;
                genTaskOwner = "{!IF(changemanagement.General_Tasks__r.size!=0,JSENCODE(changemanagement.General_Tasks__r[0].OwnerId),'')}";
                loggedinuser = "<apex:outputtext value="{!$User.Id}"/>";
                crOwner = '{!JSENCODE(changemanagement.OwnerId)}';
                profile = "<apex:outputtext value="{!$Profile.Name}" />";
                console.log('genTaskOwner '+genTaskOwner+' logedinuser '+loggedinuser+' crOwner '+crOwner+' profile '+profile);
                docStatus = "<apex:outputtext value="{!changemanagement.Closed__c}" />";
                approvalReq = "{!JSENCODE(changemanagement.Status__c)}";
                documentChangeStatus = "<apex:outputtext value="{!IF(changemanagement.General_Tasks__r.size!=0,JSENCODE(changemanagement.General_Tasks__r[0].Status__c),'')}"/>";
                console.log('docStatus '+docStatus+' approvalReq '+approvalReq+' documentChangeStatus '+documentChangeStatus);
                if( approvalReq == 'Pending Approval' || approvalReq == 'Document Change Order' || approvalReq == 'Void' || docStatus == 'true' ){
                	console.log('inside status check');
                	if(documentChangeStatus == 'Pending Action Completion' || documentChangeStatus == 'Closed' || documentChangeStatus == 'Void' || documentChangeStatus == 'Pending Approval' || documentChangeStatus == 'Created' || documentChangeStatus == '' ){
	                    $("#add_document").attr('disabled','true');
	                    id_start = 1;
	                    $("#docInfoTable>tbody").not(':first').each(function(){
	                        if($(this).attr('class') != 'hidden'){
	                            tId = 'docInfoTbody' + (id_start++);
	                            $("#"+tId+"Row1_SelectedType").attr('disabled','true');
	                            $('#'+tId+'Row1_Search').attr('disabled','true');
	                            $('#'+tId+'Row1_Input').attr('disabled','true');
	                            $('#'+tId+'Row2_SpecChanges').attr('disabled','true');
	                            $('#'+tId+'Row1_Close').hide();
	                        }
	                    });
	                    $('#save').hide();
                    	$('#submit').hide();
                    	$('#cancel').hide();
                    }
                }
                if((genTaskOwner != loggedinuser && genTaskOwner != '') && crOwner != loggedinuser && profile != 'System Administrator'){
                	console.log('inside user check');
                	$("#add_document").attr('disabled','true');
                    id_start = 1;
                    $("#docInfoTable>tbody").not(':first').each(function(){
                        if($(this).attr('class') != 'hidden'){
                            tId = 'docInfoTbody' + (id_start++);
                            $("#"+tId+"Row1_SelectedType").attr('disabled','true');
                            $('#'+tId+'Row1_Search').attr('disabled','true');
                            $('#'+tId+'Row1_Input').attr('disabled','true');
                            $('#'+tId+'Row2_SpecChanges').attr('disabled','true');
                            $('#'+tId+'Row1_Close').hide();
                        }
                    });
                }      
            });
            
            function docValidation(){
                $("div[id$='_error']").empty();
                var id_start = 1,typeSelected,tId,docSearch,docInput,docSpecChanges;
                var isValid = true;
                if($("#docInfoTable").children().length > 2){
                    $("#docInfoTable>tbody").not(':first').each(function() {
                        if($(this).attr('class') != 'hidden'){
                            tId = 'docInfoTbody' + (id_start++);
                            typeSelected = $("#"+tId+"Row1_Type option:selected").val();
                            docSearch = $('#'+tId+'Row1_Search option:selected').val();
                            docInput = $('#'+tId+'Row1_Input').val();
                            if( typeSelected == '' || typeSelected == undefined || typeSelected == '--None--'){
                                $('#'+tId+'Row1_type_error').append('This Field is Required').css('color','red');
                                isValid = false;
                            }
                            
                            if( type != 'New'){
                                if(docSearch == '' || docSearch == undefined){
                                    $('#'+tId+'Row1_doc_error').append('This Field is Required').css('color','red');
                                    isValid = false;
                                }
                            }
                            
                        }   
                    });
                }
                return isValid;
            }
            
            function addDocument(){
                if(docValidation()){
                    $("#docInfoTbody0").clone().insertAfter('#docTabHeader').removeAttr('class');
                    if(type=='New'){
                    	$("#docInfoTbody0Row1_Search").parent().hide();
                    	$("#docInfoTbody0Row1_Input").show();
                    }
                    assignDynamicIdsToDocInfoTable();
                }
            }

            function assignDynamicIdsToDocInfoTable(){
                
                var id_start = 1,tId,rowId1,rowId2,typeVal,searchVal;
                $("#docInfoTable>tbody").not(':first').each(function(){
                    if($(this).attr('class') != 'hidden'){
                        tId = 'docInfoTbody' + (id_start++);
                        $(this).attr('id',tId);
                        $("#"+tId).find('tr').eq(0).attr('id',tId+'Row1');
                        rowId1 = $("#"+tId).find('tr').eq(0).attr('id');
                        $("#"+tId).find('tr').eq(0).find('td').eq(0).attr('id',rowId1+'_Type');
                        $("#"+tId).find('tr').eq(0).find('td').eq(0).find('select').attr('id',rowId1+'_SelectedType');
                        console.log('inside assignDynamicIdsToDocInfoTable');
                        //typeVal = $('#'+rowId1+'_SelectedType option:selected').val();
                        $("#"+rowId1+"_SelectedType").append($("<option />").val(escapeHtml('--None--')).text(escapeHtml('--None--')));
                        /*$.each(docTypes, function(dtype) {
                            if(docTypes[dtype] != typeVal){
                                $("#"+rowId1+"_SelectedType").append($("<option />").val(escapeHtml(docTypes[dtype])).text(escapeHtml(docTypes[dtype])));
                                $("#"+rowId1+"_SelectedType option").each(function(){
                                    $(this).siblings("[value='"+ this.value+"']").remove();
                                });
                            }
                        });*/
                        if(type != 'New'){
                            $("#"+rowId1+"_SelectedType").append($("<option />").val(escapeHtml('Revise')).text(escapeHtml('Revise')));
                            $("#"+rowId1+"_SelectedType").append($("<option />").val(escapeHtml('Temp')).text(escapeHtml('Temp')));
                            $("#"+rowId1+"_SelectedType option").each(function(){
                                $(this).siblings("[value='"+ this.value+"']").remove();
                            });
                        }else if(type == 'New'){
                            $("#"+rowId1+"_SelectedType").append($("<option />").val(escapeHtml('New')).text(escapeHtml('New')));
                            $("#"+rowId1+"_SelectedType option").each(function(){
                                $(this).siblings("[value='"+ this.value+"']").remove();
                            });
                        }
                        $("#"+tId).find('tr').eq(0).find('td').eq(0).find('div').attr('id',rowId1+'_type_error');
                        $("#"+tId).find('tr').eq(0).find('td').eq(1).attr('id',rowId1+'_Doc');
                        $("#"+tId).find('tr').eq(0).find('td').eq(1).find('select').attr('id',rowId1+'_Search');
                        $("#"+tId).find('tr').eq(0).find('td').eq(1).find('input').eq(0).attr('id',rowId1+'_Input');
                        searchVal = $('#'+rowId1+'_Search option:selected').val();
                        $("#"+rowId1+"_Search").append($("<option />").val(escapeHtml('')).text(escapeHtml('')));
                        $.each(searchDocs, function(sdoc) {
                            doc = searchDocs[sdoc].split('@');
                            if(doc[0] != searchVal || doc[7] != searchVal){
                            	//$("#"+rowId1+"_Search").append($("<option />").val(escapeHtml(doc[0])).text(escapeHtml(doc[1]+'('+doc[2]+')')));
                                //$("#"+rowId1+"_Search").append($("<option />").val(escapeHtml(doc[7])).text(escapeHtml(doc[8]+'('+doc[9]+')')));
                                $("#"+rowId1+"_Search").append($("<option />").val(escapeHtml(doc[0])).text(escapeHtml(doc[2])));
                                $("#"+rowId1+"_Search").append($("<option />").val(escapeHtml(doc[7])).text(escapeHtml(doc[9])));
                                $("#"+rowId1+"_Search option").each(function(){
                                    $(this).siblings("[value='"+ this.value+"']").remove();
                                });
                                $("#"+rowId1+"_Search option[value=undefined]").remove();
                            }
                        });
                        $("#"+rowId1+"_Search").select2({
                            closeOnSelect:false
                        });
                        $("#"+rowId1+"_Doc").find('.help-block').attr('id',rowId1+'_doc_error');
                        $("#"+tId).find('tr').eq(0).find('td').eq(2).attr('id',rowId1+'_CurRev');
                        $("#"+tId).find('tr').eq(0).find('td').eq(3).attr('id',rowId1+'_NewRev');
                        $("#"+tId).find('tr').eq(0).find('td').eq(4).attr('id',rowId1+'_Status');
                        $("#"+tId).find('tr').eq(0).find('td').eq(5).attr('id',rowId1+'_Relation');
                        $("#"+tId).find('tr').eq(0).find('td').eq(6).attr('id',rowId1+'_Owner');
                        $("#"+tId).find('tr').eq(0).find('td').eq(7).attr('id',rowId1+'_Closetd');
                        $("#"+tId).find('tr').eq(0).find('td').eq(7).find('i').attr('id',rowId1+'_Close');
                        $("#"+tId).find('tr').eq(1).attr('id',tId+'Row2');
                        rowId2 = $("#"+tId).find('tr').eq(1).attr('id');
                        $("#"+tId).find('tr').eq(1).find('td').attr('id',rowId2+'_Changes');
                        $("#"+rowId2+'_Changes').find('textarea').attr('id',rowId2+'_SpecChanges');
                        $("#"+rowId2+'_Changes').find('div').eq(1).attr('id',rowId2+'_specChanges_error');
                    }       
                });
            }   

            function getTypeFields(id){
                $("div[id$='_error']").empty();
                var i,searchVal,splitVal;
                var rowId = $(id).attr('id').split('_');
                var specChanges = rowId[0].slice(0,-1);
                var selectedType = $("#"+rowId[0]+"_SelectedType option:selected").val();
                if(selectedType == 'New'){
                    $("#"+rowId[0]+"_Search").parent().hide();
                    $("#"+rowId[0]+"_Input").show();
                }else{
                    $("#"+rowId[0]+"_Input").hide();
                    $("#"+rowId[0]+"_Search").parent().show();
                    $("#"+rowId[0]+"_Search").val(escapeHtml(''));
                    $("#"+rowId[0]+"_Search").next().find('span').eq(2).attr('title',escapeHtml(''));
                    $("#"+rowId[0]+"_Search").next().find('span').eq(2).text(escapeHtml(''));
                }
                $("#"+rowId[0]+"_CurRev").empty();
                $("#"+rowId[0]+"_Status").empty();
                $("#"+rowId[0]+"_Relation").empty();
                $("#"+rowId[0]+"_Owner").empty();
                $("#"+specChanges+"2_SpecChanges").val(escapeHtml(''));
            }
        
        
        
            var deletedRecords = [];
            function removeDoc(id,recordId){
                var rowId = $(id).attr('id').split('Row1');
                var docCnt = $('#docInfoTable>tbody').length;
                if(docCnt==3){
                    showDialog('1','At-least one document is required');
                    return false;
                }else{
                    if(recordId != null){
                        deletedRecords.push(recordId);
                        $("#"+rowId[0]).remove();
                    }else{
                        $("#"+rowId[0]).remove();
                    }
                    assignDynamicIdsToDocInfoTable();
                }   
            }    
        
            var docRecords = {},docArray = {};
            function saveDocInfo(){
                if(docValidation()){
                    $('#save').attr('disabled', 'true');
                    $('#submit').attr('disabled', 'true');
                    $('#cancel').attr('disabled', 'true');
                    var id_start = 1;
                    $("#docInfoTable>tbody").not(':first').each(function(){
                        if($(this).attr('class') != 'hidden'){
                            tId = 'docInfoTbody' + (id_start++);
                            docRecords['Id'] = $("#"+tId+"Row1_Closetd").attr('class');
                            docRecords['Type'] = $("#"+tId+"Row1_SelectedType option:selected").val();
                            if(docRecords['Type'] != 'New'){
                                docRecords['Doc'] = $('#'+tId+'Row1_Search option:selected').val();
                            }else{
                                docRecords['Doc'] = $('#'+tId+'Row1_Input').val();
                            }
                            //console.log('disabled '+$("#"+tId+"Row1_SelectedType").attr('disabled'));
                            if($("#"+tId+"Row1_SelectedType").attr('disabled')){
                                docRecords['isPrimary'] = $("#"+tId+"Row1_SelectedType").attr('disabled');
                            }
                            docRecords['Relation'] = $("#"+tId+"Row1_Relation").text();
                            docRecords['SpecChanges'] = $("#"+tId+"Row2_SpecChanges").val();
                            docArray[tId] = docRecords;
                            docRecords = {};
                        }   
                    });
                    console.log(docArray);
                    Visualforce.remoting.Manager.invokeAction(
                    // @RemoteAction
                    '{!$RemoteAction.ChangeManagementControllerExt.saveDocInfo}',deletedRecords,docArray,'{!JSENCODE(ChangeManagement.Id)}',
                        // Callback
                        function(result, event){
                            if(result == 0){
                                if(isSubmit){
                                    window.location.href = '/apex/changemanagement?id='+'{!JSENCODE(ChangeManagement.Id)}&pg=cr_resolution';
                                }else{
                                    window.location.href = '/apex/changemanagement?id='+'{!JSENCODE(ChangeManagement.Id)}&pg={!JSENCODE($CurrentPage.parameters.pg)}';
                                    
                                }
                            }else{
                                $('#submit').attr('disabled', 'false');
                                $('#save').attr('disabled', 'false');
                                $('#cancel').attr('disabled', 'false');
                            }
                        }
                    );
                }
            }    
                        
            function submitDocInfo(){
                var isDigitalneeded ="<apex:outputtext value="{!$Setup.QC_settings__c.Is_Digital_Signature_Needed__c}" />";
                if(docValidation()){
                    if(isDigitalneeded == 'true'){
                        $('#uname').val('');
                        $('#pw').val('');
                        $('.dont-allow-multiple-clicks').removeAttr('disabled');
                        $('#signature').modal('show');
                    }else{
                        $('#save').attr('disabled', 'true');
                        $('#cancel').attr('disabled', 'true');
                        $('#submit').attr('disabled', 'true');
                        saveDocInfo();
                    }   
                }
                
            }
            
                                
            function checkDoc(searchId){
                
                $("div[id$='_error']").empty();
                var rowId = $(searchId).attr('id').split('_');
                var searchVal = $(searchId).val();
                var id_start = 1,rId,sVal,sText,count=0,flag = false,i,splitVal;
                
                $("#docInfoTable>tbody").not(':first').each(function(){
                    if($(this).attr('class') != 'hidden'){
                        rId = 'docInfoTbody' + (id_start++);
                        sVal = $("#"+rId+"Row1_Search option:selected").val();
                        sText = $("#"+rId+"Row1_Search option:selected").text();
                        if(searchVal != 0 && searchVal == sVal){
                            count += 1;
                            if(count>1){
                                $('#'+rowId[0]+'_doc_error').append("'"+sText+"' is already exist").css('color','red');
                                $("#"+rowId[0]+"_Search").val('').attr('selected','true');
                                $("#"+rowId[0]+"_Search").next().find('span').eq(2).attr('title',escapeHtml(''));
                                $("#"+rowId[0]+"_Search").next().find('span').eq(2).text(escapeHtml(''));
                                $("#"+rowId[0]+"_CurRev").text(escapeHtml(''));
                                $("#"+rowId[0]+"_Status").text(escapeHtml(''));
                                $("#"+rowId[0]+"_Relation").text(escapeHtml(''));
                                $("#"+rowId[0]+"_Owner").text(escapeHtml(''));
                                flag = true;
                                return false;
                            }
                        }
                    }
                });
                
            
                if(!flag){  
                    if(searchVal != 0){
                        for(i=0;i<searchDocs.length;i++){
                            splitVal = searchDocs[i].split('@');
                            if(searchVal == splitVal[0] || searchVal == splitVal[7]){
                                if(searchVal == splitVal[0]){
                                	$("#"+rowId[0]+"_CurRev").text(escapeHtml(splitVal[3]));
                                    $("#"+rowId[0]+"_Status").text(escapeHtml(splitVal[4]));
                                    $("#"+rowId[0]+"_Relation").text(escapeHtml(splitVal[5]));
                                    $("#"+rowId[0]+"_Owner").text(escapeHtml(splitVal[6]));
                                }else if(searchVal == splitVal[7]){
                                	$("#"+rowId[0]+"_Relation").text(escapeHtml(splitVal[10]));
                                	$("#"+rowId[0]+"_CurRev").text(escapeHtml(splitVal[11]));
                                    $("#"+rowId[0]+"_Status").text(escapeHtml(splitVal[12]));
                                    $("#"+rowId[0]+"_Owner").text(escapeHtml(splitVal[13]));
                               }
                                
                            }
                        }
                    }else{
                        $("#"+rowId[0]+"_CurRev").text(escapeHtml(''));
                        $("#"+rowId[0]+"_Status").text(escapeHtml(''));
                        $("#"+rowId[0]+"_Relation").text(escapeHtml(''));
                        $("#"+rowId[0]+"_Owner").text(escapeHtml(''));
                    }
                }   
            }
        //End of Script for Document Info------------------------------------------------------------------------------------------
    </script>
        <input type="hidden" name="sobj" value="Change_Management__c" />
        <input type="hidden" name="page" id="page" value="doc_info" />
        <div class="wiz-form-holder">
            <div class="">
                <!--Left form container -->
                <div class="wizard-form-holder">
                    <div class="wiz-field">
                        <div class="">
                            <div class="top-buttons text-right">
                                <button type="button" id="add_document"
                                    class="btn btn-primary" onclick="addDocument();">Add
                                    Document</button>
                            </div>
                            <div class="wiz-fields-wide">
                                <table class="table table-hover" id="docInfoTable">
                                    <tbody id="docTabHeader">
                                        <tr class="text-v-center" >
                                            <th><span class="mandatory">* </span>{!JSENCODE($ObjectType.Sub_Change_Management__c.Fields.Type__c.Label)}</th>
                                            <th width="30%"><apex:outputpanel rendered="{!changemanagement.Change_Type__c != 'New'}"><span class="mandatory">* </span></apex:outputpanel>{!JSENCODE($ObjectType.Sub_Change_Management__c.Fields.Document_Profile__c.Label)} / {!JSENCODE($ObjectType.Sub_Change_Management__c.Fields.Document_Name__c.Label)}</th>
                                            <th>{!JSENCODE($ObjectType.Sub_Change_Management__c.Fields.Current_Rev__c.Label)}</th>
                                            <th>{!JSENCODE($ObjectType.Sub_Change_Management__c.Fields.New_Rev__c.Label)}</th>
                                            <th>{!JSENCODE($ObjectType.Sub_Change_Management__c.Fields.Status__c.Label)}</th>
                                            <th>{!JSENCODE($ObjectType.Sub_Change_Management__c.Fields.Relation__c.Label)}</th>
                                            <th>{!JSENCODE($ObjectType.Sub_Change_Management__c.Fields.Owner__c.Label)}</th>
                                            <th></th>
                                        </tr>
                                    </tbody>
                                    <tbody id="docInfoTbody0" class="hidden">
                                        <tr class="text-v-center" id="docInfoTbody0Row1">
                                            <td id="docInfoTbody0Row1_Type"><select
                                                id="docInfoTbody0Row1_SelectedType"
                                                class="form-control input-sm"
                                                onchange="getTypeFields(this);">
                                                </select>
                                                <div id="docInfoTbody0Row1_type_error" class="help-block with-errors"></div>
                                            </td>
                                            <td id="docInfoTbody0Row1_Doc">
                                                <div>
                                                    <select id="docInfoTbody0Row1_Search" class="form-control input-sm" onchange="checkDoc(this)"></select>
                                                </div>
                                                <input type="text" style="display:none" id="docInfoTbody0Row1_Input" class="form-control input-sm" maxlength="120"  oninput="maxlengthvalidation(this)"/>
                                                <div id="docInfoTbody0Row1_doc_error" class="help-block with-errors"></div>
                                            </td>
                                            <td id="docInfoTbody0Row1_CurRev"></td>
                                            <td id="docInfoTbody0Row1_NewRev"></td>
                                            <td id="docInfoTbody0Row1_Status"></td>
                                            <td id="docInfoTbody0Row1_Relation"></td>
                                            <td id="docInfoTbody0Row1_Owner"></td>
                                            <td id="docInfoTbody0Row1_Closetd" class=""><i
                                                class="fa fa-close" id="docInfoTbody0Row1_Close"
                                                onclick="removeDoc(this,this.parentNode.getAttribute('class'));"></i>
                                            </td>
                                        </tr>
                                        <tr id="docInfoTbody0Row2">
                                            <td colspan="8" id="docInfoTbody0Row2_Changes">
                                                <div class="form-group">
                                                    <label for="exampleInputEmail1"><span class=""></span> {!JSENCODE($ObjectType.Sub_Change_Management__c.Fields.Document_Specific_Changes__c.Label)}:</label>
                                                    <textarea class="form-control rich-text-editor" id="docInfoTbody0Row2_SpecChanges" maxlength="4000"  oninput="maxlengthvalidation(this)"></textarea>
                                                    <div id="docInfoTbody0Row2_specChanges_error" class="help-block with-errors"></div>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                                                                    
                                    
                                     <apex:repeat value="{!documentList}" var="doc">
                                         <tbody id="docInfoTbody1">
                                            <tr class="text-v-center" id="docInfoTbody1Row1">
                                                <td id="docInfoTbody1Row1_Type"><select
                                                    id="docInfoTbody1Row1_SelectedType"
                                                    class="form-control input-sm"
                                                    onchange="getTypeFields(this);">
                                                        <option value="{!JSENCODE(doc.Type__c)}" selected="selected">{!JSENCODE(doc.Type__c)}</option>
                                                    </select>   
                                                    <div id="docInfoTbody1Row1_type_error" class="help-block with-errors"></div>
                                                </td>
                                                <td id="docInfoTbody1Row1_Doc">
                                                    <div>
                                                        <select id="docInfoTbody1Row1_Search" class="form-control input-sm {!JSENCODE(doc.Document_Profile__r.Name)}" onchange="checkDoc(this)">
                                                            <!-- <option value="{!JSENCODE(doc.Document_Profile__c)}" selected="selected">{!JSENCODE(doc.Document_Profile__r.Document_Name__c)}({!JSENCODE(doc.Document_Profile__r.Name)})</option>-->
                                                            <option value="{!JSENCODE(doc.Document_Profile__c)}" selected="selected">{!JSENCODE(doc.Document_Profile__r.Name)}</option>
                                                        </select>
                                                    </div>
                                                    <input type="text" style="display:none" id="docInfoTbody1Row1_Input" class="form-control input-sm" value="{!JSENCODE(doc.Document_Name__c)}" maxlength="120"  oninput="maxlengthvalidation(this)"/>
                                                    <div id="docInfoTbody1Row1_doc_error" class="help-block with-errors"></div>
                                                    
                                                </td>
                                                <td id="docInfoTbody1Row1_CurRev"><apex:outputText value="{!doc.Current_Rev__c}"/></td>
                                                <td id="docInfoTbody1Row1_NewRev"><apex:outputText value="{!doc.New_Rev__c}"/></td>
                                                <td id="docInfoTbody1Row1_Status"><apex:outputText value="{!doc.Status__c}"/></td>
                                                <td id="docInfoTbody1Row1_Relation"><apex:outputText value="{!doc.Relation__c}"/></td>
                                                <td id="docInfoTbody1Row1_Owner"><apex:outputText value="{!doc.Owner__c}"/></td>
                                                <td id="docInfoTbody1Row1_Closetd" class="{!JSENCODE(doc.Id)}"><i
                                                    class="fa fa-close" id="docInfoTbody1Row1_Close"
                                                    onclick="removeDoc(this,this.parentNode.getAttribute('class'));"></i>
                                                </td>
                                                <script>
                                                $( document ).ready(function() {
                                                    //console.log('defaultdocumentName == {!JSENCODE(defaultdocumentName)} and doc.Name == {!JSENCODE(doc.Document_Profile__r.Name)}  docName == {!JSENCODE(doc.Document_Name__c)}');
                                                    var searchId,rowId,isPrimary;
                                                    isPrimary = "<apex:outputtext value="{!doc.isPrimary__c}"/>";
                                                    //console.log('isPrimary '+isPrimary);
                                                    if('{!JSENCODE(doc.Type__c)}' != 'New' && isPrimary== 'true'){
                                                        if('{!JSENCODE(defaultdocumentName)}' == '{!JSENCODE(doc.Document_Profile__r.Name)}'){
                                                            //console.log('inside doc type other than new');
                                                            searchId = $(".{!doc.Document_Profile__r.Name}").attr('Id');
                                                            $("#"+searchId).attr('disabled','true');
                                                            rowId = $("#"+searchId).attr('id').split('_');
                                                            $("#"+rowId[0]+"_Input").attr('disabled','true');
                                                            $("#"+rowId[0]+"_SelectedType").attr('disabled','true');
                                                            $("#"+rowId[0]+"_Close").hide();
                                                        }
                                                    }else if('{!JSENCODE(doc.Type__c)}' == 'New' && isPrimary== 'true'){
                                                        if('{!JSENCODE(defaultdocumentName)}' == '{!JSENCODE(doc.Document_Name__c)}'){
                                                            //console.log('inside doc type new');
                                                            searchId = $(".{!JSENCODE(doc.Id)}").attr('Id');
                                                            //console.log('searchId '+searchId);
                                                            rowId = $("#"+searchId).attr('id').split('_');
                                                            //console.log('rowId '+rowId[0]);
                                                            $("#"+rowId[0]+"_Input").attr('disabled','true');
                                                            $("#"+rowId[0]+"_SelectedType").attr('disabled','true');
                                                            $("#"+rowId[0]+"_Close").hide();
                                                        }
                                                    }
                                                });
                                                </script>
                                            </tr>
                                            <tr id="docInfoTbody1Row2">
                                                <td colspan="8" id="docInfoTbody1Row2_Changes">
                                                    <div class="form-group">
                                                        <label for="exampleInputEmail1"><span class=""></span> {!JSENCODE($ObjectType.Sub_Change_Management__c.Fields.Document_Specific_Changes__c.Label)}:</label>
                                                        <textarea class="form-control rich-text-editor" id="docInfoTbody1Row2_SpecChanges" maxlength="4000"  oninput="maxlengthvalidation(this)"><apex:outputText value="{!doc.Document_Specific_Changes__c}"/></textarea>
                                                        <div id="docInfoTbody1Row2_specChanges_error" class="help-block with-errors"></div>
                                                    </div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </apex:repeat>
                                    
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </apex:outputPanel>
    <!-- end of document information -->
    
     <!--Start of CR Resolution ---->
                    <!--Start of CR Resolution ---->
                  <apex:outputPanel rendered="{!$CurrentPage.parameters.pg=='cr_resolution'}">
                    
                    
                    
                    <script type="text/javascript">
                    
                    
                   $( document ).ready(function() {
                       
                        $('#docClo{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Due_Date__c').datetimepicker({dayViewHeaderFormat: 'DD MMM YYYY', format: "DD MMM YYYY"}).on('dp.change',function(selected){
                            console.log('datetime picker change for task');
                            var difMS=selected.date-new Date("{!Change_Management__c.CreatedDate}");
                            var difDays=Math.round(difMS/(1000*60*60*24));
                            $("#"+this.id.replace('Due_Date__c','Allowed_Days__c')).val(difDays);
                            $('#'+this.id+'_hidden').val(new Date(selected.date));
                            
                        }
                                                                                                                                                                          
                                                                                                                                                                         );
                        
                        
                        
                        $("#docClo{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Due_Date__c").data("DateTimePicker").minDate(new Date("{!Change_Management__c.CreatedDate}"));
                        Visualforce.remoting.Manager.invokeAction(
                            // @RemoteAction
                            '{!$RemoteAction.ChangeManagementControllerExt.getdocResolutionCodes}',
                            // Callback
                            function(result, event){
                                $.each(result, function(res) {
                                    console.log('resCode   '+result[res]);
                                    if(result[res]=='Document Change Order'){
                                        $("#{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Resolution_Code__c").append($("<option />").val(result[res]).text(result[res]));
                                    }
                                    else if({!NeedAdditionalResolutionCodes}){
                                        $("#{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Resolution_Code__c").append($("<option />").val(result[res]).text(result[res]));
                                    }
                                });
                                var selectedResolutionCode='{!JSENCODE(Change_Management__c.Resolution_Code__c)}'?'{!JSENCODE(Change_Management__c.Resolution_Code__c)}':'No Action Required';
                                $("#{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Resolution_Code__c option[value='"+selectedResolutionCode+"']").attr("selected",true);
                                  $("#{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Resolution_Code__c").trigger('change');
                                if({!ChangeManagement.Closed__c}){
                                    
                                    $("#{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Resolution_Code__c").attr('disabled',true);
                                    
                                         
                                }
                                
                               
                                
                                
                            },
                            // Don't know, couldn't find docs
                            {escape: true}
                        );   
                        
                    })  
                   
                   
                   

                                        
                    </script>
                    

                    
               <apex:outputPanel rendered="{!AND($CurrentPage.parameters.pg=='cr_resolution',changemanagement.id==$CurrentPage.parameters.id)}">
                       
                       <c:wiz_CrApproval disabled="{!OR(changemanagement.Closed__c,changemanagement.Status__c=='Void',changemanagement.ApprovalStatus__c=='Approved', changemanagement.Doc_Change__c)}" isLocked="{!OR(changemanagement.Status__c=='Pending Approval',changemanagement.Status__c=='Closed',changemanagement.Status__c=='Void',NOT(OR(ChangeManagement.OwnerId=$User.Id,ChangeManagement.Ownerid==$User.Id,$Profile.Name=='System Administrator')),ChangeManagement.Status__c == 'Closed')}"  seqFieldId="chApprSeq"  tableId="chApprTab" UserFldId="chApprUsr" allowDaysFieldId="chApprAllowed_Days__c" dueDateFieldId="chApprDue_Date__c" crDate="{!changemanagement.CreatedDate}" taskId="{!JSENCODE(changemanagement.Id)}" isApproverNoteNeeded="true" noteToApprover="{!JSENCODE(changemanagement.Note_To_Approver__c)}" isReloadNeeded="true" typeofapprover="CR_Approval" 
                                         submitForm="" initjs="if({!(changemanagement.Approval_Required__c=='Yes')}){
                                                               
                                                               $('#tableId_dv').removeClass('hidden');  
                                                               $('#tableId_lin').removeClass('hidden');
                                                               $('#tableId_CK').attr('checked', true);                
                                                               $('#tableId_tble').find('input,select').each(function(){
                                                               $(this).attr('disabled', false);   
                                                               });
                                                               }else{
                                                               $('#tableId_dv').addClass('hidden'); 
                                                               $('#tableId_lin').addClass('hidden');
                                                               $('#tableId_CK').attr('checked', false); 
                                                               }" >
                       </c:wiz_CrApproval>
                   

                   
                   <script type="text/javascript">
                   
                   function showHideBasedOnDOCResolutionCode2(){
                        $("#{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Resolution_Code__c").attr('disabled',false);
                       var fieldValue=$("#{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Resolution_Code__c").val();
                       
                       if('{!changemanagement.ApprovalStatus__c}' != 'Approved' && $("#chApprTab_CK").is(':checked')){
                           if(('{!changemanagement.Approval_Required__c}'=='Yes' && fieldValue=="No Action Required") || '{!changemanagement.ApprovalStatus__c}'=='Approved'){
                               
                               
                               $("#Resolution_Code__c").attr('disabled',true);
                               $("#Resolution_Closed_Comment__c").hide();
                               
                           }
                           
                       }  
                       
                       if('{!changemanagement.ApprovalStatus__c}' == 'Approved' && $("#chApprTab_CK").is(':checked')){
                           
                           if(('{!changemanagement.Approval_Required__c}'=='Yes' && fieldValue=="Document Change Order") || '{!changemanagement.ApprovalStatus__c}'=='Approved'){
                               
                               $("#Resolution_Code__c").attr('disabled',false);
                           }
                       }
                       
                       
                       
                       if('{!changemanagement.ApprovalStatus__c}' == 'Recall'  && $("#chApprTab_CK").is(':checked') && '{!changemanagement.Status__c}' != 'Pending Approval'){
                           
                           
                           if($("#chApprTab_CK").is(':checked')){
                               $("#chApprTab_tble").find("input,select").each(function(){
                                   $(this).attr('disabled', false);
                               });
                           }
                       
                       }
                       
                       if('{!changemanagement.ApprovalStatus__c}' == 'rejected' && '{!changemanagement.Status__c}' != 'Pending Approval'){
                           
                           if($("#chApprTab_CK").is(':checked')){
                               $("#chApprTab_tble").find("input,select").each(function(){
                                   $(this).attr('disabled', false);
                               });
                           }
                       }
                       
                   }
                   </script>

                          
                    </apex:outputPanel>
                    
                    <div class="wiz-field doc-resolution col-md-12">
                        <c:wiz_form submitpage="stringify_sobject" formid="crForm" formclass="appform validate" recordid="{!JSENCODE(Change_Management__c.Id)}" 
                                    postsavejs="location.reload();" >
                            <input type="hidden" name="sobj" value="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Change_Management__c"/>
                            <input type="hidden" id="page" name="page" value="cr_resolution"/>
                            <input type="hidden" id="stepName" name="stepName" value="Resolution" />
                            <input type="hidden" name="Id" value="{!changemanagement.Id}" />
                            <input id="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Status__c" type="hidden" name="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Status__c" value="{!JSENCODE(changemanagement.Status__c)}" />
                            <input id="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Phase__c" type="hidden" name="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Phase__c" value="{!JSENCODE(changemanagement.Phase__c)}" />
                            <input id="docResCode" type="hidden" name="docResCode" value="{!JSENCODE(changemanagement.Resolution_Code__c)}"/>  
                            
                             
                            
                            <div class="row">
                                
                               
                                  
                                
                                <c:wiz_field FieldLabel="Resolution Code" required="true" jsid="ResolutionCodeContainer" >
                                    <select  id="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Resolution_Code__c"  name="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Resolution_Code__c" class="form-control" onChange="showHideBasedOnDOCResolutionCode()"  required="required" >
                                        
                                    </select>
                                </c:wiz_field>
                                
                                <div id="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Resolution_Code__c_error" class="help-block with-errors"></div>
                                <div class="form-group" id="docAdhocBtnDiv">
                                    <div class="tab-content">
                                        <div class="wiz-fields text-right">
                                            <br/><button type="button" id='docAdhocBtn' class="btn btn-primary" onClick="resAdhoc_add_genAdhocTask($('.pageAdhoc'),'adhocDiv')" >Add Adhoc Task</button>
                                        </div>  
                                    </div>    
                                </div>
                            </div>
                            
                            
                            
                            <c:wiz_field FieldLabel="Comments" required="true" jsid="doc_resolution_closed_comments" wide="true">
                                
                                
                                <c:wiz_textarea ObjectName="Change_Management"  rendered="{!NOT(OR(changemanagement.Closed__c,NOT($ObjectType.Change_Management__c.Fields.Resolution_Closed_Comment__c.updateable)))}"  FieldName="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Resolution_Closed_Comment__c" initvalue="{!Change_Management__c.Resolution_Closed_Comment__c}" Required="true"/>
                                
                                <apex:outputpanel rendered="{!OR(changemanagement.Closed__c,NOT($ObjectType.Change_Management__c.Fields.Resolution_Closed_Comment__c.updateable))}">
                                    <div class="alert alert-info" >
                                        <apex:outputField value="{!changemanagement.Resolution_Closed_Comment__c}" />
                                    </div>
                                </apex:outputpanel>
                                
                            </c:wiz_field>
                            
                        </c:wiz_form>
                        
                        
                        <div class="clearfix"/>
                        
                        <div id="docWorkflowDiv" >
                            
                            <div class="pageAdhoc" id="pageAdhoc">
                                
                                <c:wiz_addadhoctask funcprefix="resAdhoc" status="{!JSENCODE(changemanagement.Status__c)}" adhocTaskList="{!adhocTasks}" divfrom="pageAdhoc"  divId="adhocDiv"  seqFieldId="adhocseq" userFieldId="adhocusr" allowDaysFieldId="adhocAllowed_Days__c" dueDateFieldId="adhocDue_Date__c" taskTitle="adhocTitle" isFieldRequired="false" typeOfUser="CR_Task_Owner" />
                                
                            </div>
                            
                            <apex:repeat value="{!adhocTasks}" var="adt" rendered="{!OR(changemanagement.Status__c=='Pending Approval',changemanagement.Status__c=='Closed',changemanagement.Status__c=='Void',changemanagement.Status__c=='Document Change Order')}">
                                <c:wiz_displayadhoctasks taskTitle="{!JSENCODE(adt.AdhocTask_Title__c)}" seqInitValue="{!adt.Sequence_Position__c}"  userInitValue="{!JSENCODE(adt.Owner.Name)}" allowDaysInitValue="{!adt.Allowed_Days__c}" dueDateInitValue="{!adt.Due_Date__c}"/>
                            </apex:repeat>
                            <c:wiz_task task="DocumentChange"  taskTitle="Document Change" seqFieldId="docInv{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Sequence__c" seqInitValue="{!IF(ISBLANK(dcTask.Sequence_Position__c),10,dcTask.Sequence_Position__c)}" userFieldId="docInvUser" userInitValue="{value:'{!JSENCODE(dcTask.OwnerId)}', label:'{!JSENCODE(dcTask.Owner.Name)}'}" allowDaysFieldId="inv{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Allowed_Days__c" allowDaysInitValue="{!dcTask.Allowed_Days__c}" dueDateFieldId="inv{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Due_Date__c" dueDateInitValue="{!dcTask.Due_Date__c}"  ncCrDt="{!Change_Management__c.CreatedDate}"  isTaskChecked="{!hasdcTask}" disabled="true" typeoftaskowner="CR_Task_Owner" isSeqDisabled="true">   </c:wiz_task>
                            
                            
                            
                        </div>
                        
                        <div id="closurePanel" class="panel panel-default panel-info">
                        
                            <div class="panel-heading"> Closure</div>
                            <div class="panel-body">
                                
                                <table class="table">
                                    
                                    <thead>
                                        <tr>
                                            <td width="40%"><span class="mandatory"><apex:outputtext value="*"/></span>&nbsp;&nbsp;Owner</td>
                                            <td width="20%"><span class="mandatory"><apex:outputtext value="*"/></span>&nbsp;&nbsp;{!$ObjectType.General_Task__c.Fields.Allowed_Days__c.Label}</td>
                                            <td><span class="mandatory"><apex:outputtext value="*"/></span>&nbsp;&nbsp;{!$ObjectType.General_Task__c.Fields.Due_Date__c.Label}</td>
                                        </tr>
                                    </thead>
                                    
                                    <tbody>
                                        <tr>
                                            <td>
                                                <c:wiz_multi width="100%" required="true"  disabled="{!OR(changemanagement.Closed__c,NOT($ObjectType.Change_Management__c.Fields.Resolution_Code__c.Updateable),Change_Management__c.Resolution_Code__c=='Document Change Order')}" FieldId="cloUser" multiple="false" queryFields="Name" querytable="User"
                                                             queryorderby="Id"
                                                             initvalues="{value:'{!JSENCODE(closTask.OwnerId)}', label:'{!JSENCODE(closTask.Owner.Name)}'}" typeofuser="CR_Task_Owner"
                                                             />
                                                
                                                
                                            </td>
                                            <td>
                                                <c:wiz_input disabled="false"  required="true" min="0" type="number" fieldname="docClo{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Allowed_Days__c" initvalue="{!closTask.Allowed_Days__c}"  onblur="autoCalculateDueDate(this,'docClo{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Due_Date__c','{!changemanagement.CreatedDate}')" ></c:wiz_input>
                                                
                                                
                                            </td>
                                            <td>
                                                <c:wiz_date maxdateallowed="{!month(today())}/{!day(today())}/{!year(today())+100}" FieldId="docClo{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Due_Date__c" initdate="{!closTask.Due_Date__c}" updateable="true"/>
                                            </td>
                                        </tr>
                                    </tbody>
                                    
                                </table> 
                                
                                
                                
                                <c:wiz_approval disabled="{!OR(changemanagement.Closed__c,changemanagement.Status__c=='Void',changemanagement.Doc_Change__c)}"  seqFieldId="closApprSeq" tableId="closApprTab" userFieldId="closApprUsr" allowDaysFieldId="closApprAllowed_Days__c" dueDateFieldId="closApprDue_Date__c" crDate="{!changemanagement.CreatedDate}" taskId="{!JSENCODE(closTask.Id)}" isApproverNoteNeeded="true" noteToApprover="{!JSENCODE(closTask.Note_To_Approver__c)}" isReloadNeeded="true" typeofapprover="CR_Approval" submitForm=""></c:wiz_approval>
                                
                                
                                        
                            </div>  
                            
                            
                    </div> 
                       
                        
                        
                    </div>
                    
           <c:wiz_approvalbutton approvalbuttonid="ApprovaButtonIdNcContainment" jsid="javascriptidForApprovalbutton" RecordId="{!changemanagement.Id}" rendered="{!OR($User.Id==changemanagement.Approver__c,$User.Id==changemanagement.Approver_1__c,$User.Id==changemanagement.Approver_2__c,$User.Id==changemanagement.Approver_3__c,$User.Id==changemanagement.Approver_4__c,$User.Id==changemanagement.Approver_5__c,$User.Id==changemanagement.Approver_6__c,$User.Id==changemanagement.Approver_7__c,$User.Id==changemanagement.Approver_8__c,$User.Id==changemanagement.Approver_9__c,$User.Id==changemanagement.Initial_Submitter__c)}"/>
           
                    
                </apex:outputPanel>    
    <apex:outputPanel rendered="{!OR($CurrentPage.parameters.pg=='cr_resolution')}" >
                        <apex:define name="approvalHistory" >
                            <c:wiz_approvalHistory rendered="true"  TargetobjectId="{!$CurrentPage.parameters.id}" Parent="Change Request"></c:wiz_approvalHistory>
                        </apex:define>
    </apex:outputPanel>
                            
                <!-- End of CR Resolution --->
     
                    <!-- Begin : CR details-->
<apex:outputPanel rendered="{!OR($CurrentPage.parameters.pg=='cr_details')}" >
    
    <input type="hidden" name="page" id="page" value="cr_details"/>
    <input type="hidden" id="stepName" name="stepName" value="cr_details" />
               
    <h1><apex:outputText value="CR Initiation"/></h1>  <!-- make value dynamic here -->
    
    <table class="table table-responsive table-bordered">
        <apex:repeat value="{!$ObjectType.Change_Management__c.FieldSets.Initiation_Fields}"
                     var="f">
            <tr>
                <td class="title-col">
                    {!if($ObjectType.Change_Management__c.Fields[f].Label=='Owner ID','Owner',$ObjectType.Change_Management__c.Fields[f].Label)}
                </td>
                <td>
                    <!--<apex:outputField value="{!changemanagement[f]}"/> -->
                    <apex:outputPanel rendered="{!f!='Document_Number__c'}">
                        <apex:outputField value="{!changemanagement[f]}"/>
                    </apex:outputPanel>
                    <apex:outputPanel rendered="{!f=='Document_Number__c'}">
                        <apex:outputText value="{!if(changemanagement.Change_Type__c=='New',changemanagement.Document_Number__c,changemanagement.Document_Profile__r.Name)}"/>
                    </apex:outputPanel>
                </td>
            </tr>
        </apex:repeat>                    
    </table>
    <h1><apex:outputText value="Additional Information" /></h1>  <!-- make value dynamic here -->
    
    <table class="table table-responsive table-bordered">
        <apex:repeat value="{!$ObjectType.Change_Management__c.FieldSets.Additional_Fields}"
                     var="f">
            <tr>
                <td class="title-col">
                    {!if($ObjectType.Change_Management__c.Fields[f].Label=='Owner ID','Owner',$ObjectType.Change_Management__c.Fields[f].Label)}
                </td>
                <td>
                    <!--<apex:outputField value="{!changemanagement[f]}"/> -->
                    <apex:outputPanel rendered="{!f!=IF(NOT(ISBLANK(Prefix)),Prefix+'__Impacted_Sites__c','Impacted_Sites__c')}">
                        <apex:outputField value="{!changemanagement[f]}"/> 
                    </apex:outputPanel>
                    <apex:outputPanel rendered="{!f==IF(NOT(ISBLANK(Prefix)),Prefix+'__Impacted_Sites__c','Impacted_Sites__c')}">
                        <div class="col-md-12">
                            <c:wiz_multi width="100%"
                                             required="{!f.required}"
                                             FieldId="{!f}"
                                             multiple="true"
                                             FieldName="{!f}"
                                             queryFields="Name"
                                             querytable="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Manufacturing_Site__c"
                                             dataid=""                                      
                                             disabled="true">
                            <apex:repeat value="{!ImpactedSites}" var="impatedsite">
                                <option selected="selected" value="{!JSENCODE(impatedsite.id)}">{!JSENCODE(impatedsite.Name)}</option>
                            </apex:repeat>
                            </c:wiz_multi>
                            
                        </div>
                        
                        
                    </apex:outputPanel>
                </td>
            </tr>
        </apex:repeat>                    
    </table>
    
    <!-----------------custom fileds---------------------------------->
    <apex:outputPanel rendered="{!$ObjectType.Change_Management__c.FieldSets.ChangeManagement_Custom_Fields.size!=0}">
        <h1><apex:outputText value="Custom Fields" /></h1>
        <table class="table table-responsive table-bordered">
            <tbody>
                <apex:repeat value="{!$ObjectType.Change_Management__c.FieldSets.ChangeManagement_Custom_Fields}" var="f">
                    <apex:outputPanel rendered="{!$ObjectType.Change_Management__c.Fields[f].Accessible}">
                        <tr>
                            <td class="title-col">
                                {!$ObjectType.Change_Management__c.Fields[f].label}
                            </td>
                            <td>
                                <apex:outputPanel rendered="{!$ObjectType.Change_Management__c.Fields[f].type=='textarea'}">
                                    <div class="alert alert-info"> <apex:outputField value="{!changemanagement[f]}" /> </div>
                                </apex:outputPanel>
                                <apex:outputPanel rendered="{!$ObjectType.Change_Management__c.Fields[f].type=='date'}">
                                    <apex:outputText value="{0,date, dd MMMM yyyy}"> 
                                        <apex:param value="{!changemanagement[f]}"/>
                                    </apex:outputText>
                                </apex:outputPanel>
                                <apex:outputPanel rendered="{!NOT(OR($ObjectType.Change_Management__c.Fields[f].type=='date',$ObjectType.Change_Management__c.Fields[f].type=='reference',$ObjectType.Change_Management__c.Fields[f].type=='textarea'))}">
                                    {!JSENCODE(changemanagement[f])}
                                </apex:outputPanel>
                                <apex:outputPanel rendered="{!$ObjectType.Change_Management__c.Fields[f].type=='reference'}">
                                    {!JSENCODE(changemanagement[$ObjectType.Change_Management__c.Fields[f].relationshipName].Name)}
                                </apex:outputPanel>
                            </td>
                        </tr>                                
                    </apex:outputPanel>  
                </apex:repeat>
            </tbody>
        </table>
    </apex:outputPanel> 
    <!------------------------------------------------------>
    <apex:outputPanel rendered="{!changemanagement.Approval_Required__c=='Yes'}">
        <h2>Approvers</h2>
        <table class="table table-responsive table-bordered">
            <tbody>
                <tr>
                    <th>Approver</th>
                    <th>Sequence</th>
                    <th>Allowed Days</th>
                    <th>Due Date</th>
                    <th>Status</th>
                    <th>Approved Date</th>
                </tr>
                <apex:repeat value="{!changemanagementApprovers}" var="Ap">
                    <tr>
                        <td>{!Ap.User__r.Name}</td>
                        <td>{!Ap.Sequence_Position__c}</td>
                        <td>{!Ap.Allowed_Days__c}</td>
                        <td>
                            <apex:outputText value="{0,date,dd MMM yyyy}">
                                <apex:param value="{!Ap.Due_Date__c}" /> 
                            </apex:outputText>                                  
                        </td>
                        <td><apex:outputText value="{!Ap.Status__c}"></apex:outputText> </td>
                        <td>
                            <apex:outputText value="{0,date,dd MMM yyyy}">
                                <apex:param value="{!Ap.Status_Updated__c}" /> 
                            </apex:outputText>                                      
                        </td>
                    </tr>                                
                </apex:repeat>
                
            </tbody>
        </table>
   </apex:outputPanel>
        <!-------------------------------------------------------->
    
   <h1><apex:outputText value="Document Info"/></h1>  
    <apex:repeat value="{!Change_Management__c.Sub_Change_Management__r}" var="doc">
        <table class="table table-responsive table-bordered">
            
            <apex:outputPanel rendered="{!$ObjectType.Sub_Change_Management__c.Fields.Type__c.Accessible}"> 
                <tr>
                    <td class="title-col">
                        <apex:outputText value="{!JSENCODE(IF(contains(customLabelKeys,'Type__c'),customLabels['Type__c'].Field_Label__c, $ObjectType.Sub_Change_Management__c.Fields.Type__c.Label))}"/>
                        
                    </td>
                    <td>
                        {!JSENCODE(doc.Type__c)}
                    </td>
                </tr>
                
            </apex:outputPanel> 
            
            <apex:outputPanel rendered="{!doc.Type__c=='New'}">
                <apex:outputPanel rendered="{!$ObjectType.Sub_Change_Management__c.Fields.Document_Name__c.Accessible}"> 
                    <tr>
                        <td class="title-col">
                            <apex:outputText value="{!JSENCODE(IF(contains(customLabelKeys,'Document_Name__c'),customLabels['Document_Name__c'].Field_Label__c, $ObjectType.Sub_Change_Management__c.Fields.Document_Name__c.Label))}"/>
                            
                        </td>
                        <td>
                            {!JSENCODE(doc.Document_Name__c)}
                        </td>
                    </tr>
                    
                </apex:outputPanel>
            </apex:outputPanel>
            <apex:outputPanel rendered="{!doc.Type__c!='New'}">
                
                <apex:outputPanel rendered="{!$ObjectType.Sub_Change_Management__c.Fields.Document_Profile_Name__c.Accessible}"> 
                    <tr>
                        <td class="title-col">
                            <apex:outputText value="{!JSENCODE(IF(contains(customLabelKeys,'Document_Profile_Name__c'),customLabels['Document_Profile_Name__c'].Field_Label__c, $ObjectType.Sub_Change_Management__c.Fields.Document_Profile_Name__c.Label))}"/>
                            
                        </td>
                        <td>
                            {!JSENCODE(doc.Document_Profile_Name__c)}
                        </td>
                    </tr>
                    
                </apex:outputPanel>
            </apex:outputPanel>
            
            <apex:outputPanel rendered="{!$ObjectType.Sub_Change_Management__c.Fields.Current_Rev__c.Accessible}"> 
                <tr>
                    <td class="title-col">
                        <apex:outputText value="{!JSENCODE(IF(contains(customLabelKeys,'Current_Rev__c'),customLabels['Current_Rev__c'].Field_Label__c, $ObjectType.Sub_Change_Management__c.Fields.Current_Rev__c.Label))}"/>
                        
                    </td>
                    <td>
                        {!JSENCODE(doc.Current_Rev__c)}
                    </td>
                </tr>
                
            </apex:outputPanel> 
            
            <apex:outputPanel rendered="{!$ObjectType.Sub_Change_Management__c.Fields.New_Rev__c.Accessible}"> 
                <tr>
                    <td class="title-col">
                        <apex:outputText value="{!JSENCODE(IF(contains(customLabelKeys,'New_Rev__c'),customLabels['New_Rev__c'].Field_Label__c, $ObjectType.Sub_Change_Management__c.Fields.New_Rev__c.Label))}"/>
                        
                    </td>
                    <td>
                        {!JSENCODE(doc.New_Rev__c)}
                    </td>
                </tr>
                
            </apex:outputPanel> 
            
            <apex:outputPanel rendered="{!$ObjectType.Sub_Change_Management__c.Fields.Status__c.Accessible}"> 
                <tr>
                    <td class="title-col">
                        <apex:outputText value="{!JSENCODE(IF(contains(customLabelKeys,'Status__c'),customLabels['Status__c'].Field_Label__c, $ObjectType.Sub_Change_Management__c.Fields.Status__c.Label))}"/>
                        
                    </td>
                    <td>
                        {!JSENCODE(doc.Status__c)}
                    </td>
                </tr>
                
            </apex:outputPanel> 
            
            <apex:outputPanel rendered="{!$ObjectType.Sub_Change_Management__c.Fields.Relation__c.Accessible}"> 
                <tr>
                    <td class="title-col">
                        <apex:outputText value="{!JSENCODE(IF(contains(customLabelKeys,'Relation__c'),customLabels['Relation__c'].Field_Label__c, $ObjectType.Sub_Change_Management__c.Fields.Relation__c.Label))}"/>
                        
                    </td>
                    <td>
                        {!JSENCODE(doc.Relation__c)}
                    </td>
                </tr>
                
            </apex:outputPanel> 
            
            <apex:outputPanel rendered="{!$ObjectType.Sub_Change_Management__c.Fields.Owner__c.Accessible}"> 
                <tr>
                    <td class="title-col">
                        <apex:outputText value="{!JSENCODE(IF(contains(customLabelKeys,'Owner__c'),customLabels['Owner__c'].Field_Label__c, $ObjectType.Sub_Change_Management__c.Fields.Owner__c.Label))}"/>
                        
                    </td>
                    <td>
                        {!JSENCODE(doc.Owner__c)}
                    </td>
                </tr>
                
            </apex:outputPanel> 
            
            <apex:outputPanel rendered="{!$ObjectType.Sub_Change_Management__c.Fields.Document_Specific_Changes__c.Accessible}"> 
                <tr>
                    <td class="title-col">
                        <apex:outputText value="{!JSENCODE(IF(contains(customLabelKeys,'Document_Specific_Changes__c'),customLabels['Document_Specific_Changes__c'].Field_Label__c, $ObjectType.Sub_Change_Management__c.Fields.Document_Specific_Changes__c.Label))}"/>
                        
                    </td>
                    <td>
                        {!JSENCODE(doc.Document_Specific_Changes__c)}
                    </td>
                </tr>
                
            </apex:outputPanel> 
            
             
        </table>
    </apex:repeat>
    
    <div class="panel-group screen-only" id="accordion" role="tablist" aria-multiselectable="true">
    <div class="panel panel-default">
        <div class="panel-heading" role="tab" id="headingCMResolutionCode">
            <h4 class="panel-title">
                <a class="btn btn-link btn-xs pull-right" data-toggle="collapse" data-parent="#accordion" href="#collapseCMResolutionCode" aria-expanded="true" aria-controls="collapseCMResolutionCode">
                    <span class="glyphicon glyphicon-chevron-down" aria-hidden="true"></span>
                </a>                            
                
                
                <a data-toggle="collapse" data-parent="#accordion" href="#collapseCMResolutionCode" aria-expanded="true" aria-controls="collapseCMResolutionCode">
                    Resolution ({!JSENCODE(changemanagement.Resolution_Code__c)})
                </a>
            </h4> 
        </div>            
        
        <div id="collapseCMResolutionCode" class="panel-collapse collapse out" role="tabpanel" aria-labelledby="headingCMResolutionCode">
            <div class="panel-body">                        
                <div class="add-contain-wrapper added-containment-action screen-only">
                    <div class="add-containment">   
                        
                        <apex:outputPanel rendered="{!if(OR(changemanagement.Resolution_Code__c == 'No Action Required'),true,false)}">
                            <apex:outputPanel rendered="{!$ObjectType.Change_Management__c.Fields.Resolution_Closed_Comment__c.Accessible}">
                                <table class="table table-responsive table-bordered">
                                    <tbody>
                                        <tr>
                                            <td class="title-col">
                                                <apex:outputText value="{!JSENCODE(IF(contains(customLabelKeys,'Resolution_Closed_Comment__c'),customLabels['Resolution_Closed_Comment__c'].Field_Label__c, $ObjectType.Change_Management__c.Fields.Resolution_Closed_Comment__c.Label))}"/>
                                            </td>
                                            <td>
                                                <div class="alert alert-info">   <apex:outputfield value="{!changemanagement.Resolution_Closed_Comment__c}"></apex:outputfield></div>
                                            </td>
                                            
                                        </tr>
                                    </tbody>
                                </table>
                            </apex:outputPanel>
                        </apex:outputPanel>
                        
                        <apex:outputPanel rendered="{!if(changemanagement.Resolution_Code__c=='Document Change Order',true,false)}">
                            <table class="table table-responsive table-bordered">
                                <tbody>
                                    <tr>
                                        <th>Task Name</th>
                                        <th>Sequence</th>
                                        <th>Owner</th>
                                        <th>Allowed Days</th>
                                        <th>Due Date</th>
                                    </tr>
                                    
                                    <apex:repeat value="{!allCRGnrlTasks}"  var="General_Task">                                              
                                        <tr>
                                            <td>{!if(General_Task.RecordType.Name=='AdhocTask',General_Task.AdhocTask_Title__c,General_Task.RecordType.Name)}</td>
                                            <td>{!if(General_Task.RecordType.Name=='Closure','',General_Task.Sequence_Position__c)}</td>
                                            <td>{!JSENCODE(General_Task.Owner.Name)}</td>
                                            <td>{!General_Task.Allowed_Days__c}</td>
                                            <td>  
                                                <apex:outputText value="{0,date,dd MMM yyyy}">
                                                    <apex:param value="{!General_Task.Due_Date__c}" /> 
                                                </apex:outputText>
                                            </td>
                                        </tr>
                                    </apex:repeat>
                                    
                                </tbody>
                            </table> 
                        </apex:outputPanel>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
 
<!--v1.2 start-->   
<apex:outputPanel rendered="{!if(AND($ObjectType.Change_Management__c.Fields.Resolution_Code__c.Accessible,ChangeManagement.Resolution_Code__c=='Document Change Order'),true,false)}">
    <c:wiz_task_details DocumentChangeTask="{!dcTask}" closureTask="{!closTask}" module="ChangeManagement" adhocTasks="{!adhocTasks}"></c:wiz_task_details>
</apex:outputPanel>
 <!-- v1.2 end -->
    
</apex:outputPanel>
    <!-- End CR Details-->
</apex:define>
        <apex:define name="approvalHistory">
                    <c:wiz_approvalHistory rendered="{!OR($CurrentPage.parameters.pg=='cr_init',isblank($CurrentPage.parameters.pg))}" Parent="Change Management" TargetobjectId="{!$CurrentPage.parameters.id}"></c:wiz_approvalHistory>  
        </apex:define>
<apex:define name="buttonbar">

    <div
        class="fix-footer navbar-fixed-bottom navbar-inverse wiz-button-bar"
        style="position: fixed">
        <div class="col-sm-12 text-right">

            <apex:outputPanel rendered="{!OR($CurrentPage.parameters.pg=='cr_init',ISBLANK($CurrentPage.parameters.pg))}">
                <apex:outputpanel layout="none"
                    rendered="{!AND(OR($ObjectType.Change_Management__c.Updateable, AND(ISBLANK(Change_Management__c.Id), $ObjectType.Change_Management__c.Createable)))}">
                    <button type="button" class="btn btn-default"
                        onclick="cancelPopup();">
                        <span class="fa fa-close"></span> Cancel
                    </button>
                <apex:outputPanel rendered="{!NOT(ChangeManagement.Closed__c)}">
                    <button type="submit"
                        onclick="$(this).addClass('most-recent-click');$('#nextBtn').removeClass('most-recent-click');validate(null,undefined,'crForm');"
                        id="submitBtn"
                        class="btn {!IF(NOT(ISBLANK(ChangeManagement.Id)),'btn-primary','btn-success')} dont-allow-multiple-clicks">
                        <span
                            class="fa {!IF(NOT(ISBLANK(ChangeManagement.Id)),'fa fa-floppy-o','fa fa-send')}"></span>
                        {!IF(NOT(ISBLANK(ChangeManagement.Id)),'Save','Submit')}
                    </button>
                </apex:outputPanel> 
                    <apex:outputpanel layout="none"
                        rendered="{!NOT(ISBLANK(Change_Management__c.Id))}">

                        <button type="submit" id="nextBtn"
                            onclick="$(this).addClass('most-recent-click'); $('#submitBtn').removeClass('most-recent-click');
                         window.location.href = '/apex/ChangeManagement?id={!JSENCODE($Currentpage.parameters.Id)}&pg=doc_info'"
                            class="btn btn-primary dont-allow-multiple-clicks">
                            <span class="fa fa-step-forward"></span> Next
                        </button>


                    </apex:outputpanel>


                </apex:outputpanel>
            </apex:outputPanel>
            <!--begin Doc Info buttons -->
            <apex:outputPanel rendered="{!$CurrentPage.parameters.pg=='doc_info'}">
            	<apex:outputPanel rendered="{!OR(If(changemanagement.General_Tasks__r.size!=0,$User.Id == changemanagement.General_Tasks__r[0].OwnerId,false),$Profile.Name == 'System Administrator',$User.Id == changemanagement.OwnerId)}">
	                <apex:outputPanel rendered="{!OR(NOT(changemanagement.Closed__c),NOT(changemanagement.Status__c == 'Pending Approval'),NOT(changemanagement.Status__c == 'Document Change Order'))}">
	                	<apex:outputPanel rendered="{!IF(changemanagement.General_Tasks__r.size!=0,AND(IF(changemanagement.General_Tasks__r.size!=0,changemanagement.General_Tasks__r[0].Status__c != 'Pending Action Completion',true),IF(changemanagement.General_Tasks__r.size!=0,changemanagement.General_Tasks__r[0].Status__c != 'Closed',true),IF(changemanagement.General_Tasks__r.size!=0,changemanagement.General_Tasks__r[0].Status__c != 'Void',true),IF(changemanagement.General_Tasks__r.size!=0,changemanagement.General_Tasks__r[0].Status__c != 'Pending Approval',true),IF(changemanagement.General_Tasks__r.size!=0,changemanagement.General_Tasks__r[0].Status__c != 'Created',true)),IF(changemanagement.Status__c == 'Open',true,false))}">
		                    <button type="button" id="cancel"
		                        class="btn btn-default dont-allow-multiple-clicks"
		                        data-toggle="modal" onclick="cancelPopup();">
		                        <span class="fa fa-close"></span> Cancel
		
		                    </button>
		                    <button type="button" id="save"
		                        class="btn btn-primary dont-allow-multiple-clicks"
		                        onclick="isSubmit=false;saveDocInfo();">
		                        <span class="fa fa-floppy-o"></span> Save
		                    </button>
		                    <button type="button" id="submit"
		                        class="btn btn-success dont-allow-multiple-clicks"
		                        data-toggle="modal"
		                        onclick="isSubmit=true;submitDocInfo();">
		                        <span class="fa fa-send"></span> Submit
		                    </button>
	                    </apex:outputPanel>
	                </apex:outputPanel> 
	                <apex:outputPanel rendered="{!OR(changemanagement.Closed__c,changemanagement.Status__c == 'Pending Approval',changemanagement.Status__c == 'Document Change Order',IF(changemanagement.General_Tasks__r.size!=0,changemanagement.General_Tasks__r[0].Status__c == 'Pending Action Completion',false),IF(changemanagement.General_Tasks__r.size!=0,changemanagement.General_Tasks__r[0].Status__c == 'Closed',false),IF(changemanagement.General_Tasks__r.size!=0,changemanagement.General_Tasks__r[0].Status__c == 'Void',false),IF(changemanagement.General_Tasks__r.size!=0,changemanagement.General_Tasks__r[0].Status__c == 'Pending Approval',false),IF(changemanagement.General_Tasks__r.size!=0,changemanagement.General_Tasks__r[0].Status__c == 'Created',false))}">
		                <apex:outputPanel rendered="{!IF(changemanagement.General_Tasks__r.size!=0,changemanagement.General_Tasks__r[0].Status__c != 'Open',true)}">
		                    <button type="button" id="nextbtn" class="btn btn-primary dont-allow-multiple-clicks" onclick="window.location='/apex/changemanagement?id='+'{!JSENCODE(ChangeManagement.Id)}&pg=cr_resolution'"><span class="fa fa-step-forward"></span> Next </button>
		                </apex:outputPanel>
	                </apex:outputPanel>
	        	</apex:outputPanel>        
            </apex:outputPanel>
            <!--end doc info buttons  -->
           <!-- begin Cr resolution buttons -->
                          <apex:outputPanel rendered="{!OR($CurrentPage.parameters.pg=='cr_resolution')}">
                            <apex:outputpanel layout="none" rendered="{!AND(NOT(changemanagement.Closed__c),$ObjectType.Change_Management__c.Updateable,changemanagement.Status__c != 'Pending Approval')}">
                                <button type="button" class="btn btn-default" id="PageCancelButton" onclick="cancelPopup();"><span class="fa fa-close"></span> Cancel</button>
                            </apex:outputpanel>
                            <apex:outputpanel layout="none" rendered="{!AND(NOT(changemanagement.Closed__c),$ObjectType.Change_Management__c.Updateable,changemanagement.Status__c != 'Pending Approval')}">
                                <button 
                                        id="PageSaveButton" 
                                        type="button" 
                                        onclick="$(this).addClass('most-recent-click'); $('#PageSubmitButton').removeClass('most-recent-click');disableApprovers();saveCr();resAdhoc_gentaskValidate();" 
                                        class="btn btn-primary"
                                        ><span class="fa fa-floppy-o"></span> Save</button>
                            </apex:outputpanel>
                            <apex:outputpanel layout="none" rendered="{!AND(NOT(changemanagement.Closed__c),$ObjectType.Change_Management__c.Updateable,changemanagement.Status__c != 'Pending Approval')}">        
                                <button 
                                        id="PageSubmitButton" 
                                        type="button" 
                                        onclick="onSubmit();" 
                                        class="btn btn-success" 
                                        data-target="#signature"
                                        ><span class="fa fa-send"></span> Submit</button>
                            </apex:outputpanel> 
                            
                            <apex:outputPanel rendered="{!if(changemanagement.Status__c=='Pending Approval',true,false)}">   
                                
                                <apex:outputPanel rendered="{!OR($User.Id==changemanagement.Approver__c,$User.Id==changemanagement.Approver_1__c,$User.Id==changemanagement.Approver_2__c,$User.Id==changemanagement.Approver_3__c,$User.Id==changemanagement.Approver_4__c,$User.Id==changemanagement.Approver_5__c,$User.Id==changemanagement.Approver_6__c,$User.Id==changemanagement.Approver_7__c,$User.Id==changemanagement.Approver_8__c,$User.Id==changemanagement.Approver_9__c)}">
                                    <button type="submit" id="ApprovaButtonIdNcContainment"  onclick="ApprovePopupModal();" class="btn btn-success dont-allow-multiple-clicks"><span class='fa fa-thumbs-o-up'></span> Decision</button>
                                </apex:outputPanel>
                                
                                <apex:outputPanel rendered="{!(changemanagement.Initial_Submitter__c==$User.Id)}">
                                    <button type="submit" id="RecallButtonIdNcContainment"  onclick="RecallPopupModal();" class="btn btn-primary  dont-allow-multiple-clicks "><span class="fa fa-mail-reply-all"></span> Recall</button>     
                                </apex:outputPanel>                                                                             
                            </apex:outputPanel>
                            
                            <apex:outputPanel rendered="{!OR(changemanagement.Doc_Change__c,changemanagement.Status__c=='Closed')}">
                                <c:wiz_nextButton subTask="{!Change_Management__c.General_Tasks__r}" currentPosition="0"></c:wiz_nextButton>
                            </apex:outputPanel>
                        </apex:outputPanel>
                        
                       
                        
                        <!-- End  CR Resolution buttons--->

            
        </div>
    </div>
</apex:define>

<!---contextual Help in progess starts-->
<apex:define name="rightpane">
     <!-- Right container -->
        <div id="rightContainer" class="tab-content">
        
         <div class="tab-pane active help" id="help">
             <c:Contextual_Help currentpage2="{!IF(ISBLANK($CurrentPage.parameters.pg),'cr_init',$CurrentPage.parameters.pg)}" />
         </div>  
    
    <!-- Help Pane -->
 <div Class="tab-content">
    <c:wiz_attachments record_id="{!ChangeManagement.Id}" showAddButtonLink="{!AND(NOT(ISBLANK(ChangeManagement.Id)),NOT(ChangeManagement.Status__c=='Closed'))}"></c:wiz_attachments>
</div>

<div class="tab-pane active help" id="help">
    <!--<c:Contextual_Help currentpage1="{!IF(ISBLANK($CurrentPage.parameters.pg),'capa_init',$CurrentPage.parameters.pg)}" />-->
    
       
</div>

 <div Class="tab-content">
                        <c:wiz_attachments record_id="{!ChangeManagement.Id}" showAddButtonLink="{!AND(NOT(ISBLANK(ChangeManagement.Id)),NOT(ChangeManagement.Status__c=='Closed'))}"></c:wiz_attachments>
                    </div>


<!--v1.3 start chronology-->
    <div class="tab-pane  chronology" id="chronology">
        <c:changemanagement_chronology rendered="{!$CurrentPage.parameters.pg=='cr_details'}" CMID="{!JSENCODE(ChangeManagement.Id)}"/>                     
    </div> 
 <!--v1.3 end chronology -->
</div>
    </apex:define>
<!--contextual help in progress ends-->              
       
</apex:composition>
<!-- Begin : JavaScript For Resolution -->
        <apex:outputPanel rendered="{!OR($CurrentPage.parameters.pg=='cr_resolution')}">
            <script type="text/javascript">
            
            $(document).ready(function() { 
                $("#docAdhocBtn").hide();
                if({!OR(changemanagement.Status__c=='Closed',changemanagement.Status__c=='Void')})
                    $("#docAdhocBtn").attr('disabled','disabled');
                if({!OR(changemanagement.Closed__c,NOT($ObjectType.Change_Management__c.Fields.Resolution_Code__c.Updateable),Change_Management__c.Resolution_Code__c=='Document Change Order')})
                       $('#{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Resolution_Code__c').attr('disabled','disabled');
                         
               
                
            });
            
            function cancelPopup()
            {
                var YESButtonInRedirectModalOnClick = function () {
            window.location.href = '/apex/qlt_dashboard';
        };
        var NOButtonInRedirectModalOnClick = function () {
            
        };
        $('#redirectDialog .btn-primary').bind( "click", YESButtonInRedirectModalOnClick);
        $('#redirectDialog .btn-default').bind( "click", NOButtonInRedirectModalOnClick);
        
        // Show the redirect dialog
        $('#redirectDialog').modal('show');
        
        // Remove the onClick event
        $('#redirectDialog').on('hidden.bs.modal', function () {
            $('#redirectDialog .btn-primary').unbind( "click", YESButtonInRedirectModalOnClick);
            $('#redirectDialog .btn-default').unbind( "click", NOButtonInRedirectModalOnClick);
        }) 
                
            }
            
           
            
        
                                function onSubmit(){
                                    
                                    $(this).addClass('most-recent-click');
                                    $('#PageSaveButton').removeClass('most-recent-click');
                                    resAdhoc_gentaskValidate();
                                    
                                    if(($("#chApprTab_CK").is(':checked') &&  '{!changemanagement.ApprovalStatus__c}'!='Approved' ) || ('{!changemanagement.Approval_Required__c}'=='Yes' && '{!changemanagement.ApprovalStatus__c}'!='Approved') ){
                                        if(isApprValid()){
                                            saveCRApprovalData('{!JSENCODE(changemanagement.Id)}',true);
                                        }
                                    }
                                    else{ 

                                        validate({'submit':true});
                                    }
                                    
                                    if(!$("#chApprTab_CK").is(':checked')){
                                        
                                       validate({'submit':false});
                                        
                                    }
                                    if(!$("#chApprTab_CK").is(':checked') && $('#{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Resolution_Code__c').val()=='No Action Required'){

                                       validate({'submit':true});
                                        
                                    }
                                    
                                    
                                }
             
            
            function updateCRStatus(){
                 if($('#{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Resolution_Code__c').val()=='Document Change Order' ){
                    $('#{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Status__c').val('Document Change Order');
                      $('#crForm').submit();

                } 
                if($('#{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Resolution_Code__c').val()=='No Action Required' ){


                    $('#{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Status__c').val('Closed'); 
                }
               
                
                
                 
            }
            function navigateAfterDigitalSignature(){
               

                
                
                if('{!changemanagement.ApprovalStatus__c}' != 'Approved' && $("#chApprTab_CK").is(':checked')){
                    
                    if($("#chApprTab_CK").is(':checked') && ('{!changemanagement.ApprovalStatus__c}' != 'Approved' || '{!changemanagement.ApprovalStatus__c}' != 'rejected' || '{!changemanagement.ApprovalStatus__c}' != 'Recall')){
                        
                        if(isApprValid()){
                            saveCRApprovalData('{!JSENCODE(changemanagement.Id)}',true); 
                        }
                    }
                    
                }
                
                else{
                    
                    var value=$("#{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Resolution_Code__c").val();
                    if(value=='Document Change Order'){
                        
                        if(isTasksValid() && isDatesValid()){
                            
                            
                            $('#PageSaveButton').attr('disabled','true');
                            $('#PageSubmitButton').attr('disabled','true');
                            $('#PageCancelButton').attr('disabled','true');
                            updateCRStatus();
                            $('#crForm').submit();
                            createDOCTasks(true);
                            
                        }
                    }  
                        if(value=='No Action Required'){

                            $('#PageSaveButton').attr('disabled','true');
                            $('#PageSubmitButton').attr('disabled','true');
                            $('#PageCancelButton').attr('disabled','true');
                            updateCRStatus();
                            $('#crForm').submit();
                            
                            
                        }
                    }
                    
                
                
            }
            
            function isDatesValid(){
                var isDateValid=true;
                var isAdhocValid=true,adhocTasks=resAdhoc_pageAdhoc_getAllAdhoctasks()
                errMsg='';
                if($('#{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Resolution_Code__c').val()=='Document Change Order'){
                    //alert('Is Due Date Validation Needed  {!$Setup.QC_settings__c.Is_Due_Date_Validation_Needed__c} ');
                    if({!$Setup.QC_settings__c.Is_Due_Date_Validation_Needed__c}){
                        var seqDueDateMap={},seqs=[],invDueDate;
                        if(adhocTasks){
                            $.each(adhocTasks,function(index,adhocTask){
                                adhocTask=adhocTask.split('@');
                                seq=adhocTask[0];
                                dueDate=seqDueDateMap[seq];
                                newDueDate=new Date(adhocTask[3]);
                                console.log('adhoc seq  '+seq+' dueDate  '+dueDate+' newDueDate  '+newDueDate);
                                if(dueDate){
                                    dueDate=new Date(dueDate);
                                    if(dueDate.getTime()<newDueDate.getTime()){
                                        seqDueDateMap[seq]=newDueDate;
                                    }
                                }
                                else{
                                    seqDueDateMap[seq]=newDueDate;
                                    seqs.push(seq);
                                }
                            });
                        } 
                        if($("#DocumentChange").is(':checked')){
                            
                            seq=$("#docInv{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Sequence__c").val();
                            invDueDate=new Date($("#inv{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Due_Date__c_GRDATE").val());
                            seqDueDateMap[seq]=invDueDate;
                            seqs.push(seq);
                        }
                        seqs.sort(sortSeq);
                        var hsd,lsd
                        for(var i=0;i<seqs.length-1;i++){
                            for(var j=i+1;j<seqs.length;j++){
                                hsd=seqDueDateMap[seqs[j]];
                                lsd=seqDueDateMap[seqs[i]];
                                if(hsd.getTime()<lsd.getTime()){
                                    isDateValid=false;
                                    showDialog('1','The task Due Date cannot be less than the Due Date of lower sequence task.')
                                    return false;
                                }
                            }
                        }
                        if(isDateValid){      
                            var closureDueDate=new Date($("#docClo{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Due_Date__c_GRDATE").val());
                            //alert('closureDueDate    '+closureDueDate);
                            if($("#closApprTab_chk").is(':checked')){
                                $('#closApprTab_table > tbody  > tr').each(function() {
                                    tds=$(this).find('td');
                                    dueDt=$("#"+tds.eq(3).find('div').find('input[type="text"]').attr('id')).val(); 
                                    console.log('dueDt   '+dueDt);
                                    if(new Date(dueDt).getTime()>closureDueDate.getTime()){
                                        isDateValid=false;
                                        showDialog('1','The Closure Task Due Date cannot be less than the Approval(s) Due Date.');
                                        return false; 
                                    }
                                    else if(seqs.length > 0 && seqDueDateMap[seqs[seqs.length-1]].getTime() > new Date(dueDt).getTime()){
                                        isDateValid=false;
                                        showDialog('1','The Closure Task Approval Due date should be not be less than the Task Due Date');
                                        return false; 
                                    }
                                    
                                });
                                if(isDateValid){  
                                    if(!isApprovalDueDatesValid()){
                                        showDialog('1','The Closure Task Approval Due Date cannot be less than  the lower sequence Approval(s) Due Date.');
                                        return false;
                                    }
                                }
                            }
                            else {
                                $.each(seqs,function(index,sq){
                                    if(closureDueDate.getTime()<seqDueDateMap[sq].getTime()){
                                        isDateValid=false;
                                        showDialog('1','The Closure Task Due Date cannot be less than the task(s) Due Date.');
                                        return false;
                                    }
                                });
                            }
                        }
                        
                    }
                    
                    isAdhocValid=isValid;
                }
                return isDateValid && isAdhocValid;
            }
            
            function disableApprovers(){
                if(!$("#closApprTab_chk").is(':checked')){
                    console.log('disabling the approvers');
                    $("#closApprTab_table").find("input,select").each(function(){
                        console.log('disable the controls  ');
                        $(this).attr('disabled', true);
                    });
                }  
            }
            
            
                                        function saveCr(){
                                             var fieldValue=$("#{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Resolution_Code__c").val();
                                            
                                            
                                            var apprDate= $('#{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}chApprDue_Date__c_hidden').val();
                                            var dcDate= $('#{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}invDue_Date__c_hidden').val();
                                            var clsrDate=$('#{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}docCloDue_Date__c_hidden').val();
                                            var adhocDate=$('#{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}adhocDue_Date__ctsk_0_hidden').val();
                                            

                                            if(apprDate){
                                                apprDate=new Date(apprDate).setHours(0,0,0,0);
                                            }
                                            if(dcDate){
                                                dcDate=new Date(dcDate).setHours(0,0,0,0);
                                            }
                                            if(clsrDate){
                                                clsrDate=new Date(clsrDate).setHours(0,0,0,0);
                                            }
                                             if(adhocDate){
                                                adhocDate=new Date(adhocDate).setHours(0,0,0,0);
                                            }
                                            if((apprDate>dcDate) && fieldValue=='Document Change Order'){
                                                showDialog('1','Approval date is not more than document change task date');
                                                return false;  
                                                
                                                }
                                            if((apprDate>clsrDate) && fieldValue=='Document Change Order'){
                                                showDialog('1','Approval date is not more than closure due date');
                                                return false;  
                                                
                                                }
                                            if((apprDate>adhocDate) && fieldValue=='Document Change Order'){
                                                showDialog('1','Approval date is not more than Adhoctask date');
                                                return false;  
                                                
                                                }
                                            
                                            
                                            if(($("#chApprTab_CK").is(':checked') &&  '{!changemanagement.ApprovalStatus__c}'!='Approved' ) || ('{!changemanagement.Approval_Required__c}'=='Yes' && '{!changemanagement.ApprovalStatus__c}'!='Approved') ){
                                                if(isApprValid()){
                                                    saveCRApprovalData('{!JSENCODE(changemanagement.Id)}',false);
                                                }
                                            }
                                            else{
                                                validate({'save':true});
                                            }
                                            if(!$("#chApprTab_CK").is(':checked')){
                                               
                                                 validate({'save':true});
                                               
                                               }
                                            
                                            
                                        }
                            
           
            
            function onValidCRResolution(validateParams){

  
                               
                
                if('{!changemanagement.ApprovalStatus__c}' != 'Approved' && $("#chApprTab_CK").is(':checked')){
                    
                 if($("#chApprTab_CK").is(':checked') && ('{!changemanagement.ApprovalStatus__c}' != 'Approved' || '{!changemanagement.ApprovalStatus__c}' != 'rejected' || '{!changemanagement.ApprovalStatus__c}' != 'Recall')){
                    

                     
                       if(validateParams.save){
                           
                            if(isApprValid()){
                              saveCRApprovalData('{!JSENCODE(changemanagement.Id)}',false);
                                
                                }
                           
                           }
                     if(validateParams.submit){ 

                            var isDigSigNd='<apex:outputText value="{!$Setup.QC_settings__c.Is_Digital_Signature_Needed__c}"/>'
                            if(isDigSigNd=='true'){
                                $('#uname').val('');$('#pw').val('');$('#signature').modal('show');
                            }
                            else{
                                navigateAfterDigitalSignature();
                            }
                        } 
                     
                    
                    }
                  }
                    
               else{

                   var value=$("#{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Resolution_Code__c").val();
                   
                     if(validateParams.save){
                         
                           if(value=='Document Change Order'){
                               
                                if(isTasksValid() && isDatesValid()){
                                    
                                       
                                $('#PageSaveButton').attr('disabled','true');
                                $('#PageSubmitButton').attr('disabled','true');
                                $('#PageCancelButton').attr('disabled','true');
                                $('#crForm').submit();
                                createDOCTasks();
                                    
                                    }
                               
                               
                               }
                            if(value=='No Action Required'){
                                

                                
                                $('#PageSaveButton').attr('disabled','true');
                                $('#PageSubmitButton').attr('disabled','true');
                                $('#PageCancelButton').attr('disabled','true');
                                $('#crForm').submit(); 
                                
                                }
                         
                         
                         
                         }
                   
                   if(validateParams.submit){ 

                        var isDigSigNd='<apex:outputText value="{!$Setup.QC_settings__c.Is_Digital_Signature_Needed__c}"/>'
                        if(isDigSigNd=='true'){
                            $('#uname').val('');$('#pw').val('');$('#signature').modal('show');
                        }
                        else{
                            navigateAfterDigitalSignature();
                        }
                    } 
                   
                   
                   
                   }
                
            }
            
            
            function isApprValid(){
            
            
             var apprvalid=true;
             
             
              if($("#chApprTab_CK").is(':checked')){
                        
                         var tempValid=isApprovalValid();
                         apprvalid=apprvalid?tempValid:apprvalid;
                        
                        }
            
            return apprvalid;
            
            }
            
            function isTasksValid(){
                var isTaskValid=true;
                
                
                if($('#Resolution_Code__c').val()=='Document Change Order'){
                    
                    if($("#DocumentChange").is(':checked')){

                        var tempValid=isDocumentChangeValid();
                        isTaskValid=isTaskValid?tempValid:isTaskValid;
                    } 
                     
                    
                    
                                       
                    if($("#closApprTab_chk").is(':checked')){

                        var tempValid=isApprovalsValid();
                        isTaskValid=isTaskValid?tempValid:isTaskValid;
                    }
                    if(!$("#docClo{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Due_Date__c_GRDATE").val()){
                        isTaskValid=false;
                        $('#cloDueDate_error').html("<p><font color='red'>This field is required</font></p>");
                    }
                    if(!$("#cloUser").val()){
                        isTaskValid=false;
                        $('#cloUser_error').html("<p><font color='red'>This field is required</font></p>");
                    }
             // v1.0.1 start
                var allowDays=$("#docClo{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Allowed_Days__c").val();
              if(!allowDays){
                 isTaskValid=false;
                 $('#docClo{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Allowed_Days__c_error').html("<p><font color='red'>This field is required</font></p>");
              }
              if(allowDays<0){
                  isTaskValid=false;
                 $('#docClo{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Allowed_Days__c_error').html("<p><font color='red'>Invalid value for this field</font></p>");
              }
              if(allowDays>9999999){ 
                 isTaskValid=false;
                 $('#docClo{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Allowed_Days__c_error').html("<p><font color='red'>Invalid value for this field</font></p>");
              }
           // v1.0.1 end 
                    
                }
                
                  
                console.log('isTaskValid'+isTaskValid);
                return isTaskValid;
            }
            
            
            
            function createDOCTasks(isSubmit){
                var tasks={},invDueDate,cloDueDate;
                var adhocTasks = [];
                adhocTasks = resAdhoc_pageAdhoc_getAllAdhoctasks();
                if($("#DocumentChange").is(':checked')){
                    invDueDate=new Date($("#inv{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Due_Date__c_GRDATE").val());
                    tasks['DocumentChange']=[10,$("#docInvUser").val(),$("#inv{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Allowed_Days__c").val(),(invDueDate.getMonth()+1)+"/"+invDueDate.getDate()+"/"+invDueDate.getFullYear()];
                }
                
                var closureDueDate=new Date($("#docClo{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Due_Date__c_GRDATE").val());
                console.log(' closureDueDate    '+closureDueDate);
                var appDueDate=new Date($("#app{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Due_Date__c_GRDATE").val());
                tasks['Closure']=[200,$("#cloUser").val(),$("#docClo{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Allowed_Days__c").val(),(closureDueDate.getMonth()+1)+"/"+closureDueDate.getDate()+"/"+closureDueDate.getFullYear()];
                console.log('CAPA tasks');
                console.log(tasks);
                Visualforce.remoting.Manager.invokeAction(
                    // @RemoteAction
                    '{!$RemoteAction.ChangeManagementControllerExt.createDOCTasks}',adhocTasks,
                    
                    tasks,'{!Change_Management__c.Id}',(isSubmit)?true:false,$("#closApprTab_chk").is(':checked'),false,
                    
                    // Callback
                    function(result, event){

                       if($("#closApprTab_chk").is(':checked')){
                            saveApprovalData(result['Closure'])
                        }
                        else{
                             $('#crForm').submit();
                        }
                        
                    },
                    // Don't know, couldn't find docs
                    {escape: true}
                );
                
            }
            
            </script>
             
        </apex:outputPanel>
        <!-- java script end--->
        
        
        



<c:wiz_alert alertId="WizAlert"/>
<!-- validator ,digital signature and alert components -->
    <apex:outputPanel rendered="{!OR($CurrentPage.parameters.pg=='cr_init',ISBLANK($CurrentPage.parameters.pg))}">
    <c:digital_signature onSuccess="navigateAfterDigitalSignature()" />
    <c:wiz_validator onValid="if({!OR($CurrentPage.parameters.pg=='cr_init',ISBLANK($CurrentPage.parameters.pg))})onValidInit();"
        ignorehidden="" />
    </apex:outputPanel>
    <c:digital_signature rendered="{!$CurrentPage.parameters.pg=='doc_info'}" onSuccess="$('.dont-allow-multiple-clicks').attr('disabled', 'true');saveDocInfo();$('.dont-allow-multiple-clicks').attr('disabled', 'false');" />
    <c:wiz_validator rendered="{!$CurrentPage.parameters.pg=='doc_info'}" onvalid=""/>


<apex:outputPanel rendered="{!$CurrentPage.parameters.pg=='cr_resolution'}">
<!-- Begin : Alert,Digital Signature and Validator Components -->
<c:wiz_alert alertId="invalidDateAlert"/>
<c:wiz_validator onValid="if({!JSENCODE($CurrentPage.parameters.pg)=='cr_resolution'}){onValidCRResolution(validateParams);}" ignorehidden="false" />
<c:digital_signature onSuccess="navigateAfterDigitalSignature()" />
<!-- End : Alert,Digital Signature and Validator Components -->

<!---contextual Help in progess starts-->
<apex:define name="rightpane">
    <!-- Right container -->
<div id="rightContainer" class="tab-content">
     <!-- Help Pane -->

   </div>
</apex:define>

        <apex:define name="approvalHistory">
                    <c:wiz_approvalHistory rendered="{!OR($CurrentPage.parameters.pg='cr_init')}" Parent="Change Management" TargetobjectId="{!$CurrentPage.parameters.id}"></c:wiz_approvalHistory>  
        </apex:define>
<!--contextual help in progress ends--> 
            
        </apex:outputPanel> 
    </div>
    
    <!--------- v1.4 detail print start --->
    <apex:outputPanel rendered="{!$CurrentPage.parameters.pg=='cr_details_print'}">
        <html>
        <head>
            <meta charset="utf-8" />
            <meta http-equiv="X-UA-Compatible" content="IE=edge" />
            <meta name="description" content="" />
            <meta name="viewport" content="width=device-width, initial-scale=1" />
            <apex:stylesheet value="{!URLFOR($Resource.bt_static,  '/static/stylesheets/app.css')}" />
            <apex:stylesheet value="{!URLFOR($Resource.bt_static,  '/static/stylesheets/bootstrap-datepicker.min.css')}" />
            <title>Change Management Report</title>
            
        </head>
        <body style="background-color: #FFF;">
            <apex:stylesheet value="{!URLFOR($Resource.bt_static,  '/static/stylesheets/app.css')}" />
            <script>
            window.onload =function() { window.print(); };
            </script>
            <div class="" id="app_warpper">
                <div class="report-holder">
                    <div class="wiz-form-holder" style="padding: 20px;">
                        <div class="row">
                            <div class="col-md-12">
                                <img src ="{! URLFOR($Resource.bt_static,'/static/images/report-logo.png') }" class="report-logo"/>
                            </div>
                            
                            
                            
                            <div class="col-md-12">
                                <h1>Change Management Header</h1>
                                <table class="table table-responsive table-bordered">
                                    <tbody>
                                        <tr>
                                            <th>{!JSENCODE($ObjectType.Change_Management__c.Fields.Name.Label)}</th>
                                            <th>{!JSENCODE($ObjectType.Change_Management__c.Fields.Status__c.Label)}</th>
                                            <th> CAPA Owner:</th>
                                            <th>{!JSENCODE($ObjectType.Change_Management__c.Fields.Age__c.Label)}</th>
                                            <th>CR Type:</th>
                                            <th>{!JSENCODE($ObjectType.Change_Management__c.Fields.Source__c.Label)}</th>
                                        </tr>
                                        
                                        <tr>
                                            <td>{!JSENCODE(changemanagement.Name)}</td>
                                            <td>{!JSENCODE(changemanagement.Status__c)}</td>
                                            <td>{!JSENCODE(changemanagement.Owner.Name)}</td>
                                            <td>{! IF(ISBLANK(JSENCODE(changemanagement.Id)), 0, changemanagement.Age__c) } Day{!IF(changemanagement.Age__c!=1,'s','') }</td>
                                            <td> {!JSENCODE(changemanagement.Change_Request_Type__c)} </td>
                                            <td>
                                                {!JSENCODE(changemanagement.Source__c)}
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>  
                        </div>
                        
                        <h1><apex:outputText value="CR Initiation"/></h1>  <!-- make value dynamic here -->
                        
                        <table class="table table-responsive table-bordered">
                            <apex:repeat value="{!$ObjectType.Change_Management__c.FieldSets.Initiation_Fields}"
                                         var="f">
                                <tr>
                                    <td class="title-col">
                                        {!if($ObjectType.Change_Management__c.Fields[f].Label=='Owner ID','Owner',$ObjectType.Change_Management__c.Fields[f].Label)}
                                    </td>
                                    <td>
                                                                               
                                        <apex:outputPanel rendered="{!f!='Document_Number__c'}">
                                            <apex:outputField rendered="{!AND($ObjectType.Change_Management__c.Fields[f].type!='reference',$ObjectType.Change_Management__c.Fields[f].type!='textarea')}" value="{!changemanagement[f]}"/>
                                            <apex:outputPanel rendered="{!$ObjectType.Change_Management__c.Fields[f].type=='reference'}">
                                                {!JSENCODE(changemanagement[$ObjectType.Change_Management__c.Fields[f].relationshipName].Name)}
                                            </apex:outputPanel>
                                            <apex:outputPanel rendered="{!$ObjectType.Change_Management__c.Fields[f].type=='textarea'}">
                                                <div class="alert alert-info">
                                                    <apex:outputField value="{!changemanagement[f]}"></apex:outputField>
                                                </div>
                                            </apex:outputPanel>
                                        </apex:outputPanel>
                                        
                                        <apex:outputPanel rendered="{!f=='Document_Number__c'}">
                                            <apex:outputText value="{!if(changemanagement.Change_Type__c=='New',changemanagement.Document_Number__c,changemanagement.Document_Profile__r.Name)}"/>
                                        </apex:outputPanel>
                                    </td>
                                </tr>
                            </apex:repeat>                    
                        </table>
                        <h1><apex:outputText value="Additional Information" /></h1>  <!-- make value dynamic here -->
                        
                        <table class="table table-responsive table-bordered">
                            <apex:repeat value="{!$ObjectType.Change_Management__c.FieldSets.Additional_Fields}"
                                         var="f">
                                <tr>
                                    <td class="title-col">
                                        {!if($ObjectType.Change_Management__c.Fields[f].Label=='Owner ID','Owner',$ObjectType.Change_Management__c.Fields[f].Label)}
                                    </td>
                                    <td>
                                        <!--<apex:outputField value="{!changemanagement[f]}"/> -->
                                        <apex:outputPanel rendered="{!f!=IF(NOT(ISBLANK(Prefix)),Prefix+'__Impacted_Sites__c','Impacted_Sites__c')}">
                                                                <apex:outputPanel rendered="{!$ObjectType.Change_Management__c.Fields[f].type=='textarea'}">
                                                                <div class="alert alert-info"> <apex:outputField value="{!changemanagement[f]}" /> </div>
                                                                </apex:outputPanel>
                                                                <apex:outputPanel rendered="{!$ObjectType.Change_Management__c.Fields[f].type=='date'}">
                                                                    <apex:outputText value="{0,date, dd MMMM yyyy}"> 
                                                                        <apex:param value="{!changemanagement[f]}"/>
                                                                    </apex:outputText>
                                                                </apex:outputPanel>
                                                                <apex:outputPanel rendered="{!NOT(OR($ObjectType.Change_Management__c.Fields[f].type=='date',$ObjectType.Change_Management__c.Fields[f].type=='reference',$ObjectType.Change_Management__c.Fields[f].type=='textarea'))}">
                                                                    {!JSENCODE(changemanagement[f])}
                                                                </apex:outputPanel>
                                                                <apex:outputPanel rendered="{!$ObjectType.Change_Management__c.Fields[f].type=='reference'}">
                                                                    {!JSENCODE(changemanagement[$ObjectType.Change_Management__c.Fields[f].relationshipName].Name)}
                                                                </apex:outputPanel>
                                                            </apex:outputPanel>
                                                            <apex:outputPanel rendered="{!f==IF(NOT(ISBLANK(Prefix)),Prefix+'__Impacted_Sites__c','Impacted_Sites__c')}">
                                                                <div class="col-md-12">
                                                                    <c:wiz_multi width="100%"
                                                                                 required="{!f.required}"
                                                                                 FieldId="{!f}"
                                                                                 multiple="true"
                                                                                 FieldName="{!f}"
                                                                                 queryFields="Name"
                                                                                 querytable="{!IF(NOT(ISBLANK(Prefix)),Prefix+'__','')}Manufacturing_Site__c"
                                                                                 dataid=""                                      
                                                                                 disabled="true">
                                                                        <apex:repeat value="{!ImpactedSites}" var="impatedsite">
                                                                            <option selected="selected" value="{!JSENCODE(impatedsite.id)}">{!JSENCODE(impatedsite.Name)}</option>
                                                                        </apex:repeat>
                                                                    </c:wiz_multi>                             
                                                                </div>
                                                                
                                                                
                                                            </apex:outputPanel>
                                    </td>
                                </tr>
                            </apex:repeat>                    
                        </table>
                        
                        <!-----------------custom fileds---------------------------------->
                        <apex:outputPanel rendered="{!$ObjectType.Change_Management__c.FieldSets.ChangeManagement_Custom_Fields.size!=0}">
                            <h1><apex:outputText value="Custom Fields" /></h1>
                            <table class="table table-responsive table-bordered">
                                <tbody>
                                    <apex:repeat value="{!$ObjectType.Change_Management__c.FieldSets.ChangeManagement_Custom_Fields}" var="f">
                                        <apex:outputPanel rendered="{!$ObjectType.Change_Management__c.Fields[f].Accessible}">
                                            <tr>
                                                <td class="title-col">
                                                    {!$ObjectType.Change_Management__c.Fields[f].label}
                                                </td>
                                                <td>
                                                    <apex:outputPanel rendered="{!$ObjectType.Change_Management__c.Fields[f].type=='textarea'}">
                                                        <div class="alert alert-info"> <apex:outputField value="{!changemanagement[f]}" /> </div>
                                                    </apex:outputPanel>
                                                    <apex:outputPanel rendered="{!$ObjectType.Change_Management__c.Fields[f].type=='date'}">
                                                        <apex:outputText value="{0,date, dd MMMM yyyy}"> 
                                                            <apex:param value="{!changemanagement[f]}"/>
                                                        </apex:outputText>
                                                    </apex:outputPanel>
                                                    <apex:outputPanel rendered="{!NOT(OR($ObjectType.Change_Management__c.Fields[f].type=='date',$ObjectType.Change_Management__c.Fields[f].type=='reference',$ObjectType.Change_Management__c.Fields[f].type=='textarea'))}">
                                                        {!JSENCODE(changemanagement[f])}
                                                    </apex:outputPanel>
                                                    <apex:outputPanel rendered="{!$ObjectType.Change_Management__c.Fields[f].type=='reference'}">
                                                        {!JSENCODE(changemanagement[$ObjectType.Change_Management__c.Fields[f].relationshipName].Name)}
                                                    </apex:outputPanel>
                                                </td>
                                            </tr>                                
                                        </apex:outputPanel>  
                                    </apex:repeat>
                                </tbody>
                            </table>
                        </apex:outputPanel> 
                        
                        <!------------------------------------------------------>
                        <apex:outputPanel rendered="{!changemanagement.Approval_Required__c=='Yes'}">
                            <h2>Approvers</h2>
                            <table class="table table-responsive table-bordered">
                                <tbody>
                                    <tr>
                                        <th>Approver</th>
                                        <th>Sequence</th>
                                        <th>Allowed Days</th>
                                        <th>Due Date</th>
                                        <th>Status</th>
                                        <th>Approved Date</th>
                                    </tr>
                                    <apex:repeat value="{!changemanagementApprovers}" var="Ap">
                                        <tr>
                                            <td>{!Ap.User__r.Name}</td>
                                            <td>{!Ap.Sequence_Position__c}</td>
                                            <td>{!Ap.Allowed_Days__c}</td>
                                            <td>
                                                <apex:outputText value="{0,date,dd MMM yyyy}">
                                                    <apex:param value="{!Ap.Due_Date__c}" /> 
                                                </apex:outputText>                                  
                                            </td>
                                            <td><apex:outputText value="{!Ap.Status__c}" rendered="{!changemanagement.Status__c!='Open'}"></apex:outputText> </td>
                                            <td>
                                                <apex:outputText rendered="{!changemanagement.Status__c!='Open'}" value="{0,date,dd MMM yyyy}">
                                                    <apex:param value="{!Ap.Status_Updated__c}" /> 
                                                </apex:outputText>                                      
                                            </td>
                                        </tr>                                
                                    </apex:repeat>
                                    
                                </tbody>
                            </table>
                        </apex:outputPanel>
                        <!-------------------------------------------------------->
                        
                        <h1><apex:outputText value="Document Info"/></h1>  
                        <apex:repeat value="{!Change_Management__c.Sub_Change_Management__r}" var="doc">
                            <table class="table table-responsive table-bordered">
                                
                                <apex:outputPanel rendered="{!$ObjectType.Sub_Change_Management__c.Fields.Type__c.Accessible}"> 
                                    <tr>
                                        <td class="title-col">
                                            <apex:outputText value="{!JSENCODE(IF(contains(customLabelKeys,'Type__c'),customLabels['Type__c'].Field_Label__c, $ObjectType.Sub_Change_Management__c.Fields.Type__c.Label))}"/>
                                            
                                        </td>
                                        <td>
                                            {!JSENCODE(doc.Type__c)}
                                        </td>
                                    </tr>
                                    
                                </apex:outputPanel> 
                                
                                <apex:outputPanel rendered="{!doc.Type__c=='New'}">
                                    <apex:outputPanel rendered="{!$ObjectType.Sub_Change_Management__c.Fields.Document_Name__c.Accessible}"> 
                                        <tr>
                                            <td class="title-col">
                                                <apex:outputText value="{!JSENCODE(IF(contains(customLabelKeys,'Document_Name__c'),customLabels['Document_Name__c'].Field_Label__c, $ObjectType.Sub_Change_Management__c.Fields.Document_Name__c.Label))}"/>
                                                
                                            </td>
                                            <td>
                                                {!JSENCODE(doc.Document_Name__c)}
                                            </td>
                                        </tr>
                                        
                                    </apex:outputPanel>
                                </apex:outputPanel>
                                <apex:outputPanel rendered="{!doc.Type__c!='New'}">
                                    <apex:outputPanel rendered="{!$ObjectType.Sub_Change_Management__c.Fields.Document_Profile_Name__c.Accessible}"> 
                                        <tr>
                                            <td class="title-col">
                                                <apex:outputText value="{!JSENCODE(IF(contains(customLabelKeys,'Document_Profile_Name__c'),customLabels['Document_Profile_Name__c'].Field_Label__c, $ObjectType.Sub_Change_Management__c.Fields.Document_Profile_Name__c.Label))}"/>
                                                
                                            </td>
                                            <td>
                                                {!JSENCODE(doc.Document_Profile_Name__c)}
                                            </td>
                                        </tr>
                                        
                                    </apex:outputPanel>
                                </apex:outputPanel>
                                
                                <apex:outputPanel rendered="{!$ObjectType.Sub_Change_Management__c.Fields.Current_Rev__c.Accessible}"> 
                                    <tr>
                                        <td class="title-col">
                                            <apex:outputText value="{!JSENCODE(IF(contains(customLabelKeys,'Current_Rev__c'),customLabels['Current_Rev__c'].Field_Label__c, $ObjectType.Sub_Change_Management__c.Fields.Current_Rev__c.Label))}"/>
                                            
                                        </td>
                                        <td>
                                            {!JSENCODE(doc.Current_Rev__c)}
                                        </td>
                                    </tr>
                                    
                                </apex:outputPanel> 
                                
                                <apex:outputPanel rendered="{!$ObjectType.Sub_Change_Management__c.Fields.New_Rev__c.Accessible}"> 
                                    <tr>
                                        <td class="title-col">
                                            <apex:outputText value="{!JSENCODE(IF(contains(customLabelKeys,'New_Rev__c'),customLabels['New_Rev__c'].Field_Label__c, $ObjectType.Sub_Change_Management__c.Fields.New_Rev__c.Label))}"/>
                                            
                                        </td>
                                        <td>
                                            {!JSENCODE(doc.New_Rev__c)}
                                        </td>
                                    </tr>
                                    
                                </apex:outputPanel> 
                                
                                <apex:outputPanel rendered="{!$ObjectType.Sub_Change_Management__c.Fields.Status__c.Accessible}"> 
                                    <tr>
                                        <td class="title-col">
                                            <apex:outputText value="{!JSENCODE(IF(contains(customLabelKeys,'Status__c'),customLabels['Status__c'].Field_Label__c, $ObjectType.Sub_Change_Management__c.Fields.Status__c.Label))}"/>
                                            
                                        </td>
                                        <td>
                                            {!JSENCODE(doc.Status__c)}
                                        </td>
                                    </tr>
                                    
                                </apex:outputPanel> 
                                
                                <apex:outputPanel rendered="{!$ObjectType.Sub_Change_Management__c.Fields.Relation__c.Accessible}"> 
                                    <tr>
                                        <td class="title-col">
                                            <apex:outputText value="{!JSENCODE(IF(contains(customLabelKeys,'Relation__c'),customLabels['Relation__c'].Field_Label__c, $ObjectType.Sub_Change_Management__c.Fields.Relation__c.Label))}"/>
                                            
                                        </td>
                                        <td>
                                            {!JSENCODE(doc.Relation__c)}
                                        </td>
                                    </tr>
                                    
                                </apex:outputPanel> 
                                
                                <apex:outputPanel rendered="{!$ObjectType.Sub_Change_Management__c.Fields.Owner__c.Accessible}"> 
                                    <tr>
                                        <td class="title-col">
                                            <apex:outputText value="{!JSENCODE(IF(contains(customLabelKeys,'Owner__c'),customLabels['Owner__c'].Field_Label__c, $ObjectType.Sub_Change_Management__c.Fields.Owner__c.Label))}"/>
                                            
                                        </td>
                                        <td>
                                            {!JSENCODE(doc.Owner__c)}
                                        </td>
                                    </tr>
                                    
                                </apex:outputPanel> 
                                
                                <apex:outputPanel rendered="{!$ObjectType.Sub_Change_Management__c.Fields.Document_Specific_Changes__c.Accessible}"> 
                                    <tr>
                                        <td class="title-col">
                                            <apex:outputText value="{!JSENCODE(IF(contains(customLabelKeys,'Document_Specific_Changes__c'),customLabels['Document_Specific_Changes__c'].Field_Label__c, $ObjectType.Sub_Change_Management__c.Fields.Document_Specific_Changes__c.Label))}"/>
                                            
                                        </td>
                                        <td>
                                            {!JSENCODE(doc.Document_Specific_Changes__c)}
                                        </td>
                                    </tr>
                                    
                                </apex:outputPanel>                                 
                            </table>
                        </apex:repeat>
                        
                        <div class="print-only">
                            <div class="panel panel-default">
                                <div class="panel-heading" role="tab" id="headingCAPAResolutionCode">
                                    <h1 class="panel-title">
                                        Resolution ({!JSENCODE(changemanagement.Resolution_Code__c)})
                                    </h1>
                                </div>
                                
                                <div class="panel-collapse collapse in print-only">
                                    <div class="panel-body print-only">
                                        
                                        <apex:outputPanel rendered="{!if(OR(changemanagement.Resolution_Code__c == 'No Action Required'),true,false)}">
                                            <apex:outputPanel rendered="{!$ObjectType.Change_Management__c.Fields.Resolution_Closed_Comment__c.Accessible}">
                                                <table class="table table-responsive table-bordered">
                                                    <tbody>
                                                        <tr>
                                                            <td class="title-col">
                                                                <apex:outputText value="{!JSENCODE(IF(contains(customLabelKeys,'Resolution_Closed_Comment__c'),customLabels['Resolution_Closed_Comment__c'].Field_Label__c, $ObjectType.Change_Management__c.Fields.Resolution_Closed_Comment__c.Label))}"/>
                                                            </td>
                                                            <td>
                                                                <div class="alert alert-info">   <apex:outputfield value="{!changemanagement.Resolution_Closed_Comment__c}"></apex:outputfield></div>
                                                            </td>
                                                            
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </apex:outputPanel>
                                        </apex:outputPanel>
                                        
                                        <apex:outputPanel rendered="{!if(changemanagement.Resolution_Code__c=='Document Change Order',true,false)}">
                                            <table class="table table-responsive table-bordered">
                                                <tbody>
                                                    <tr>
                                                        <th>Task Name</th>
                                                        <th>Sequence</th>
                                                        <th>Owner</th>
                                                        <th>Allowed Days</th>
                                                        <th>Due Date</th>
                                                    </tr>
                                                    
                                                    <apex:repeat value="{!allCRGnrlTasks}"  var="General_Task">                                              
                                                        <tr>
                                                            <td>{!if(General_Task.RecordType.Name=='AdhocTask',General_Task.AdhocTask_Title__c,General_Task.RecordType.Name)}</td>
                                                            <td>{!if(General_Task.RecordType.Name=='Closure','',General_Task.Sequence_Position__c)}</td>
                                                            <td>{!JSENCODE(General_Task.Owner.Name)}</td>
                                                            <td>{!General_Task.Allowed_Days__c}</td>
                                                            <td>  
                                                                <apex:outputText value="{0,date,dd MMM yyyy}">
                                                                    <apex:param value="{!General_Task.Due_Date__c}" /> 
                                                                </apex:outputText>
                                                            </td>
                                                        </tr>
                                                    </apex:repeat>
                                                    
                                                </tbody>
                                            </table> 
                                        </apex:outputPanel>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <apex:outputPanel rendered="{!if(AND($ObjectType.Change_Management__c.Fields.Resolution_Code__c.Accessible,ChangeManagement.Resolution_Code__c=='Document Change Order'),true,false)}">
                            <c:wiz_task_details DocumentChangeTask="{!dcTask}" closureTask="{!closTask}" module="ChangeManagement" adhocTasks="{!adhocTasks}"></c:wiz_task_details>
                        </apex:outputPanel>
                    </div>
                </div>
            </div>
        </body>
    </html>
    </apex:outputPanel>
    <!--------- v1.4 detail print end--->
</apex:page>